Return-Path: <alsa-devel-bounces@alsa-project.org>
X-Original-To: lists+alsa-devel@lfdr.de
Delivered-To: lists+alsa-devel@lfdr.de
Received: from alsa0.perex.cz (alsa0.perex.cz [77.48.224.243])
	by mail.lfdr.de (Postfix) with ESMTPS id B861A284B7E
	for <lists+alsa-devel@lfdr.de>; Tue,  6 Oct 2020 14:15:29 +0200 (CEST)
Received: from alsa1.perex.cz (alsa1.perex.cz [207.180.221.201])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by alsa0.perex.cz (Postfix) with ESMTPS id 120451760;
	Tue,  6 Oct 2020 14:14:39 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa0.perex.cz 120451760
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=alsa-project.org;
	s=default; t=1601986529;
	bh=g+EpKnXsfOfCioUksWmQsDovMHafDSAuh/xxhLyv0VA=;
	h=Date:From:To:Subject:In-Reply-To:References:Cc:List-Id:
	 List-Unsubscribe:List-Archive:List-Post:List-Help:List-Subscribe:
	 From;
	b=sOaAY3npB5WzerZeTxfIZquaWxTA1B1hpeBFhfSc24zThjrxdDR0TckwLi5QHqRbe
	 z+MJvTrinGB+8HxHdvoZr3vPgHEMLMzwREdPas+vnQFyagS1Cv3dUF86pLfaSQ4MVB
	 oSwblwYXbfMj5rBnICoLPLI71VicMWOe28tOcjnw=
Received: from alsa1.perex.cz (localhost.localdomain [127.0.0.1])
	by alsa1.perex.cz (Postfix) with ESMTP id 9D650F80053;
	Tue,  6 Oct 2020 14:13:48 +0200 (CEST)
X-Original-To: alsa-devel@alsa-project.org
Delivered-To: alsa-devel@alsa-project.org
Received: by alsa1.perex.cz (Postfix, from userid 50401)
 id F2A30F8012A; Tue,  6 Oct 2020 14:13:45 +0200 (CEST)
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on alsa1.perex.cz
X-Spam-Level: 
X-Spam-Status: No, score=0.0 required=5.0 tests=RCVD_IN_MSPIKE_H3,
 RCVD_IN_MSPIKE_WL,SPF_HELO_NONE,SPF_PASS autolearn=disabled version=3.4.0
Received: from mx2.suse.de (mx2.suse.de [195.135.220.15])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by alsa1.perex.cz (Postfix) with ESMTPS id 81397F80053
 for <alsa-devel@alsa-project.org>; Tue,  6 Oct 2020 14:13:41 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa1.perex.cz 81397F80053
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.221.27])
 by mx2.suse.de (Postfix) with ESMTP id AE2FBAA55;
 Tue,  6 Oct 2020 12:13:40 +0000 (UTC)
Date: Tue, 06 Oct 2020 14:13:40 +0200
Message-ID: <s5hpn5v5z7v.wl-tiwai@suse.de>
From: Takashi Iwai <tiwai@suse.de>
To: Kai Vehmanen <kai.vehmanen@linux.intel.com>
Subject: Re: [RFC PATCH 0/2] ALSA: hda - acomp probe fix for i915
In-Reply-To: <20201006113042.471718-1-kai.vehmanen@linux.intel.com>
References: <20201006113042.471718-1-kai.vehmanen@linux.intel.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI/1.14.6 (Maruoka)
 FLIM/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL/10.8 Emacs/25.3
 (x86_64-suse-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Content-Type: text/plain; charset=US-ASCII
Cc: alsa-devel@alsa-project.org
X-BeenThere: alsa-devel@alsa-project.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: "Alsa-devel mailing list for ALSA developers -
 http://www.alsa-project.org" <alsa-devel.alsa-project.org>
List-Unsubscribe: <https://mailman.alsa-project.org/mailman/options/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=unsubscribe>
List-Archive: <http://mailman.alsa-project.org/pipermail/alsa-devel/>
List-Post: <mailto:alsa-devel@alsa-project.org>
List-Help: <mailto:alsa-devel-request@alsa-project.org?subject=help>
List-Subscribe: <https://mailman.alsa-project.org/mailman/listinfo/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=subscribe>
Errors-To: alsa-devel-bounces@alsa-project.org
Sender: "Alsa-devel" <alsa-devel-bounces@alsa-project.org>

On Tue, 06 Oct 2020 13:30:40 +0200,
Kai Vehmanen wrote:
> 
> Hi,
> 
> this simple bugfix started to feel a bit like getting stuck in quicksand,
> so I'm looking for some early input via this RFC series.
> 
> Basicly hdac_i915.c should not use global state to track communication
> with i915 driver. But how to get handle of "hdac_bus*? I considered
> a few options:
> 
>   1) add hdac_bus as a member of drm_audio_component.h
> 	-> seems wrong as this is really an audio side implementation)
> 
>   2) embed copy of drm_audio_component to 'struct hdac_bus', so
>      I could use container_of() on the device handle to get
>      to the bus 
> 	-> wasted space to keep a copy at hdac_bus level
> 	   (note: snd-hda-codec-hdmi do this by embedding a copy
> 	    of ops to "struct hdmi_spec")
> 
>   3) add another devres entry to store the hdac_bus directly
>      in acomp_init and a new helper function to query it
> 
> I now implemented option 3 in this RFC series as it seemed cleanest
> and most local to hdac_component.c, where the problem stems from. It's still
> somewhat messy, and I'm wondering if I'm overlooking some obvious alternative.
> We could dig this deeper into i915 specific code, but OTOH, hdac_bus is
> an argument snd_hdac_acomp_init(), so it's common for all.
> 
> Kai Vehmanen (2):
>   ALSA: hda - keep track of HDA core bus instance in acomp
>   ALSA: hda/i915 - fix list corruption with concurrent probes

Another option would be to move the completion into the common acomp
helper from i915-specific one.  That is,

- Add bind_complete field into struct drm_audio_component,
  initialize it at snd_hdac_acomp_init()

- Call complete_all(&acomp->bind_complete) at the end of
  hdac_component_master_bind()

- Remove / replace i915's own completion with the hdac's one.
  The i915_init_ops can be dropped.


thanks,

Takashi
