Return-Path: <alsa-devel-bounces@alsa-project.org>
X-Original-To: lists+alsa-devel@lfdr.de
Delivered-To: lists+alsa-devel@lfdr.de
Received: from alsa0.perex.cz (alsa0.perex.cz [77.48.224.243])
	by mail.lfdr.de (Postfix) with ESMTPS id 93BB09B31C
	for <lists+alsa-devel@lfdr.de>; Fri, 23 Aug 2019 17:16:09 +0200 (CEST)
Received: from alsa1.perex.cz (alsa1.perex.cz [207.180.221.201])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by alsa0.perex.cz (Postfix) with ESMTPS id 179A51685;
	Fri, 23 Aug 2019 17:15:19 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa0.perex.cz 179A51685
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=alsa-project.org;
	s=default; t=1566573369;
	bh=ZTYVHb4XvMyJfasAuTCYBhTic77mxXO6FctNePXv2LQ=;
	h=Date:From:To:In-Reply-To:References:Cc:Subject:List-Id:
	 List-Unsubscribe:List-Archive:List-Post:List-Help:List-Subscribe:
	 From;
	b=n71/NEjNaOWgYutH7aiysDWZ7V7bLBKI/xzIC0tmZgllx0K9wtQZO2PEsmg3+x2cy
	 ARMso4tTjSk8B+vzdjYaOMZHhsT9StOiQ0WRf9E/tDcC95hCVQCFiU/uiA8lebSDPn
	 2JdZ3v8AEjvJuHI1P6Y+uCHVQq4YQRrib50zCp+c=
Received: from alsa1.perex.cz (localhost.localdomain [127.0.0.1])
	by alsa1.perex.cz (Postfix) with ESMTP id 556A3F80306;
	Fri, 23 Aug 2019 17:14:26 +0200 (CEST)
X-Original-To: alsa-devel@alsa-project.org
Delivered-To: alsa-devel@alsa-project.org
Received: by alsa1.perex.cz (Postfix, from userid 50401)
 id 506CDF80306; Fri, 23 Aug 2019 17:14:22 +0200 (CEST)
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on alsa1.perex.cz
X-Spam-Level: 
X-Spam-Status: No, score=0.3 required=5.0 tests=PRX_BODY_72,PRX_BODY_76,
 SPF_HELO_NONE,SPF_PASS autolearn=disabled version=3.4.0
Received: from mx1.suse.de (mx2.suse.de [195.135.220.15])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by alsa1.perex.cz (Postfix) with ESMTPS id 5B470F80147
 for <alsa-devel@alsa-project.org>; Fri, 23 Aug 2019 17:14:17 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa1.perex.cz 5B470F80147
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 06CB2AC9B;
 Fri, 23 Aug 2019 15:14:16 +0000 (UTC)
Date: Fri, 23 Aug 2019 17:14:16 +0200
Message-ID: <s5h36hrrk1j.wl-tiwai@suse.de>
From: Takashi Iwai <tiwai@suse.de>
To: Kai Vehmanen <kai.vehmanen@linux.intel.com>
In-Reply-To: <s5h5zmoq6cy.wl-tiwai@suse.de>
References: <alpine.DEB.2.21.1908151641110.16459@zeliteleevi>
 <s5hr25ma3xs.wl-tiwai@suse.de>
 <alpine.DEB.2.21.1908231652000.16459@zeliteleevi>
 <s5h5zmoq6cy.wl-tiwai@suse.de>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI/1.14.6 (Maruoka)
 FLIM/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL/10.8 Emacs/25.3
 (x86_64-suse-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Cc: alsa-devel@alsa-project.org
Subject: Re: [alsa-devel] sof/hda rework to share more of patch_hdmi.c logic
X-BeenThere: alsa-devel@alsa-project.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: "Alsa-devel mailing list for ALSA developers -
 http://www.alsa-project.org" <alsa-devel.alsa-project.org>
List-Unsubscribe: <https://mailman.alsa-project.org/mailman/options/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=unsubscribe>
List-Archive: <http://mailman.alsa-project.org/pipermail/alsa-devel/>
List-Post: <mailto:alsa-devel@alsa-project.org>
List-Help: <mailto:alsa-devel-request@alsa-project.org?subject=help>
List-Subscribe: <https://mailman.alsa-project.org/mailman/listinfo/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=subscribe>
Content-Type: text/plain; charset="us-ascii"
Content-Transfer-Encoding: 7bit
Errors-To: alsa-devel-bounces@alsa-project.org
Sender: "Alsa-devel" <alsa-devel-bounces@alsa-project.org>

On Fri, 23 Aug 2019 16:55:09 +0200,
Takashi Iwai wrote:
> 
> On Fri, 23 Aug 2019 16:29:40 +0200,
> Kai Vehmanen wrote:
> > 
> > Hi,
> > 
> > On Thu, 15 Aug 2019, Takashi Iwai wrote:
> > > Kai Vehmanen wrote:
> > >> into modifying the SOF Intel backend to use 
> > >> snd-hda-codec-hdmi/patch_hdmi.c for HDMI/DP audio support, i.e. to be able 
> > >> to share this code between snd-hda-intel and SOF Intel (and not using 
> > >> hdac-hdmi).
> > [..]
> > >> This will change how HDMI is exposed to user-space with SOF Intel 
> > >> drivers, so we need to be extra careful how this is introduced. But 
> > 
> > > Agreed.  I guess the biggest difference is the handling of the 
> > > DP-MST.  The legacy HD-audio HDMI driver takes a different approach
> > > for DP-MST, namely, it chooses dynamically the pin that is connected
> > > with a monitor.  It's for keeping the compatibility (more or less)
> > > with old behavior; the program just needs to open the device that
> > > corresponds to the notification via jack ctl without fiddling with
> > > other extra routing.
> > 
> > indeed. I've now got to a point where I have the key functionality
> > in place. And after some reworks, the changes to patch_hdmi.c 
> > are pretty minimal, which is very nice (I started with a much more 
> > evasive patch).
> > 
> > But, but. The DP-MST handling is indeed iffy. I tried a few approaches, 
> > but it is hard to reconcile concept of "backup PCMs" of patch_hdmi.c with 
> > concepts of ASoC and ALSA topology, where the PCM and DAIs are supposed to 
> > be defined in the topology file. This gets worse with SOF (and any similar 
> > usage) which allow you to have arbitrary DSP processing between a PCM and 
> > the HDMI/DP DAIs. So this seems like a dead-end.
> > 
> > What I ended up doing was to make a new mode to patch_hdmi.c that limits 
> > PCM count to actual converter count (and this is aligned with topology), 
> > and still supporting DP-MST by always mapping monitors to a free PCM. I've 
> > tested some complex DP-MST scenarios and this seems to work pretty well. 
> > The jack detection will still be able to tell which of the PCMs have a 
> > monitor detected.
> > 
> > I wonder if this would be an acceptable approach, given 
> > the reuse benefits we get. Downsides:
> > - assignment of monitors to PCMs will depend on ELD update ordering
> 
> This is true in anyway for the legacy HD-audio, too.
> 
> > - in SOF we need to align PCM numbering scheme in all topologies 
> >   we convert over to patch_hdmi.c
> 
> I don't think this can be a problem.
> 
> Practically seen, the number of PCMs could be just 3 on Skylake and
> co, even with DP MST, because i915 can drive only up to 3 monitors.
> The driver *should* receive the unplug event before the plug event to
> a new monitor, so hda_detach_hda_pcm() gets called before
> hda_attach_hda_pcm().
> 
> The current patch_hdmi.c implementation is based on the theoretical
> possibility, and limitation to the reduced PCM streams would work, I
> suppose.

For more correctness: the patch_hdmi.c implementation actually would
work even without the backup PCM streams.  The backup PCM streams are
there for assuring the compatible behavior for old applications that
access to the fixed PCM device (e.g. hw:1,1).  But, it's hardly
possible to get more than three audio-monitors active in the real
scenario, we've almost never seen this necessity.

The actual behavior can be found in the description of commit
a76056f2e57e:

    When monitor is connected, find a proper PCM for the monitor.
    When monitor is disconnected, unbind the PCM from the pin.
    
    The binding policy (use Intel platform as example) is:
    1. Try to use the legacy pin-pcm mapping for the device entry 0
       of the pin.
    2. If step 1 fails, try to bind pin to the backup PCMs. For example,
       on Intel platform, if DP MST is enabled, 5 PCMs will be created.
       PCM 3, PCM 7, PCM 8 are supposed to be used by device entry 0 of
       pin 5, pin 6 and pin 7. PCM 9 and PCM 10 are the backup PCMs.
    3. If step 2 fails, try to find any PCM to bind to the pin.
    
Removing the backup streams means the removal of step 2, but the
driver will keep working in step 3.


thanks,

Takashi
_______________________________________________
Alsa-devel mailing list
Alsa-devel@alsa-project.org
https://mailman.alsa-project.org/mailman/listinfo/alsa-devel
