Return-Path: <alsa-devel-bounces@alsa-project.org>
X-Original-To: lists+alsa-devel@lfdr.de
Delivered-To: lists+alsa-devel@lfdr.de
Received: from alsa0.perex.cz (alsa0.perex.cz [77.48.224.243])
	by mail.lfdr.de (Postfix) with ESMTPS id 022134E4F9F
	for <lists+alsa-devel@lfdr.de>; Wed, 23 Mar 2022 10:42:55 +0100 (CET)
Received: from alsa1.perex.cz (alsa1.perex.cz [207.180.221.201])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by alsa0.perex.cz (Postfix) with ESMTPS id 91325172C;
	Wed, 23 Mar 2022 10:42:04 +0100 (CET)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa0.perex.cz 91325172C
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=alsa-project.org;
	s=default; t=1648028574;
	bh=V5N791zom/6OqtXuESKiUb9JXmyi3ubBQ3uHzWEH0Ic=;
	h=Date:From:To:Subject:In-Reply-To:References:Cc:List-Id:
	 List-Unsubscribe:List-Archive:List-Post:List-Help:List-Subscribe:
	 From;
	b=f87jyBUC0KpiPGsVD2Zp1Hz9mfs86+BdfP4zmHeoll47thvAIpv2ZeX6C4VAM1T22
	 6/Xm0A6LMax7acNlN+1cv0mdG4VLgtRgKXQZxei2g/Rpf/8GwKWQr1ZAkjLrjBOBJk
	 PPUSp1RtdAAsEumhFmsKEbLHmPTEeRhe+aAaf19o=
Received: from alsa1.perex.cz (localhost.localdomain [127.0.0.1])
	by alsa1.perex.cz (Postfix) with ESMTP id 4F3D0F800C1;
	Wed, 23 Mar 2022 10:41:33 +0100 (CET)
X-Original-To: alsa-devel@alsa-project.org
Delivered-To: alsa-devel@alsa-project.org
Received: by alsa1.perex.cz (Postfix, from userid 50401)
 id 55083F800C1; Wed, 23 Mar 2022 10:41:32 +0100 (CET)
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on alsa1.perex.cz
X-Spam-Level: 
X-Spam-Status: No, score=-0.1 required=5.0 tests=DKIM_SIGNED,DKIM_VALID,
 DKIM_VALID_AU,SPF_HELO_NONE,SPF_NONE,T_SCC_BODY_TEXT_LINE autolearn=disabled
 version=3.4.0
Received: from smtp-out1.suse.de (smtp-out1.suse.de [195.135.220.28])
 (using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
 (No client certificate requested)
 by alsa1.perex.cz (Postfix) with ESMTPS id 2B7B1F800C1
 for <alsa-devel@alsa-project.org>; Wed, 23 Mar 2022 10:41:27 +0100 (CET)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa1.perex.cz 2B7B1F800C1
Authentication-Results: alsa1.perex.cz;
 dkim=pass (1024-bit key) header.d=suse.de header.i=@suse.de
 header.b="l1oxl1Su"; 
 dkim=permerror (0-bit key) header.d=suse.de header.i=@suse.de
 header.b="padKinWv"
Received: from relay2.suse.de (relay2.suse.de [149.44.160.134])
 by smtp-out1.suse.de (Postfix) with ESMTP id 9DC3F210F6;
 Wed, 23 Mar 2022 09:41:27 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=suse.de; s=susede2_rsa;
 t=1648028487; h=from:from:reply-to:date:date:message-id:message-id:to:to:cc:cc:
 mime-version:mime-version:content-type:content-type:
 in-reply-to:in-reply-to:references:references;
 bh=DdeON4dE7lJWRQ3ctglZjDslpwzfnIcthyT8ytzFUEY=;
 b=l1oxl1Suf70IXnCaPmbQRKh1bv6y6kMFsEG/s/H17DDE88l2IGObz9rPOcf4ZwOSJExyp+
 gtP9x+rYPuyWg0vNRjFNEpUh98w3pB003NZf4i88NKHZw2K9Ul9wOKJiFzGHmBLmPOka7Q
 O+CiwwkoZ4mrzAonCF08J/55otYr2cQ=
DKIM-Signature: v=1; a=ed25519-sha256; c=relaxed/relaxed; d=suse.de;
 s=susede2_ed25519; t=1648028487;
 h=from:from:reply-to:date:date:message-id:message-id:to:to:cc:cc:
 mime-version:mime-version:content-type:content-type:
 in-reply-to:in-reply-to:references:references;
 bh=DdeON4dE7lJWRQ3ctglZjDslpwzfnIcthyT8ytzFUEY=;
 b=padKinWv/U197wWY42CvfKyfWzY+6TQWfJywpcmEkxJQn3YsQKZddeYa5WDJ6m32X/61gA
 /GcLMEcO/Ximw7BQ==
Received: from alsa1.suse.de (alsa1.suse.de [10.160.4.42])
 by relay2.suse.de (Postfix) with ESMTP id 96BBEA3B93;
 Wed, 23 Mar 2022 09:41:27 +0000 (UTC)
Date: Wed, 23 Mar 2022 10:41:27 +0100
Message-ID: <s5hh77puhtk.wl-tiwai@suse.de>
From: Takashi Iwai <tiwai@suse.de>
To: Jason Andryuk <jandryuk@gmail.com>
Subject: Re: snd_hda_intel initialization failure with Xen PCI passthrough
In-Reply-To: <CAKf6xpuRJ84RVfqPRJu3RL4xGF-FLkvO84SHTWEmXJFUWTgBGQ@mail.gmail.com>
References: <CAKf6xpuRJ84RVfqPRJu3RL4xGF-FLkvO84SHTWEmXJFUWTgBGQ@mail.gmail.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI/1.14.6 (Maruoka)
 FLIM/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL/10.8 Emacs/25.3
 (x86_64-suse-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Content-Type: text/plain; charset=US-ASCII
Cc: alsa-devel@alsa-project.org
X-BeenThere: alsa-devel@alsa-project.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: "Alsa-devel mailing list for ALSA developers -
 http://www.alsa-project.org" <alsa-devel.alsa-project.org>
List-Unsubscribe: <https://mailman.alsa-project.org/mailman/options/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=unsubscribe>
List-Archive: <http://mailman.alsa-project.org/pipermail/alsa-devel/>
List-Post: <mailto:alsa-devel@alsa-project.org>
List-Help: <mailto:alsa-devel-request@alsa-project.org?subject=help>
List-Subscribe: <https://mailman.alsa-project.org/mailman/listinfo/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=subscribe>
Errors-To: alsa-devel-bounces@alsa-project.org
Sender: "Alsa-devel" <alsa-devel-bounces@alsa-project.org>

On Tue, 22 Mar 2022 19:57:27 +0100,
Jason Andryuk wrote:
> 
> Hi,
> 
> I'm running Xen hypervisor and using PCI passthrough to assign an
> Intel HDA audio device (00:1f.3 Audio device: Intel Corporation Cannon
> Point-LP High Definition Audio Controller (rev 30)) to a Xen HVM
> virtual machine.  I do this for both Linux 5.4.185 and a different
> Windows 10 VM (only one at a time).  The Windows VM seems to work
> every time.  The Linux VM has issues after the first VM boot.  This is
> one boot of the physical hardware and multiple boots of the virtual
> machines.
> 
> For Linux, on first boot, the sound card is detected and works
> properly.  After that, things usually don't work.  I just ran a reboot
> loop and it was:
> 1st boot - audio detected and working
> 2 & 3 - no audio
> 4th - audio detected and working
> 5 - 20 - no audio
> 
> For boots 2, 3, 5-7, dmesg shows:
> [    0.760401] hdaudio hdaudioC0D0: no AFG or MFG node found
> [    0.760415] snd_hda_intel 0000:00:06.0: no codecs initialized
> 
> For boots 8+, the errors changed to:
> [    0.783397] hdaudio hdaudioC0D0: cannot read sub nodes for FG 0x10
> [    0.783413] snd_hda_intel 0000:00:06.0: no codecs initialized
> 
> At this point, I booted a Windows 10 VM and audio works
> 
> Trying to boot Linux again gives a new error message
> [    0.789041] snd_hda_intel 0000:00:06.0: Unknown capability 0
> [    1.811205] snd_hda_intel 0000:00:06.0: No response from codec,
> resetting bus: last cmd=0x0eef0004
> [    1.811246] hdaudio hdaudioC0D0: cannot read sub nodes for FG 0x10ee
> [    1.811263] snd_hda_intel 0000:00:06.0: no codecs initialized
> 
> Reboot VM and it's back to:
> [    0.775917] hdaudio hdaudioC0D0: no AFG or MFG node found
> [    0.775932] snd_hda_intel 0000:00:06.0: no codecs initialized
> 
> Reboot VM and again:
> [    0.789069] hdaudio hdaudioC0D0: cannot read sub nodes for FG 0x10
> [    0.789084] snd_hda_intel 0000:00:06.0: no codecs initialized
> 
> Reboot physical laptop:
> 1. boot Windows 10 - audio works
> 2. boot Linux - audio works
> 3. reboot Linux - no audio
> [    0.773111] hdaudio hdaudioC0D0: no AFG or MFG node found
> [    0.773151] snd_hda_intel 0000:00:06.0: no codecs initialized
> 
> This seems to me like Windows does a better job resetting the card to
> get the audio hardware working.  Any suggestions on what to
> investigate?

First off, 5.4.x is way too old to debug, please confirm the issue
with the latest kernel.

And, one test I'd try is to unload snd-hda-intel module before
rebooting.  Does the problem persist?


Takashi
