Return-Path: <alsa-devel-bounces@alsa-project.org>
X-Original-To: lists+alsa-devel@lfdr.de
Delivered-To: lists+alsa-devel@lfdr.de
Received: from alsa0.perex.cz (alsa0.perex.cz [77.48.224.243])
	by mail.lfdr.de (Postfix) with ESMTPS id A8F6763A4D3
	for <lists+alsa-devel@lfdr.de>; Mon, 28 Nov 2022 10:25:12 +0100 (CET)
Received: from alsa1.perex.cz (alsa1.perex.cz [207.180.221.201])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by alsa0.perex.cz (Postfix) with ESMTPS id 475641681;
	Mon, 28 Nov 2022 10:24:22 +0100 (CET)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa0.perex.cz 475641681
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=alsa-project.org;
	s=default; t=1669627512;
	bh=0irzzZHqocYuxw8duqMGPWFGZrxq1KwgiXzwXrKfIXY=;
	h=Date:From:To:Subject:In-Reply-To:References:Cc:List-Id:
	 List-Unsubscribe:List-Archive:List-Post:List-Help:List-Subscribe:
	 From;
	b=A0ESAXYJOGJ7WarkftKIG8kVVrQUhfM5WxM5sn+rU44HQxAvvmyu4XPRA2EGineOy
	 mqq7OGsO7ZMks5wFntZflC9xjDrvI9ZDmXRUGaY6sOf0n+fzmVZhEjcC0VsIF+nc3y
	 ZrcdT92Su5Ifc0gAWxPDFc4sUgJtT4n4odVqWqXM=
Received: from alsa1.perex.cz (localhost.localdomain [127.0.0.1])
	by alsa1.perex.cz (Postfix) with ESMTP id D9AADF8024C;
	Mon, 28 Nov 2022 10:24:16 +0100 (CET)
X-Original-To: alsa-devel@alsa-project.org
Delivered-To: alsa-devel@alsa-project.org
Received: by alsa1.perex.cz (Postfix, from userid 50401)
 id 8F70BF8016E; Mon, 28 Nov 2022 10:24:14 +0100 (CET)
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on alsa1.perex.cz
X-Spam-Level: 
X-Spam-Status: No, score=-0.1 required=5.0 tests=DKIM_SIGNED,DKIM_VALID,
 DKIM_VALID_AU,SPF_HELO_NONE,SPF_NONE,T_SCC_BODY_TEXT_LINE,URIBL_BLOCKED,
 URIBL_DBL_BLOCKED_OPENDNS autolearn=disabled version=3.4.0
Received: from smtp-out1.suse.de (smtp-out1.suse.de [195.135.220.28])
 (using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
 (No client certificate requested)
 by alsa1.perex.cz (Postfix) with ESMTPS id B1217F8016E
 for <alsa-devel@alsa-project.org>; Mon, 28 Nov 2022 10:24:08 +0100 (CET)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa1.perex.cz B1217F8016E
Authentication-Results: alsa1.perex.cz;
 dkim=pass (1024-bit key) header.d=suse.de header.i=@suse.de
 header.b="cMKxSgkE"; 
 dkim=permerror (0-bit key) header.d=suse.de header.i=@suse.de
 header.b="e72l6gZ6"
Received: from imap2.suse-dmz.suse.de (imap2.suse-dmz.suse.de [192.168.254.74])
 (using TLSv1.3 with cipher TLS_AES_256_GCM_SHA384 (256/256 bits)
 key-exchange X25519 server-signature ECDSA (P-521) server-digest SHA512)
 (No client certificate requested)
 by smtp-out1.suse.de (Postfix) with ESMTPS id E10B321B0C;
 Mon, 28 Nov 2022 09:24:07 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=suse.de; s=susede2_rsa;
 t=1669627447; h=from:from:reply-to:date:date:message-id:message-id:to:to:cc:cc:
 mime-version:mime-version:content-type:content-type:
 in-reply-to:in-reply-to:references:references;
 bh=xRzcxDxljSZx2A2E00n+nkQ2uYUP1JqeGXcAzE3P+Dg=;
 b=cMKxSgkEZz8ekh6dppBYqPtKL9Q6yjSbFqyxxI/vWUU1e2V/gcEJMEjFgub2MaTOlGSCj1
 rvmC27jw7pCvisIL7oTicTSMIMCgU9Twu0Xt70XKXJAZ3EMzzXH+8hG/A544Ma25z0rq2r
 AZlStKY4EW4cmIRSjmRYmVyk1FBbiUw=
DKIM-Signature: v=1; a=ed25519-sha256; c=relaxed/relaxed; d=suse.de;
 s=susede2_ed25519; t=1669627447;
 h=from:from:reply-to:date:date:message-id:message-id:to:to:cc:cc:
 mime-version:mime-version:content-type:content-type:
 in-reply-to:in-reply-to:references:references;
 bh=xRzcxDxljSZx2A2E00n+nkQ2uYUP1JqeGXcAzE3P+Dg=;
 b=e72l6gZ6OYjS416WitkMJqqUkKXFiRC42TrJiIOQKz3+08Wn2Pd55rZ84q2R81qCEzTbTE
 lEW7UJfAS0hnoaBg==
Received: from imap2.suse-dmz.suse.de (imap2.suse-dmz.suse.de [192.168.254.74])
 (using TLSv1.3 with cipher TLS_AES_256_GCM_SHA384 (256/256 bits)
 key-exchange X25519 server-signature ECDSA (P-521) server-digest SHA512)
 (No client certificate requested)
 by imap2.suse-dmz.suse.de (Postfix) with ESMTPS id A3A551326E;
 Mon, 28 Nov 2022 09:24:07 +0000 (UTC)
Received: from dovecot-director2.suse.de ([192.168.254.65])
 by imap2.suse-dmz.suse.de with ESMTPSA id +/QkJzd+hGN4egAAMHmgww
 (envelope-from <tiwai@suse.de>); Mon, 28 Nov 2022 09:24:07 +0000
Date: Mon, 28 Nov 2022 10:24:07 +0100
Message-ID: <87wn7fzb2g.wl-tiwai@suse.de>
From: Takashi Iwai <tiwai@suse.de>
To: Ricardo Ribalda <ribalda@chromium.org>
Subject: Re: [PATCH v3 0/2] ALSA: core: Fix deadlock when shutdown a frozen
 userspace
In-Reply-To: <20221127-snd-freeze-v3-0-a2eda731ca14@chromium.org>
References: <20221127-snd-freeze-v3-0-a2eda731ca14@chromium.org>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) Emacs/27.2 Mule/6.0
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
Cc: Len Brown <len.brown@intel.com>, alsa-devel@alsa-project.org,
 Kai Vehmanen <kai.vehmanen@linux.intel.com>,
 "Rafael J. Wysocki" <rafael@kernel.org>, linux-kernel@vger.kernel.org,
 linux-pm@vger.kernel.org,
 Ranjani Sridharan <ranjani.sridharan@linux.intel.com>,
 Takashi Iwai <tiwai@suse.com>, Mark Brown <broonie@kernel.org>,
 Pavel Machek <pavel@ucw.cz>,
 "Joel Fernandes \(Google\)" <joel@joelfernandes.org>,
 Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
X-BeenThere: alsa-devel@alsa-project.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: "Alsa-devel mailing list for ALSA developers -
 http://www.alsa-project.org" <alsa-devel.alsa-project.org>
List-Unsubscribe: <https://mailman.alsa-project.org/mailman/options/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=unsubscribe>
List-Archive: <http://mailman.alsa-project.org/pipermail/alsa-devel/>
List-Post: <mailto:alsa-devel@alsa-project.org>
List-Help: <mailto:alsa-devel-request@alsa-project.org?subject=help>
List-Subscribe: <https://mailman.alsa-project.org/mailman/listinfo/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=subscribe>
Errors-To: alsa-devel-bounces@alsa-project.org
Sender: "Alsa-devel" <alsa-devel-bounces@alsa-project.org>

On Mon, 28 Nov 2022 10:10:12 +0100,
Ricardo Ribalda wrote:
> 
> Since 83bfc7e793b5 ("ASoC: SOF: core: unregister clients and machine drivers in .shutdown")
> we wait for userspace to close its fds.

IMO, the fix above brought more problem.  If you'd need to want to
avoid later accesses during shutdown, the driver should rather just
disconnect devices without waiting for the user-space completion.
And, for that, a simple call of snd_card_disconnect() should suffice.

> But that will never occur with a frozen userspace (like during kexec()).
> 
> Lets detect the frozen userpace and act accordingly.

... and skipping the user-space sync at snd_card_disconnect_sync() as
of this patch set is a dangerous move, I'm afraid.  The user-space
gets frozen also at the normal suspend/resume, and it implies that the
sync will be lost even for the normal PM, too (although it must be a
very corner case).


thanks,

Takashi

> 
> To: Jaroslav Kysela <perex@perex.cz>
> To: Takashi Iwai <tiwai@suse.com>
> To: "Rafael J. Wysocki" <rafael@kernel.org>
> To: Pavel Machek <pavel@ucw.cz>
> To: Len Brown <len.brown@intel.com>
> To: Kai Vehmanen <kai.vehmanen@linux.intel.com>
> To: Ranjani Sridharan <ranjani.sridharan@linux.intel.com>
> To: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
> To: Mark Brown <broonie@kernel.org>
> Cc: alsa-devel@alsa-project.org
> Cc: linux-kernel@vger.kernel.org
> Cc: "Joel Fernandes (Google)" <joel@joelfernandes.org>
> Cc: linux-pm@vger.kernel.org
> Signed-off-by: Ricardo Ribalda <ribalda@chromium.org>
> ---
> Changes in v3:
> - Wrap pm_freezing in a function
> - Link to v2: https://lore.kernel.org/r/20221127-snd-freeze-v2-0-d8a425ea9663@chromium.org
> 
> Changes in v2:
> - Only use pm_freezing if CONFIG_FREEZER 
> - Link to v1: https://lore.kernel.org/r/20221127-snd-freeze-v1-0-57461a366ec2@chromium.org
> 
> ---
> Ricardo Ribalda (2):
>       freezer: Add processes_frozen()
>       ALSA: core: Fix deadlock when shutdown a frozen userspace
> 
>  include/linux/freezer.h |  2 ++
>  kernel/freezer.c        | 11 +++++++++++
>  sound/core/init.c       | 13 +++++++++++++
>  3 files changed, 26 insertions(+)
> ---
> base-commit: 4312098baf37ee17a8350725e6e0d0e8590252d4
> change-id: 20221127-snd-freeze-1ee143228326
> 
> Best regards,
> -- 
> Ricardo Ribalda <ribalda@chromium.org>
> 
