Return-Path: <alsa-devel-bounces@alsa-project.org>
X-Original-To: lists+alsa-devel@lfdr.de
Delivered-To: lists+alsa-devel@lfdr.de
Received: from alsa0.perex.cz (alsa0.perex.cz [77.48.224.243])
	by mail.lfdr.de (Postfix) with ESMTPS id B1B911249BF
	for <lists+alsa-devel@lfdr.de>; Wed, 18 Dec 2019 15:33:20 +0100 (CET)
Received: from alsa1.perex.cz (alsa1.perex.cz [207.180.221.201])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by alsa0.perex.cz (Postfix) with ESMTPS id 27B6F1654;
	Wed, 18 Dec 2019 15:32:30 +0100 (CET)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa0.perex.cz 27B6F1654
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=alsa-project.org;
	s=default; t=1576679600;
	bh=gDJe4vyz2zm2K/0a2jBgEmIDs9wV+1pPmdXZrCRWHKA=;
	h=Date:From:To:In-Reply-To:References:Cc:Subject:List-Id:
	 List-Unsubscribe:List-Archive:List-Post:List-Help:List-Subscribe:
	 From;
	b=ZNiBTzTRoSdZC+uWZH+aZlRXPanuV3FfRfzn5lsM9WmjVhZx5Xghvlcw84NZI+8QE
	 O5ZCNHOak0ZA0+XuzVaWRX+NcOnKjkDb+hf7k7ATXHW6CZFXOA4PizgTFkHfAnh8bD
	 l14yc+8XggTCYUJakfmfhde/AQD+JyqTz6uc91Xo=
Received: from alsa1.perex.cz (localhost.localdomain [127.0.0.1])
	by alsa1.perex.cz (Postfix) with ESMTP id 542D3F80255;
	Wed, 18 Dec 2019 15:31:37 +0100 (CET)
X-Original-To: alsa-devel@alsa-project.org
Delivered-To: alsa-devel@alsa-project.org
Received: by alsa1.perex.cz (Postfix, from userid 50401)
 id DF4BEF8022C; Wed, 18 Dec 2019 15:31:34 +0100 (CET)
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on alsa1.perex.cz
X-Spam-Level: 
X-Spam-Status: No, score=0.0 required=5.0 tests=RCVD_IN_MSPIKE_H3,
 RCVD_IN_MSPIKE_WL,SPF_HELO_NONE,SPF_PASS,SURBL_BLOCKED,URIBL_BLOCKED
 autolearn=disabled version=3.4.0
Received: from mx2.suse.de (mx2.suse.de [195.135.220.15])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by alsa1.perex.cz (Postfix) with ESMTPS id 07601F8014C
 for <alsa-devel@alsa-project.org>; Wed, 18 Dec 2019 15:31:31 +0100 (CET)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa1.perex.cz 07601F8014C
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx2.suse.de (Postfix) with ESMTP id 57666AE3F;
 Wed, 18 Dec 2019 14:31:30 +0000 (UTC)
Date: Wed, 18 Dec 2019 15:31:30 +0100
Message-ID: <s5h5zid903h.wl-tiwai@suse.de>
From: Takashi Iwai <tiwai@suse.de>
To: Jon Hunter <jonathanh@nvidia.com>
In-Reply-To: <53562c71-4d81-1580-f311-971ceb029431@nvidia.com>
References: <20191210145727.22054-1-tiwai@suse.de>
 <53562c71-4d81-1580-f311-971ceb029431@nvidia.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI/1.14.6 (Maruoka)
 FLIM/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL/10.8 Emacs/25.3
 (x86_64-suse-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Cc: linux-tegra <linux-tegra@vger.kernel.org>, alsa-devel@alsa-project.org
Subject: Re: [alsa-devel] [PATCH] ALSA: hda: Use standard waitqueue for RIRB
	wakeup
X-BeenThere: alsa-devel@alsa-project.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: "Alsa-devel mailing list for ALSA developers -
 http://www.alsa-project.org" <alsa-devel.alsa-project.org>
List-Unsubscribe: <https://mailman.alsa-project.org/mailman/options/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=unsubscribe>
List-Archive: <http://mailman.alsa-project.org/pipermail/alsa-devel/>
List-Post: <mailto:alsa-devel@alsa-project.org>
List-Help: <mailto:alsa-devel-request@alsa-project.org?subject=help>
List-Subscribe: <https://mailman.alsa-project.org/mailman/listinfo/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=subscribe>
Content-Type: text/plain; charset="us-ascii"
Content-Transfer-Encoding: 7bit
Errors-To: alsa-devel-bounces@alsa-project.org
Sender: "Alsa-devel" <alsa-devel-bounces@alsa-project.org>

On Wed, 18 Dec 2019 15:17:27 +0100,
Jon Hunter wrote:
> 
> 
> On 10/12/2019 14:57, Takashi Iwai wrote:
> > The HD-audio CORB/RIRB communication was programmed in a way that was
> > documented in the reference in decades ago, which is essentially a
> > polling in the waiter side.  It's working fine but costs CPU cycles on
> > some platforms that support only slow communications.  Also, for some
> > platforms that had unreliable communications, we put longer wait time
> > (2 ms), which accumulate quite long time if you execute many verbs in
> > a shot (e.g. at the initialization or resume phase).
> > 
> > This patch attempts to improve the situation by introducing the
> > standard waitqueue in the RIRB waiter side instead of polling.  The
> > test results on my machine show significant improvements.  The time
> > spent for "cat /proc/asound/card*/codec#*" were changed like:
> > 
> > * Intel SKL + Realtek codec
> >   before the patch:
> >    0.00user 0.04system 0:00.10elapsed 40.0%CPU
> >   after the patch:
> >    0.00user 0.01system 0:00.10elapsed 10.0%CPU
> > 
> > * Nvidia GP107GL + Nvidia HDMI codec
> >   before the patch:
> >    0.00user 0.00system 0:02.76elapsed 0.0%CPU
> >   after the patch:
> >    0.00user 0.00system 0:00.01elapsed 17.0%CPU
> > 
> > So, for Intel chips, the total time is same, while the total time is
> > greatly reduced (from 2.76 to 0.01s) for Nvidia chips.
> > The only negative data here is the increase of CPU time for Nvidia,
> > but this is the unavoidable cost for faster wakeups, supposedly.
> > 
> > Signed-off-by: Takashi Iwai <tiwai@suse.de>
> Starting with next-20191217 I am seeing the following error on one of
> our Tegra platforms ...
> 
> tegra-hda 3510000.hda: azx_get_response timeout, switching to polling
> mode: last cmd=0x404f2d00
> 
> Bisect is point to this commit and although it does not cleanly revert,
> if I revert this and a couple dependencies on top of -next the issue
> goes away. Any thoughts on what could be going on here?

Do you see any bad behavior other than the warning message?

If you don't see any dysfunction, I guess that the difference is that
the old code went to the trial mode at first silently (with
dev_dbg()), then switching to polling mode at next.  The trial mode is
basically same as polling mode, but it was just considered to be a
temporary transition, so not warned.

IOW, if my guess is correct, maybe Tegra never worked in the normal
mode but only in the polling mode (but without complaints).
If so, the patch like below would be needed.

To prove my theory, could you check the old code with dyndbg enabled
for sound/pci/hda/hda_controller.c?  If a message like below appears,
it's the case:
  azx_get_response timeout, polling the codec once: last cmd=xxx


thanks,

Takashi

--- a/sound/pci/hda/hda_tegra.c
+++ b/sound/pci/hda/hda_tegra.c
@@ -394,6 +394,7 @@ static int hda_tegra_create(struct snd_card *card,
 	if (err < 0)
 		return err;
 
+	chip->bus.core.polling = 1;
 	chip->bus.core.needs_damn_long_delay = 1;
 
 	err = snd_device_new(card, SNDRV_DEV_LOWLEVEL, chip, &ops);
_______________________________________________
Alsa-devel mailing list
Alsa-devel@alsa-project.org
https://mailman.alsa-project.org/mailman/listinfo/alsa-devel
