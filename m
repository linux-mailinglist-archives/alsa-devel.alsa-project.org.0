Return-Path: <alsa-devel-bounces@alsa-project.org>
X-Original-To: lists+alsa-devel@lfdr.de
Delivered-To: lists+alsa-devel@lfdr.de
Received: from alsa0.perex.cz (alsa0.perex.cz [77.48.224.243])
	by mail.lfdr.de (Postfix) with ESMTPS id 68C5E5F8F2
	for <lists+alsa-devel@lfdr.de>; Thu,  4 Jul 2019 15:14:52 +0200 (CEST)
Received: from alsa1.perex.cz (alsa1.perex.cz [207.180.221.201])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by alsa0.perex.cz (Postfix) with ESMTPS id E24B4168B;
	Thu,  4 Jul 2019 15:14:01 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa0.perex.cz E24B4168B
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=alsa-project.org;
	s=default; t=1562246092;
	bh=6KkBDKUxJSrT8QrphaHL9J4OrBOhyWGwykSVFuECIWw=;
	h=Date:From:To:In-Reply-To:References:Cc:Subject:List-Id:
	 List-Unsubscribe:List-Archive:List-Post:List-Help:List-Subscribe:
	 From;
	b=JhXJTcv57OQbbA2ii2xcVus+MVP3y8Cy5jW+A46keE5D7GjLk7jW7asIN/uIyGZtI
	 kuFhSt8Mi5zshddBgt7MiV6RK7lzcitxJrRuTTLjO0WsAMQSsP0VOmAJF76E0Sw9Nz
	 PXsM9tx22Wbzvawm9uX7DReQObhA/YW5Zb7UVcXg=
Received: from alsa1.perex.cz (localhost.localdomain [127.0.0.1])
	by alsa1.perex.cz (Postfix) with ESMTP id 1C53BF80112;
	Thu,  4 Jul 2019 15:13:07 +0200 (CEST)
X-Original-To: alsa-devel@alsa-project.org
Delivered-To: alsa-devel@alsa-project.org
Received: by alsa1.perex.cz (Postfix, from userid 50401)
 id B3899F80111; Thu,  4 Jul 2019 15:13:05 +0200 (CEST)
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on alsa1.perex.cz
X-Spam-Level: 
X-Spam-Status: No, score=0.0 required=5.0 tests=SPF_HELO_NONE,SPF_PASS
 autolearn=disabled version=3.4.0
Received: from mx1.suse.de (mx2.suse.de [195.135.220.15])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by alsa1.perex.cz (Postfix) with ESMTPS id D5750F800E7
 for <alsa-devel@alsa-project.org>; Thu,  4 Jul 2019 15:13:02 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa1.perex.cz D5750F800E7
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 0FE18B114;
 Thu,  4 Jul 2019 13:13:02 +0000 (UTC)
Date: Thu, 04 Jul 2019 15:13:01 +0200
Message-ID: <s5ho92a0wpu.wl-tiwai@suse.de>
From: Takashi Iwai <tiwai@suse.de>
To: "Fuqian Huang" <huangfq.daxian@gmail.com>
In-Reply-To: <20190703163210.983-1-huangfq.daxian@gmail.com>
References: <20190703163210.983-1-huangfq.daxian@gmail.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI/1.14.6 (Maruoka)
 FLIM/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL/10.8 Emacs/25.3
 (x86_64-suse-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Cc: linux-kernel@vger.kernel.org, alsa-devel@alsa-project.org,
 Takashi Iwai <tiwai@suse.com>
Subject: Re: [alsa-devel] [PATCH v2 33/35] sound/pci: Use kmemdup rather
	than duplicating its implementation
X-BeenThere: alsa-devel@alsa-project.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: "Alsa-devel mailing list for ALSA developers -
 http://www.alsa-project.org" <alsa-devel.alsa-project.org>
List-Unsubscribe: <https://mailman.alsa-project.org/mailman/options/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=unsubscribe>
List-Archive: <http://mailman.alsa-project.org/pipermail/alsa-devel/>
List-Post: <mailto:alsa-devel@alsa-project.org>
List-Help: <mailto:alsa-devel-request@alsa-project.org?subject=help>
List-Subscribe: <https://mailman.alsa-project.org/mailman/listinfo/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=subscribe>
Content-Type: text/plain; charset="us-ascii"
Content-Transfer-Encoding: 7bit
Errors-To: alsa-devel-bounces@alsa-project.org
Sender: "Alsa-devel" <alsa-devel-bounces@alsa-project.org>

On Wed, 03 Jul 2019 18:32:10 +0200,
Fuqian Huang wrote:
> 
> kmemdup is introduced to duplicate a region of memory in a neat way.
> Rather than kmalloc/kzalloc + memcpy, which the programmer needs to
> write the size twice (sometimes lead to mistakes), kmemdup improves
> readability, leads to smaller code and also reduce the chances of mistakes.
> Suggestion to use kmemdup rather than using kmalloc/kzalloc + memcpy.
> 
> Signed-off-by: Fuqian Huang <huangfq.daxian@gmail.com>
> ---
> Changes in v2:
>   - Fix a typo in commit message (memset -> memcpy)
> 
>  sound/pci/echoaudio/echoaudio.c | 3 +--
>  1 file changed, 1 insertion(+), 2 deletions(-)
> 
> diff --git a/sound/pci/echoaudio/echoaudio.c b/sound/pci/echoaudio/echoaudio.c
> index b612a536a5a1..35bd3e7c8ce1 100644
> --- a/sound/pci/echoaudio/echoaudio.c
> +++ b/sound/pci/echoaudio/echoaudio.c
> @@ -2189,11 +2189,10 @@ static int snd_echo_resume(struct device *dev)
>  	u32 pipe_alloc_mask;
>  	int err;
>  
> -	commpage_bak = kmalloc(sizeof(*commpage), GFP_KERNEL);
> +	commpage_bak = kmemdup(commpage, sizeof(*commpage), GFP_KERNEL);
>  	if (commpage_bak == NULL)
>  		return -ENOMEM;
>  	commpage = chip->comm_page;
> -	memcpy(commpage_bak, commpage, sizeof(*commpage));
>  
>  	err = init_hw(chip, chip->pci->device, chip->pci->subsystem_device);
>  	if (err < 0) {

The patch is obviously wrong and leads to a crash.  See that the
assignment of the source address is done after the kmalloc() call but
before memcpy().  With kmemdup(), this will be screwed up.

This error could be caught easily by just compiling the kernel, too.
Please do at least the proper build test at the next time.


thanks,

Takashi
_______________________________________________
Alsa-devel mailing list
Alsa-devel@alsa-project.org
https://mailman.alsa-project.org/mailman/listinfo/alsa-devel
