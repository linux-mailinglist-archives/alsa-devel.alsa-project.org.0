Return-Path: <alsa-devel-bounces@alsa-project.org>
X-Original-To: lists+alsa-devel@lfdr.de
Delivered-To: lists+alsa-devel@lfdr.de
Received: from alsa0.perex.cz (alsa0.perex.cz [77.48.224.243])
	by mail.lfdr.de (Postfix) with ESMTPS id 83DC83D463E
	for <lists+alsa-devel@lfdr.de>; Sat, 24 Jul 2021 10:05:43 +0200 (CEST)
Received: from alsa1.perex.cz (alsa1.perex.cz [207.180.221.201])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by alsa0.perex.cz (Postfix) with ESMTPS id E6ACE1767;
	Sat, 24 Jul 2021 10:04:52 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa0.perex.cz E6ACE1767
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=alsa-project.org;
	s=default; t=1627113943;
	bh=igStpwqMxg03S2SGYP5AHcg1pIzd14mRHVlmvxk9ajU=;
	h=Date:From:To:Subject:In-Reply-To:References:Cc:List-Id:
	 List-Unsubscribe:List-Archive:List-Post:List-Help:List-Subscribe:
	 From;
	b=UiO7wjUnMIOO9KzFcJzWFR5Xhc54qCn8dBBaK9OD2Q47g7xgn4xVjei0V/lY8ogp4
	 FwzwgiuFkZX5MpSYg6y+JDQlekCGMvXBVpnWv9iOjahO+udyaRzOHlzkg9OwToUp+G
	 tackJE75pgsCInjPDXcOERJor26s451QRE1jeUnI=
Received: from alsa1.perex.cz (localhost.localdomain [127.0.0.1])
	by alsa1.perex.cz (Postfix) with ESMTP id 5D1ACF800DA;
	Sat, 24 Jul 2021 10:04:16 +0200 (CEST)
X-Original-To: alsa-devel@alsa-project.org
Delivered-To: alsa-devel@alsa-project.org
Received: by alsa1.perex.cz (Postfix, from userid 50401)
 id 46614F80227; Sat, 24 Jul 2021 10:04:14 +0200 (CEST)
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on alsa1.perex.cz
X-Spam-Level: 
X-Spam-Status: No, score=-0.1 required=5.0 tests=DKIM_SIGNED,DKIM_VALID,
 DKIM_VALID_AU,SPF_HELO_NONE,SPF_NONE,URIBL_BLOCKED autolearn=disabled
 version=3.4.0
Received: from smtp-out2.suse.de (smtp-out2.suse.de [195.135.220.29])
 (using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
 (No client certificate requested)
 by alsa1.perex.cz (Postfix) with ESMTPS id 350C5F800DA
 for <alsa-devel@alsa-project.org>; Sat, 24 Jul 2021 10:04:06 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa1.perex.cz 350C5F800DA
Authentication-Results: alsa1.perex.cz;
 dkim=pass (1024-bit key) header.d=suse.de header.i=@suse.de
 header.b="WtQlljWj"; 
 dkim=permerror (0-bit key) header.d=suse.de header.i=@suse.de
 header.b="MTkc/JF8"
Received: from relay2.suse.de (relay2.suse.de [149.44.160.134])
 by smtp-out2.suse.de (Postfix) with ESMTP id 4EC3C2001B;
 Sat, 24 Jul 2021 08:04:05 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=suse.de; s=susede2_rsa;
 t=1627113845; h=from:from:reply-to:date:date:message-id:message-id:to:to:cc:cc:
 mime-version:mime-version:content-type:content-type:
 in-reply-to:in-reply-to:references:references;
 bh=24IQqn9FXptEdDFM0uvk5v9JwwGmH7qRb69eCI8SxgI=;
 b=WtQlljWjRL/CjVz5fyWTfQVwmwpsKvkz5L4ASWaikYX97ZKg9d2H9t9A6niDUDT/6phiGX
 1QnQFlfkVrbLO/lnWUJ+rr2PtEvXp7vCmLwxtefqkeQMvLe6dKWbqV2hCD1HeZKa/zY6aH
 2HBBR/LFn6C8ei+9Wir1HgfOGxCvan4=
DKIM-Signature: v=1; a=ed25519-sha256; c=relaxed/relaxed; d=suse.de;
 s=susede2_ed25519; t=1627113845;
 h=from:from:reply-to:date:date:message-id:message-id:to:to:cc:cc:
 mime-version:mime-version:content-type:content-type:
 in-reply-to:in-reply-to:references:references;
 bh=24IQqn9FXptEdDFM0uvk5v9JwwGmH7qRb69eCI8SxgI=;
 b=MTkc/JF87R3cvXo51USXV8O+c1pl2c2NBub8Ce5QknywyBUKrf/C/fNIuDeWTQ6iCeXOlS
 URW7hRR0YVOkFzAg==
Received: from alsa1.suse.de (alsa1.suse.de [10.160.4.42])
 by relay2.suse.de (Postfix) with ESMTP id 1A5A0A3B87;
 Sat, 24 Jul 2021 08:04:05 +0000 (UTC)
Date: Sat, 24 Jul 2021 10:04:05 +0200
Message-ID: <s5h7dhgi1e2.wl-tiwai@suse.de>
From: Takashi Iwai <tiwai@suse.de>
To: <chihhao.chen@mediatek.com>
Subject: Re: [PATCH] ALSA: usb-audio: fix incorrect clock source setting
In-Reply-To: <1627100621-19225-1-git-send-email-chihhao.chen@mediatek.com>
References: <1627100621-19225-1-git-send-email-chihhao.chen@mediatek.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI/1.14.6 (Maruoka)
 FLIM/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL/10.8 Emacs/25.3
 (x86_64-suse-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Content-Type: text/plain; charset=US-ASCII
Cc: alsa-devel@alsa-project.org, wsd_upstream@mediatek.com, damien@zamaudio.com,
 tiwai@suse.com, linux-kernel@vger.kernel.org,
 linux-mediatek@lists.infradead.org, matthias.bgg@gmail.com,
 linux-arm-kernel@lists.infradead.org
X-BeenThere: alsa-devel@alsa-project.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: "Alsa-devel mailing list for ALSA developers -
 http://www.alsa-project.org" <alsa-devel.alsa-project.org>
List-Unsubscribe: <https://mailman.alsa-project.org/mailman/options/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=unsubscribe>
List-Archive: <http://mailman.alsa-project.org/pipermail/alsa-devel/>
List-Post: <mailto:alsa-devel@alsa-project.org>
List-Help: <mailto:alsa-devel-request@alsa-project.org?subject=help>
List-Subscribe: <https://mailman.alsa-project.org/mailman/listinfo/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=subscribe>
Errors-To: alsa-devel-bounces@alsa-project.org
Sender: "Alsa-devel" <alsa-devel-bounces@alsa-project.org>

On Sat, 24 Jul 2021 06:23:41 +0200,
<chihhao.chen@mediatek.com> wrote:
> 
> From: "chihhao.chen" <chihhao.chen@mediatek.com>
> 
> The following scenario describes an echo test for
> Samsung USBC Headset (AKG) with VID/PID (0x04e8/0xa051).
> 
> We first start a capture stream(USB IN transfer) in 96Khz/24bit/1ch mode.
> In clock find source function, we get value 0x2 for clock selector
> and 0x1 for clock source.
> 
> Kernel-4.14 behavior
> Since clock source is valid so clock selector was not set again.
> We pass through this function and start a playback stream(USB OUT transfer)
> in 48Khz/32bit/2ch mode. This time we get value 0x1 for clock selector
> and 0x1 for clock source. Finally clock id with this setting is 0x9.
> 
> Kernel-5.10 behavior
> Clock selector was always set one more time even it is valid.
> When we start a playback stream, we will get 0x2 for clock selector
> and 0x1 for clock source. In this case clock id becomes 0xA.
> This is an incorrect clock source setting and results in severe noises.
> We see wrong data rate in USB IN transfer.
> (From 288 bytes/ms becomes 144 bytes/ms) It should keep in 288 bytes/ms.
> 
> This earphone works fine on older kernel version load because
> this is a newly-added behavior.
> 
> Signed-off-by: chihhao.chen <chihhao.chen@mediatek.com>

Thanks for the patch.

This looks like a regression introduced by the recent commit
d2e8f641257d ("ALSA: usb-audio: Explicitly set up the clock
selector"), which is a fix for certain devices.  Too bad that the
behavior really depends on the device...

Maybe we need to introduce some flag to handle this commonly, but for
now, let's take the fix as is.


Takashi
