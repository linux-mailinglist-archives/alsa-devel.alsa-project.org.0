Return-Path: <alsa-devel-bounces@alsa-project.org>
X-Original-To: lists+alsa-devel@lfdr.de
Delivered-To: lists+alsa-devel@lfdr.de
Received: from alsa0.perex.cz (alsa0.perex.cz [77.48.224.243])
	by mail.lfdr.de (Postfix) with ESMTPS id 44A36372746
	for <lists+alsa-devel@lfdr.de>; Tue,  4 May 2021 10:32:20 +0200 (CEST)
Received: from alsa1.perex.cz (alsa1.perex.cz [207.180.221.201])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by alsa0.perex.cz (Postfix) with ESMTPS id D4BEA1693;
	Tue,  4 May 2021 10:31:29 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa0.perex.cz D4BEA1693
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=alsa-project.org;
	s=default; t=1620117139;
	bh=Tk5yR5WKhNFs4AmvFn7u/KwkwwViHrzHXMVHn3hP6ZM=;
	h=Date:From:To:Subject:In-Reply-To:References:Cc:List-Id:
	 List-Unsubscribe:List-Archive:List-Post:List-Help:List-Subscribe:
	 From;
	b=to0rtA9Z8ck2bbsoZTqRjKmEQ/mp8l3cSin0CwV000zs+v7IFtY4feevUcrJZiE3z
	 V40q3079e2NUyVtlgcEFEjxKVEBXEh/1fCb67aKBf5mdgTAWhy0jYyLu9dCP1VPugx
	 2Jw6iDKgXBdDq1hHC923WPH001zyG9lsYk+jmRDc=
Received: from alsa1.perex.cz (localhost.localdomain [127.0.0.1])
	by alsa1.perex.cz (Postfix) with ESMTP id 3CFFAF80114;
	Tue,  4 May 2021 10:30:52 +0200 (CEST)
X-Original-To: alsa-devel@alsa-project.org
Delivered-To: alsa-devel@alsa-project.org
Received: by alsa1.perex.cz (Postfix, from userid 50401)
 id 15C28F8021C; Tue,  4 May 2021 10:30:50 +0200 (CEST)
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on alsa1.perex.cz
X-Spam-Level: 
X-Spam-Status: No, score=0.0 required=5.0 tests=SPF_HELO_NONE,SPF_NONE,
 URIBL_BLOCKED autolearn=disabled version=3.4.0
Received: from mx2.suse.de (mx2.suse.de [195.135.220.15])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by alsa1.perex.cz (Postfix) with ESMTPS id E5368F80114
 for <alsa-devel@alsa-project.org>; Tue,  4 May 2021 10:30:38 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa1.perex.cz E5368F80114
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.221.27])
 by mx2.suse.de (Postfix) with ESMTP id 4FA0DB151;
 Tue,  4 May 2021 08:30:38 +0000 (UTC)
Date: Tue, 04 May 2021 10:30:38 +0200
Message-ID: <s5ha6parjdd.wl-tiwai@suse.de>
From: Takashi Iwai <tiwai@suse.de>
To: Hui Wang <hui.wang@canonical.com>
Subject: Re: [PATCH] ALSA: hda: generic: change the DAC ctl name for LO+SPK or
 LO+HP
In-Reply-To: <20210504073917.22406-1-hui.wang@canonical.com>
References: <20210504073917.22406-1-hui.wang@canonical.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI/1.14.6 (Maruoka)
 FLIM/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL/10.8 Emacs/25.3
 (x86_64-suse-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Content-Type: text/plain; charset=US-ASCII
Cc: alsa-devel@alsa-project.org
X-BeenThere: alsa-devel@alsa-project.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: "Alsa-devel mailing list for ALSA developers -
 http://www.alsa-project.org" <alsa-devel.alsa-project.org>
List-Unsubscribe: <https://mailman.alsa-project.org/mailman/options/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=unsubscribe>
List-Archive: <http://mailman.alsa-project.org/pipermail/alsa-devel/>
List-Post: <mailto:alsa-devel@alsa-project.org>
List-Help: <mailto:alsa-devel-request@alsa-project.org?subject=help>
List-Subscribe: <https://mailman.alsa-project.org/mailman/listinfo/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=subscribe>
Errors-To: alsa-devel-bounces@alsa-project.org
Sender: "Alsa-devel" <alsa-devel-bounces@alsa-project.org>

On Tue, 04 May 2021 09:39:17 +0200,
Hui Wang wrote:
> 
> Without this change, the DAC ctl's name could be changed only when
> the machine has both Speaker and Headphone, but we met some machines
> which only has Lineout and Headhpone, and the Lineout and Headphone
> share the Audio Mixer0 and DAC0, the ctl's name is set to "Front".
> 
> On most of machines, the "Front" is used for Speaker only or Lineout
> only, but on this machine it is shared by Lineout and Headphone,
> This introduces an issue in the pipewire and pulseaudio, suppose users
> want the Headphone to be on and the Speaker/Lineout to be off, they
> could turn off the "Front", this works on most of the machines, but on
> this machine, the "Front" couldn't be turned off otherwise the
> headphone will be off too. Here we do some change to let the ctl's
> name change to "Headphone+LO" on this machine, and pipewire and
> pulseaudio already could handle "Headphone+LO" and "Speaker+LO".
> (https://gitlab.freedesktop.org/pipewire/pipewire/-/issues/747)
> 
> BugLink: http://bugs.launchpad.net/bugs/804178
> Signed-off-by: Hui Wang <hui.wang@canonical.com>

I'm fine to take the change, but wouldn't this break anything else in
PA?  Once when I get a positive answer, I'll apply it.


thanks,

Takashi

> ---
>  sound/pci/hda/hda_generic.c | 16 +++++++++++-----
>  1 file changed, 11 insertions(+), 5 deletions(-)
> 
> diff --git a/sound/pci/hda/hda_generic.c b/sound/pci/hda/hda_generic.c
> index 3998e1771805..b638fc2ef6f7 100644
> --- a/sound/pci/hda/hda_generic.c
> +++ b/sound/pci/hda/hda_generic.c
> @@ -1204,11 +1204,17 @@ static const char *get_line_out_pfx(struct hda_codec *codec, int ch,
>  		*index = ch;
>  		return "Headphone";
>  	case AUTO_PIN_LINE_OUT:
> -		/* This deals with the case where we have two DACs and
> -		 * one LO, one HP and one Speaker */
> -		if (!ch && cfg->speaker_outs && cfg->hp_outs) {
> -			bool hp_lo_shared = !path_has_mixer(codec, spec->hp_paths[0], ctl_type);
> -			bool spk_lo_shared = !path_has_mixer(codec, spec->speaker_paths[0], ctl_type);
> +		/* This deals with the case where one HP or one Speaker or
> +		 * one HP + one Speaker need to share the DAC with LO
> +		 */
> +		if (!ch) {
> +			bool hp_lo_shared = false, spk_lo_shared = false;
> +
> +			if (cfg->speaker_outs)
> +				spk_lo_shared = !path_has_mixer(codec,
> +								spec->speaker_paths[0],	ctl_type);
> +			if (cfg->hp_outs)
> +				hp_lo_shared = !path_has_mixer(codec, spec->hp_paths[0], ctl_type);
>  			if (hp_lo_shared && spk_lo_shared)
>  				return spec->vmaster_mute.hook ? "PCM" : "Master";
>  			if (hp_lo_shared)
> -- 
> 2.25.1
> 
