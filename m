Return-Path: <alsa-devel-bounces@alsa-project.org>
X-Original-To: lists+alsa-devel@lfdr.de
Delivered-To: lists+alsa-devel@lfdr.de
Received: from alsa0.perex.cz (alsa0.perex.cz [77.48.224.243])
	by mail.lfdr.de (Postfix) with ESMTPS id E0BCF1C03BC
	for <lists+alsa-devel@lfdr.de>; Thu, 30 Apr 2020 19:20:31 +0200 (CEST)
Received: from alsa1.perex.cz (alsa1.perex.cz [207.180.221.201])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by alsa0.perex.cz (Postfix) with ESMTPS id 68A711692;
	Thu, 30 Apr 2020 19:19:41 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa0.perex.cz 68A711692
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=alsa-project.org;
	s=default; t=1588267231;
	bh=ElQ5oZfTvWadhwEJAtHNn5zyEu1Wgizy+FgkC3PjrGo=;
	h=Date:From:To:Subject:In-Reply-To:References:Cc:List-Id:
	 List-Unsubscribe:List-Archive:List-Post:List-Help:List-Subscribe:
	 From;
	b=Ma1vJugnXknJpV8dcxmOfimICr1tA5WTLg+G2jsmPUpfyLY+IuUd0C2yirAzOOhiG
	 xoqVDrq8tZv5TUWsJAFHh/1h+ur5hC1DoNvqt3lXNgQl3SARyVCURYUZs3G3hr4OrS
	 SSFOEIZkAD0yZ264SvSH9e+MImtXcaVtl6lpCyP8=
Received: from alsa1.perex.cz (localhost.localdomain [127.0.0.1])
	by alsa1.perex.cz (Postfix) with ESMTP id 7BE6BF80136;
	Thu, 30 Apr 2020 19:18:50 +0200 (CEST)
X-Original-To: alsa-devel@alsa-project.org
Delivered-To: alsa-devel@alsa-project.org
Received: by alsa1.perex.cz (Postfix, from userid 50401)
 id 4C8CDF801DB; Thu, 30 Apr 2020 19:18:44 +0200 (CEST)
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on alsa1.perex.cz
X-Spam-Level: 
X-Spam-Status: No, score=0.0 required=5.0 tests=RCVD_IN_MSPIKE_H3,
 RCVD_IN_MSPIKE_WL,SPF_HELO_NONE,SPF_PASS,URIBL_BLOCKED autolearn=disabled
 version=3.4.0
Received: from mx2.suse.de (mx2.suse.de [195.135.220.15])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by alsa1.perex.cz (Postfix) with ESMTPS id 6BC1FF80123
 for <alsa-devel@alsa-project.org>; Thu, 30 Apr 2020 19:18:38 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa1.perex.cz 6BC1FF80123
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx2.suse.de (Postfix) with ESMTP id E00D8ABC2;
 Thu, 30 Apr 2020 17:18:36 +0000 (UTC)
Date: Thu, 30 Apr 2020 19:18:37 +0200
Message-ID: <s5hees4ki36.wl-tiwai@suse.de>
From: Takashi Iwai <tiwai@suse.de>
To: Dmitry Panchenko | d-Systems <dmitry@d-systems.ee>
Subject: Re: Pioneer DJ DJM-900NXS2 support patches
In-Reply-To: <b1f8414d-81d3-3f8b-e2c7-d536858d1bb6@d-systems.ee>
References: <b1f8414d-81d3-3f8b-e2c7-d536858d1bb6@d-systems.ee>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI/1.14.6 (Maruoka)
 FLIM/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL/10.8 Emacs/25.3
 (x86_64-suse-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Content-Type: text/plain; charset=US-ASCII
Cc: alsa-devel@alsa-project.org
X-BeenThere: alsa-devel@alsa-project.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: "Alsa-devel mailing list for ALSA developers -
 http://www.alsa-project.org" <alsa-devel.alsa-project.org>
List-Unsubscribe: <https://mailman.alsa-project.org/mailman/options/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=unsubscribe>
List-Archive: <http://mailman.alsa-project.org/pipermail/alsa-devel/>
List-Post: <mailto:alsa-devel@alsa-project.org>
List-Help: <mailto:alsa-devel-request@alsa-project.org?subject=help>
List-Subscribe: <https://mailman.alsa-project.org/mailman/listinfo/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=subscribe>
Errors-To: alsa-devel-bounces@alsa-project.org
Sender: "Alsa-devel" <alsa-devel-bounces@alsa-project.org>

On Wed, 29 Apr 2020 11:56:37 +0200,
Dmitry Panchenko | d-Systems wrote:
> 
> Pioneer DJ DJM-900NXS2 is a widely used DJ mixer with 2 audio USB
> interfaces. Both have a MIDI controller, 10 playback and 12 capture
> channels. Audio endpoints are vendor-specific and 3 files need to be
> patched. All playback and capture channels work fine with all
> supported sample rates (44.1k, 48k, 96k). Patches are attached.

Thanks for the patch.
The code changes look good in general.

Some nitpicking:

> --- /tmp/linux-5.4.0/sound/usb/pcm.c	2020-04-29 11:56:36.000000000 +0300
> +++ linux-5.4.0/sound/usb/pcm.c	2020-04-29 12:01:31.916954625 +0300
> @@ -355,6 +355,10 @@
>  	case USB_ID(0x0582, 0x01d8): /* BOSS Katana */
>  		/* BOSS Katana amplifiers do not need quirks */
>  		return 0;
> +	case USB_ID(0x2b73, 0x000a): /* Pioneer DJ DJM-900NXS2 */
> +		ep = 0x82;
> +		ifnum = 0;
> +		goto add_sync_ep_from_ifnum;

I'd put this entry before BOSS Katana, right after other
sync_ep_from_ifnum entries.

> --- /tmp/linux-5.4.0/sound/usb/quirks.c	2020-04-29 11:56:36.000000000 +0300
> +++ linux-5.4.0/sound/usb/quirks.c	2020-04-29 12:00:04.232521294 +0300
> @@ -1414,6 +1414,29 @@
>  	subs->pkt_offset_adj = (emu_samplerate_id >= EMU_QUIRK_SR_176400HZ) ? 4 : 0;
>  }
>  
> +
> +/* 
> + * Pioneer DJ DJM-900NXS2
> + * Device needs to know the sample rate when substream is started
> + */
> +static int pioneer_djm_set_format_quirk (struct snd_usb_substream *subs)
> +{
> +
> +    /* Convert sample rate to little endian */
> +	u8 sr[3];
> +	sr[0] = subs->cur_rate&0xff;
> +	sr[1] = (subs->cur_rate>>8)&0xff;
> +	sr[2] = (subs->cur_rate>>16)&0xff;

Some minor coding style issues (need space, remove space, use tab,
etc).  Please check once scripts/checkpatch.pl and try to fix the
errors.  The error in the quirk table format is known and can be left
as is, though.

> +	
> +	/* Configure device */
> +	usb_set_interface(subs->stream->chip->dev, 0, 1);

You can use subs->dev.

> +	snd_usb_ctl_msg(subs->stream->chip->dev,
> +	    usb_rcvctrlpipe(subs->stream->chip->dev, 0),
> +	    0x01, 0x22, 0x0100, 0x0082, &sr, 0x0003);
> +
> +	return 0;
> +}
> +
>  void snd_usb_set_format_quirk(struct snd_usb_substream *subs,
>  			      struct audioformat *fmt)
>  {
> @@ -1424,6 +1447,8 @@
>  	case USB_ID(0x041e, 0x3f19): /* E-Mu 0204 USB */
>  		set_format_emu_quirk(subs, fmt);
>  		break;
> +    case USB_ID(0x2b73, 0x000a): /* Pioneer DJ DJM-900NXS2 */
> +        pioneer_djm_set_format_quirk(subs);
break is missing here.

Could you address the problems above, and most importantly, give your
Signed-off-by line and resumit?  The SOB is mandatory for merging to
upstream.  See Documentation/process/submitting-patches.rst for
details.


thanks,

Takashi
