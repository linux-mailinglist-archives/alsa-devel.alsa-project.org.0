Return-Path: <alsa-devel-bounces@alsa-project.org>
X-Original-To: lists+alsa-devel@lfdr.de
Delivered-To: lists+alsa-devel@lfdr.de
Received: from alsa0.perex.cz (alsa0.perex.cz [77.48.224.243])
	by mail.lfdr.de (Postfix) with ESMTPS id DFBC73BE089
	for <lists+alsa-devel@lfdr.de>; Wed,  7 Jul 2021 03:20:50 +0200 (CEST)
Received: from alsa1.perex.cz (alsa1.perex.cz [207.180.221.201])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by alsa0.perex.cz (Postfix) with ESMTPS id 53E591664;
	Wed,  7 Jul 2021 03:20:00 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa0.perex.cz 53E591664
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=alsa-project.org;
	s=default; t=1625620850;
	bh=09qhqbmIC6o8o/qxx3N8q3BAGLqZE+6p6fo2HMFMoKE=;
	h=Date:From:To:Subject:In-Reply-To:References:Cc:List-Id:
	 List-Unsubscribe:List-Archive:List-Post:List-Help:List-Subscribe:
	 From;
	b=X62mIB6IEfZFpC6dXeSYzFr8KL1YecZGbRPlXZZ9zYdrXnMS6f4eRb7J1JgCnvtIZ
	 XCOBtOfSFaJK7zDWl24c9wdHPQ5pOnvvoCS9WgaBkW/9mkz+OCGRgkMKphFKHSW8me
	 HaXehfm8vHYR/jyaKGat/r8p8aOTNBJHmbZjP4Fw=
Received: from alsa1.perex.cz (localhost.localdomain [127.0.0.1])
	by alsa1.perex.cz (Postfix) with ESMTP id B68B9F80259;
	Wed,  7 Jul 2021 03:19:22 +0200 (CEST)
X-Original-To: alsa-devel@alsa-project.org
Delivered-To: alsa-devel@alsa-project.org
Received: by alsa1.perex.cz (Postfix, from userid 50401)
 id 68008F80249; Wed,  7 Jul 2021 03:19:20 +0200 (CEST)
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on alsa1.perex.cz
X-Spam-Level: 
X-Spam-Status: No, score=0.4 required=5.0 tests=KHOP_HELO_FCRDNS, SPF_HELO_NONE,
 SPF_NONE autolearn=disabled version=3.4.0
Received: from relmlie6.idc.renesas.com (relmlor2.renesas.com
 [210.160.252.172])
 by alsa1.perex.cz (Postfix) with ESMTP id E7A9EF80134
 for <alsa-devel@alsa-project.org>; Wed,  7 Jul 2021 03:19:13 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa1.perex.cz E7A9EF80134
Date: 07 Jul 2021 10:19:09 +0900
X-IronPort-AV: E=Sophos;i="5.83,330,1616425200"; d="scan'208";a="86756722"
Received: from unknown (HELO relmlir5.idc.renesas.com) ([10.200.68.151])
 by relmlie6.idc.renesas.com with ESMTP; 07 Jul 2021 10:19:09 +0900
Received: from mercury.renesas.com (unknown [10.166.252.133])
 by relmlir5.idc.renesas.com (Postfix) with ESMTP id A900640116A1;
 Wed,  7 Jul 2021 10:19:09 +0900 (JST)
Message-ID: <874kd63oqa.wl-kuninori.morimoto.gx@renesas.com>
From: Kuninori Morimoto <kuninori.morimoto.gx@renesas.com>
To: Robert Hancock <robert.hancock@calian.com>
Subject: Re: Issues using simple-audio-card driver with Xilinx Audio Formatter
In-Reply-To: <6c7635f59ea9b162999f060334eef48e0812534b.camel@calian.com>
References: <6c7635f59ea9b162999f060334eef48e0812534b.camel@calian.com>
User-Agent: Wanderlust/2.15.9 Emacs/26.3 Mule/6.0
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
Cc: "alsa-devel@alsa-project.org" <alsa-devel@alsa-project.org>,
 "lgirdwood@gmail.com" <lgirdwood@gmail.com>, "tiwai@suse.com" <tiwai@suse.com>,
 "broonie@kernel.org" <broonie@kernel.org>,
 "michal.simek@xilinx.com" <michal.simek@xilinx.com>
X-BeenThere: alsa-devel@alsa-project.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: "Alsa-devel mailing list for ALSA developers -
 http://www.alsa-project.org" <alsa-devel.alsa-project.org>
List-Unsubscribe: <https://mailman.alsa-project.org/mailman/options/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=unsubscribe>
List-Archive: <http://mailman.alsa-project.org/pipermail/alsa-devel/>
List-Post: <mailto:alsa-devel@alsa-project.org>
List-Help: <mailto:alsa-devel-request@alsa-project.org?subject=help>
List-Subscribe: <https://mailman.alsa-project.org/mailman/listinfo/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=subscribe>
Errors-To: alsa-devel-bounces@alsa-project.org
Sender: "Alsa-devel" <alsa-devel-bounces@alsa-project.org>


Hi Robert

Thank you for your reporting

> asoc-simple-card irxs-audio: parse error -22
> asoc-simple-card: probe of irxs-audio failed with error -22
(snip)
> Inside snd_soc_get_dai_name, snd_soc_component_of_xlate_dai_name is called and
> returns -ENOTSUPP, so we fall into the if block and end up failing out here:
> 
> 			if (id < 0 || id >= pos->num_dai) {
> 				ret = -EINVAL;
> 				continue;
> 			}

Platform support was added to simple-audio-card by someone (I forgot detail),
and I have never use it unfortunately.
But in my quick check, the purpose of asoc_simple_parse_platform() is
setup dlc->of_node

	asoc_simple_parse_dai(...)
	{
		...
=>		dlc->of_node = args.np;
		...
	}

and it will be checked at asoc_simple_canonicalize_platform()

	asoc_simple_canonicalize_platform(...)
	{
		/* Assumes platform == cpu */
=>		if (!dai_link->platforms->of_node)
=>			dai_link->platforms->of_node = dai_link->cpus->of_node;
		...
	}

and will be used at soc-core

(A)	soc_dai_link_sanity_check(...)
	{
		...
		for_each_link_platforms(link, i, platform) {
=>			if (!!platform->name == !!platform->of_node) {
		...
	}

	snd_soc_add_pcm_runtime(...)
	{
		...
(A)		ret = soc_dai_link_sanity_check();
		...

		for_each_link_cpus(dai_link, i, cpu) {
(X)			asoc_rtd_to_cpu(rtd, i) = snd_soc_find_dai(cpu);
			...
		}

		for_each_link_codecs(dai_link, i, codec) {
(X)			asoc_rtd_to_codec(rtd, i) = snd_soc_find_dai(codec);
			...
		}

		for_each_link_platforms(dai_link, i, platform) {
(Y)			for_each_component(component) {
=>				if (!snd_soc_is_matching_component(platform, component))
		...
	}

But, at snd_soc_add_pcm_runtime(),
CPU/Codec needs of_node and DAI name (= X)
Platform  needs of_node              (= Y)

So maybe (I didn't confirm) for platform,
asoc_simple_parse_dai() don't need to call snd_soc_of_get_dai_name() ?

Thank you for your help !!

Best regards
---
Kuninori Morimoto
