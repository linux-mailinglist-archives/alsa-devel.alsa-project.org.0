Return-Path: <alsa-devel-bounces@alsa-project.org>
X-Original-To: lists+alsa-devel@lfdr.de
Delivered-To: lists+alsa-devel@lfdr.de
Received: from alsa0.perex.cz (alsa0.perex.cz [77.48.224.243])
	by mail.lfdr.de (Postfix) with ESMTPS id E42873D7AE9
	for <lists+alsa-devel@lfdr.de>; Tue, 27 Jul 2021 18:28:13 +0200 (CEST)
Received: from alsa1.perex.cz (alsa1.perex.cz [207.180.221.201])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by alsa0.perex.cz (Postfix) with ESMTPS id 7A3751F1E;
	Tue, 27 Jul 2021 18:27:23 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa0.perex.cz 7A3751F1E
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=alsa-project.org;
	s=default; t=1627403293;
	bh=ncLIb0pDQ9E1DaOJSw7SUhiHEa5M2QpPcTru5VD2mIw=;
	h=Date:From:To:Subject:In-Reply-To:References:Cc:List-Id:
	 List-Unsubscribe:List-Archive:List-Post:List-Help:List-Subscribe:
	 From;
	b=vBRmeFnjSUECW0Oh/BQNDU/kaJomTdPGrzo97hDoOHzGcWOCEUn5lwTOe9AWlsoKQ
	 ZDuQSCT95o7djSi+WdgRVKddlz8smbh1jEedI3JMb7o7vs975uLzp5zl6bJ7bv8Oyi
	 9E96HMEaOVpXFjKVHnRQFdwqfODx0AEXXTS670Kw=
Received: from alsa1.perex.cz (localhost.localdomain [127.0.0.1])
	by alsa1.perex.cz (Postfix) with ESMTP id EAC66F80276;
	Tue, 27 Jul 2021 18:26:45 +0200 (CEST)
X-Original-To: alsa-devel@alsa-project.org
Delivered-To: alsa-devel@alsa-project.org
Received: by alsa1.perex.cz (Postfix, from userid 50401)
 id CAA32F8026C; Tue, 27 Jul 2021 18:26:43 +0200 (CEST)
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on alsa1.perex.cz
X-Spam-Level: 
X-Spam-Status: No, score=-0.1 required=5.0 tests=DKIM_SIGNED,DKIM_VALID,
 DKIM_VALID_AU,SPF_HELO_NONE,SPF_NONE autolearn=disabled version=3.4.0
Received: from smtp-out2.suse.de (smtp-out2.suse.de [195.135.220.29])
 (using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
 (No client certificate requested)
 by alsa1.perex.cz (Postfix) with ESMTPS id 5A815F80212
 for <alsa-devel@alsa-project.org>; Tue, 27 Jul 2021 18:26:39 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa1.perex.cz 5A815F80212
Authentication-Results: alsa1.perex.cz;
 dkim=pass (1024-bit key) header.d=suse.de header.i=@suse.de
 header.b="gmlMHDev"; 
 dkim=permerror (0-bit key) header.d=suse.de header.i=@suse.de
 header.b="fPi4NenG"
Received: from relay2.suse.de (relay2.suse.de [149.44.160.134])
 by smtp-out2.suse.de (Postfix) with ESMTP id B1F781FF23;
 Tue, 27 Jul 2021 16:26:39 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=suse.de; s=susede2_rsa;
 t=1627403199; h=from:from:reply-to:date:date:message-id:message-id:to:to:cc:cc:
 mime-version:mime-version:content-type:content-type:
 in-reply-to:in-reply-to:references:references;
 bh=42qKF4A2qLSGbB3CAsnihdhJ6MJoy7ETPDv2arcMvEM=;
 b=gmlMHDev9Tz+ZTv7wSsxqE74HYbKiJBhMVdv7Ps0LbGluOJ8FFhhtJcOO3umMOn8wYCfa4
 Q6xLZNE34n5QKzkO7YRyI6awD3HdI4eckWn1aUmmZBFtV2tgastN7HvzVGx9oF1W7wdXwI
 TejqmzLgkT4P1D1xX2YYaZSgm1smxTg=
DKIM-Signature: v=1; a=ed25519-sha256; c=relaxed/relaxed; d=suse.de;
 s=susede2_ed25519; t=1627403199;
 h=from:from:reply-to:date:date:message-id:message-id:to:to:cc:cc:
 mime-version:mime-version:content-type:content-type:
 in-reply-to:in-reply-to:references:references;
 bh=42qKF4A2qLSGbB3CAsnihdhJ6MJoy7ETPDv2arcMvEM=;
 b=fPi4NenG5vvFYdlafcicCTPHY5PKCfacrxfekTNkzS9LbL+wHz1Xl0fe3NCHoejPf1WSvK
 rMttUrYaLV2DrmAA==
Received: from alsa1.suse.de (alsa1.suse.de [10.160.4.42])
 by relay2.suse.de (Postfix) with ESMTP id D2A6DA3BA7;
 Tue, 27 Jul 2021 16:26:38 +0000 (UTC)
Date: Tue, 27 Jul 2021 18:26:38 +0200
Message-ID: <s5h35rzd8ox.wl-tiwai@suse.de>
From: Takashi Iwai <tiwai@suse.de>
To: Alex Roberts <arob109@gmail.com>
Subject: Re: ASoC/ALSA Out of Memory Issue
In-Reply-To: <CAPkENw_qS2fgP02RAJgoQHM1ROoio6Km5=bGPhi2R+h4vJQ79w@mail.gmail.com>
References: <CAPkENw_qS2fgP02RAJgoQHM1ROoio6Km5=bGPhi2R+h4vJQ79w@mail.gmail.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI/1.14.6 (Maruoka)
 FLIM/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL/10.8 Emacs/25.3
 (x86_64-suse-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Content-Type: text/plain; charset=US-ASCII
Cc: alsa-devel@alsa-project.org, kernelnewbies@kernelnewbies.org
X-BeenThere: alsa-devel@alsa-project.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: "Alsa-devel mailing list for ALSA developers -
 http://www.alsa-project.org" <alsa-devel.alsa-project.org>
List-Unsubscribe: <https://mailman.alsa-project.org/mailman/options/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=unsubscribe>
List-Archive: <http://mailman.alsa-project.org/pipermail/alsa-devel/>
List-Post: <mailto:alsa-devel@alsa-project.org>
List-Help: <mailto:alsa-devel-request@alsa-project.org?subject=help>
List-Subscribe: <https://mailman.alsa-project.org/mailman/listinfo/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=subscribe>
Errors-To: alsa-devel-bounces@alsa-project.org
Sender: "Alsa-devel" <alsa-devel-bounces@alsa-project.org>

On Mon, 26 Jul 2021 17:07:52 +0200,
Alex Roberts wrote:
> 
> Hello,
> 
> I am developing a dummy codec to interface with an 8-channel, 24-bit
> ADC. I've got it working on an NXP imx8m through the fsl_sai driver on
> kernel 5.4.85. I can capture all 8 channels at varying sample rates
> using arecord, and I've verified correct data capture via opening the
> resulting .wav file in Audacity. The problem I am having is that
> occasionally, upon starting arecord - after a fresh power cycle - I
> get an out of memory error. Other times I get an out of memory after a
> non-deterministic period of capture. Starting capture again also
> reports out of memory, but if I wait several minutes and start capture
> it will start recording again. A power cycle usually helps, but as
> stated earlier, not 100% of the time.

Do you mean that application gets -ENOMEM error from API, or the
system exhausts the memory?  The former is often some buffer
management issue (e.g. the buffer perallocation didn't happen and yet
the dynamic allocation failed), but the latter is rather about the
memory leaks.


Takashi

> I'm trying to track down where the oom error is coming from, but
> haven't had much luck. My colleague tried running arecord with
> valgrind to check for memory leaks and nothing of note was observed.
> My suspicion is there's something going on with allocated memory for
> DMA, like fragmentation starts to happen and it can't get a contiguous
> region for operation. Reserving a larger pool - either via device tree
> or kernel cmdline arguments in the bootoader - did not seem to help.
> 
> Another thought is that it's a boundary/alignment issue due to the
> 24-bit data, and the error is the result of trying to allocate a chunk
> of memory for DMA that doesn't align.
> 
> I'm very new to ALSA dev with some exposure to kernel dev in general,
> so please correct me if I'm wrong or completely mis-understanding
> something.
> 
> Any suggestions on where I should / how I can debug this memory error?
> 
> Thanks,
> Alex.
> 
> PS: Previously sent this to just alsa-devel mailing list on 7/21, but
> never saw it show up in the archives. Here is more info since then:
> 
> The goal is 8-channel, 96k sampling rate. I've reduced sampling rate
> and still have the issue. Reducing down to 4-channels helps, but
> haven't tested long term enough to evaluate by how much.
> 
> Narrowed it down to device_prep_dma_cyclic(..) returning NULL within
> dmaengine_prep_dma_cyclic(..)..... still tracing through source to
> learn exactly what is going on.
> 
