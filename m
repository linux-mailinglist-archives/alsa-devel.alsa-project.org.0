Return-Path: <alsa-devel-bounces@alsa-project.org>
X-Original-To: lists+alsa-devel@lfdr.de
Delivered-To: lists+alsa-devel@lfdr.de
Received: from alsa0.perex.cz (alsa0.perex.cz [77.48.224.243])
	by mail.lfdr.de (Postfix) with ESMTPS id 8DBF53571EF
	for <lists+alsa-devel@lfdr.de>; Wed,  7 Apr 2021 18:12:10 +0200 (CEST)
Received: from alsa1.perex.cz (alsa1.perex.cz [207.180.221.201])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by alsa0.perex.cz (Postfix) with ESMTPS id 15C8D851;
	Wed,  7 Apr 2021 18:11:20 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa0.perex.cz 15C8D851
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=alsa-project.org;
	s=default; t=1617811930;
	bh=jAwd0t8ZPSlfjrmB1ZCS6Z2y+BNiqi64jFZ1YW2cIvo=;
	h=Date:From:To:Subject:In-Reply-To:References:Cc:List-Id:
	 List-Unsubscribe:List-Archive:List-Post:List-Help:List-Subscribe:
	 From;
	b=S/c1XsfCkR/xYkLRpRt1TyD7NeP4uldbBS+siGMQCBuoBYvIbDYX7TcbHrFP/yvkF
	 uF3LE9HEe2Y6/6yev6ffZBBarQaB9EPIHx8ELVEaiO8Q73jAw8tcPQspq8mIj8BHcS
	 COeDsaRAKQxNgKO2aHhurUCJP6gImLqS6gNbbqIQ=
Received: from alsa1.perex.cz (localhost.localdomain [127.0.0.1])
	by alsa1.perex.cz (Postfix) with ESMTP id 92CE7F80162;
	Wed,  7 Apr 2021 18:10:43 +0200 (CEST)
X-Original-To: alsa-devel@alsa-project.org
Delivered-To: alsa-devel@alsa-project.org
Received: by alsa1.perex.cz (Postfix, from userid 50401)
 id B4744F80168; Wed,  7 Apr 2021 18:10:41 +0200 (CEST)
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on alsa1.perex.cz
X-Spam-Level: 
X-Spam-Status: No, score=0.0 required=5.0 tests=SPF_HELO_NONE,SPF_NONE,
 URIBL_BLOCKED autolearn=disabled version=3.4.0
Received: from mx2.suse.de (mx2.suse.de [195.135.220.15])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by alsa1.perex.cz (Postfix) with ESMTPS id 53234F800BD
 for <alsa-devel@alsa-project.org>; Wed,  7 Apr 2021 18:10:31 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa1.perex.cz 53234F800BD
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.221.27])
 by mx2.suse.de (Postfix) with ESMTP id 97470B1AE;
 Wed,  7 Apr 2021 16:10:31 +0000 (UTC)
Date: Wed, 07 Apr 2021 18:10:31 +0200
Message-ID: <s5hr1jm8494.wl-tiwai@suse.de>
From: Takashi Iwai <tiwai@suse.de>
To: Kai Vehmanen <kai.vehmanen@linux.intel.com>
Subject: Re: [RFC PATCH] ALSA: hda/hdmi: fix race in handling acomp ELD
 notification at resume
In-Reply-To: <20210407154727.589017-1-kai.vehmanen@linux.intel.com>
References: <20210407154727.589017-1-kai.vehmanen@linux.intel.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI/1.14.6 (Maruoka)
 FLIM/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL/10.8 Emacs/25.3
 (x86_64-suse-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Content-Type: text/plain; charset=US-ASCII
Cc: alsa-devel@alsa-project.org, pierre-louis.bossart@linux.intel.com
X-BeenThere: alsa-devel@alsa-project.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: "Alsa-devel mailing list for ALSA developers -
 http://www.alsa-project.org" <alsa-devel.alsa-project.org>
List-Unsubscribe: <https://mailman.alsa-project.org/mailman/options/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=unsubscribe>
List-Archive: <http://mailman.alsa-project.org/pipermail/alsa-devel/>
List-Post: <mailto:alsa-devel@alsa-project.org>
List-Help: <mailto:alsa-devel-request@alsa-project.org?subject=help>
List-Subscribe: <https://mailman.alsa-project.org/mailman/listinfo/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=subscribe>
Errors-To: alsa-devel-bounces@alsa-project.org
Sender: "Alsa-devel" <alsa-devel-bounces@alsa-project.org>

On Wed, 07 Apr 2021 17:47:27 +0200,
Kai Vehmanen wrote:
> 
> When snd-hda-codec-hdmi is used with ASoC HDA controller like SOF (acomp
> used for ELD notifications), display connection change done during suspend,
> can be lost due to following sequence of events:
> 
>   1. system in S3 suspend
>   2. DP/HDMI receiver connected
>   3. system resumed
>   4. HDA controller resumed, but card->deferred_resume_work not complete
>   5. acomp eld_notify callback
>   6. eld_notify ignored as power state is not CTL_POWER_D0
>   7. HDA resume deferred work completed, power state set to CTL_POWER_D0
> 
> This results in losing the notification, and the jack state reported to
> user-space is not correct.

Hrm, that's odd.  The logic there is: there is a manual call of
hdmi_present_sense() for each pin in the resume call back of HDMI
codec driver, so at the point 7, update_eld() is invoked from
hdmi_present_sense(), which notifies the state to user-space.

So I don't see what's missing there.  Could you check whether the
scenario above is correct?  The state is updated in
snd_hdac_acomp_get_eld() call in sync_eld_via_acomp().  We can see
what state is returned there at which timing.

The only possible case I can think of now is that the graphics driver
isn't ready for returning the right value at the HDMI codec resume.
But this should have been covered by the device link...


thanks,

Takashi

> The check on step 6 was added in commit 8ae743e82f0b ("ALSA: hda - Skip
> ELD notification during system suspend"). It would seem with the deferred
> resume logic in ASoC core, this check is not safe.
> 
> Fix the issue by modifying the check to only skip ELD notification
> processing if power state is D3 or deeper. This helps in the ASoC
> controller case as card power state is set to D2 at start of
> soc_resume_deferred().
> 
> BugLink: https://github.com/thesofproject/linux/issues/2825
> Signed-off-by: Kai Vehmanen <kai.vehmanen@linux.intel.com>
> ---
>  sound/pci/hda/patch_hdmi.c | 4 ++--
>  1 file changed, 2 insertions(+), 2 deletions(-)
> 
> NOTES:
>  - I wonder if there is a better way to check for system suspend
>    case than looking at snd_power_get_state()
>  - 'chip->pm_prepared' is one option, but this is not directly available
>    to codec drivers
>  - storing PM target is hda_codec_pm_prepare() is perhaps one option
> 
> diff --git a/sound/pci/hda/patch_hdmi.c b/sound/pci/hda/patch_hdmi.c
> index 5de3666a7101..a43df036db1d 100644
> --- a/sound/pci/hda/patch_hdmi.c
> +++ b/sound/pci/hda/patch_hdmi.c
> @@ -2654,7 +2654,7 @@ static void generic_acomp_pin_eld_notify(void *audio_ptr, int port, int dev_id)
>  	/* skip notification during system suspend (but not in runtime PM);
>  	 * the state will be updated at resume
>  	 */
> -	if (snd_power_get_state(codec->card) != SNDRV_CTL_POWER_D0)
> +	if (snd_power_get_state(codec->card) >= SNDRV_CTL_POWER_D3)
>  		return;
>  	/* ditto during suspend/resume process itself */
>  	if (snd_hdac_is_in_pm(&codec->core))
> @@ -2840,7 +2840,7 @@ static void intel_pin_eld_notify(void *audio_ptr, int port, int pipe)
>  	/* skip notification during system suspend (but not in runtime PM);
>  	 * the state will be updated at resume
>  	 */
> -	if (snd_power_get_state(codec->card) != SNDRV_CTL_POWER_D0)
> +	if (snd_power_get_state(codec->card) >= SNDRV_CTL_POWER_D3)
>  		return;
>  	/* ditto during suspend/resume process itself */
>  	if (snd_hdac_is_in_pm(&codec->core))
> 
> base-commit: 7dc53a38e4ac00d68943bab91deadc67f07d4a0b
> -- 
> 2.31.0
> 
