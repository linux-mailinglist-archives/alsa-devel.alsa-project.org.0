Return-Path: <alsa-devel-bounces@alsa-project.org>
X-Original-To: lists+alsa-devel@lfdr.de
Delivered-To: lists+alsa-devel@lfdr.de
Received: from alsa0.perex.cz (alsa0.perex.cz [77.48.224.243])
	by mail.lfdr.de (Postfix) with ESMTPS id AF1A427F609
	for <lists+alsa-devel@lfdr.de>; Thu,  1 Oct 2020 01:30:32 +0200 (CEST)
Received: from alsa1.perex.cz (alsa1.perex.cz [207.180.221.201])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by alsa0.perex.cz (Postfix) with ESMTPS id 7C7EC17B4;
	Thu,  1 Oct 2020 01:29:41 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa0.perex.cz 7C7EC17B4
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=alsa-project.org;
	s=default; t=1601508631;
	bh=hNsuFQX1K+8wg0nlUNaxIM0TenoClYeCEbdE1yM1dHM=;
	h=Date:From:To:Subject:In-Reply-To:References:Cc:List-Id:
	 List-Unsubscribe:List-Archive:List-Post:List-Help:List-Subscribe:
	 From;
	b=GEPuTz4jxtqgXRblXFhwIzrbgQOK9Sld+AJmc+c7U/1Txcjnz+VUpywzDCq2jtiDD
	 U11YwijZgKZKL4xPaPCv+AOBpNHaVzRNeSHSte8oh4OnilVBC4CVtRQmUq6J3G2yoj
	 AFVuwR98b11IrzZAGqry8d9N/yySKII8rhSgts9c=
Received: from alsa1.perex.cz (localhost.localdomain [127.0.0.1])
	by alsa1.perex.cz (Postfix) with ESMTP id A4848F801F9;
	Thu,  1 Oct 2020 01:28:50 +0200 (CEST)
X-Original-To: alsa-devel@alsa-project.org
Delivered-To: alsa-devel@alsa-project.org
Received: by alsa1.perex.cz (Postfix, from userid 50401)
 id AB9DFF801ED; Thu,  1 Oct 2020 01:28:46 +0200 (CEST)
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on alsa1.perex.cz
X-Spam-Level: 
X-Spam-Status: No, score=0.0 required=5.0 tests=SPF_HELO_NONE,SPF_PASS,
 URIBL_BLOCKED autolearn=disabled version=3.4.0
Received: from relmlie5.idc.renesas.com (relmlor1.renesas.com
 [210.160.252.171])
 by alsa1.perex.cz (Postfix) with ESMTP id 123F5F800DF
 for <alsa-devel@alsa-project.org>; Thu,  1 Oct 2020 01:28:37 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa1.perex.cz 123F5F800DF
Date: 01 Oct 2020 08:28:33 +0900
X-IronPort-AV: E=Sophos;i="5.77,322,1596466800"; d="scan'208";a="58602614"
Received: from unknown (HELO relmlir5.idc.renesas.com) ([10.200.68.151])
 by relmlie5.idc.renesas.com with ESMTP; 01 Oct 2020 08:28:33 +0900
Received: from mercury.renesas.com (unknown [10.166.252.133])
 by relmlir5.idc.renesas.com (Postfix) with ESMTP id ACF024002C28;
 Thu,  1 Oct 2020 08:28:33 +0900 (JST)
Message-ID: <87v9fualv7.wl-kuninori.morimoto.gx@renesas.com>
From: Kuninori Morimoto <kuninori.morimoto.gx@renesas.com>
To: Marek Szyprowski <m.szyprowski@samsung.com>
Subject: Re: [PATCH 5/7] ASoC: soc-pcm: add soc_pcm_clean() and call it from
 soc_pcm_open/close()
In-Reply-To: <1fa68abd-a86c-7a29-6c28-9ecde75ab4c6@samsung.com>
References: <87mu1abwp2.wl-kuninori.morimoto.gx@renesas.com>
 <87ft72bwn4.wl-kuninori.morimoto.gx@renesas.com>
 <CGME20200929130814eucas1p1c09e7e1fe2d808d9bd41718cadf33754@eucas1p1.samsung.com>
 <1fa68abd-a86c-7a29-6c28-9ecde75ab4c6@samsung.com>
User-Agent: Wanderlust/2.15.9 Emacs/26.3 Mule/6.0
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: quoted-printable
Cc: 'Linux Samsung SOC' <linux-samsung-soc@vger.kernel.org>,
 Linux-ALSA <alsa-devel@alsa-project.org>, Mark Brown <broonie@kernel.org>,
 Krzysztof Kozlowski <krzk@kernel.org>
X-BeenThere: alsa-devel@alsa-project.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: "Alsa-devel mailing list for ALSA developers -
 http://www.alsa-project.org" <alsa-devel.alsa-project.org>
List-Unsubscribe: <https://mailman.alsa-project.org/mailman/options/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=unsubscribe>
List-Archive: <http://mailman.alsa-project.org/pipermail/alsa-devel/>
List-Post: <mailto:alsa-devel@alsa-project.org>
List-Help: <mailto:alsa-devel-request@alsa-project.org?subject=help>
List-Subscribe: <https://mailman.alsa-project.org/mailman/listinfo/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=subscribe>
Errors-To: alsa-devel-bounces@alsa-project.org
Sender: "Alsa-devel" <alsa-devel-bounces@alsa-project.org>


Hi Marek

Thank you for testing.
I will check it

> On 28.09.2020 02:01, Kuninori Morimoto wrote:
> > From: Kuninori Morimoto <kuninori.morimoto.gx@renesas.com>
> >
> > soc_pcm_open() does rollback when failed (A),
> > but, it is almost same as soc_pcm_close().
> >
> > 	static int soc_pcm_open(xxx)
> > 	{
> > 		...
> > 		if (ret < 0)
> > 			goto xxx_err;
> > 		...
> > 		return 0;
> >
> >   ^	config_err:
> >   |		...
> >   |	rtd_startup_err:
> > (A)		...
> >   |	component_err:
> >   |		...
> >   v		return ret;
> > 	}
> >
> > The difference is
> > soc_pcm_close() is for all dai/component/substream,
> > rollback        is for succeeded part only.
> >
> > This kind of duplicated code can be a hotbed of bugs,
> > thus, we want to share soc_pcm_close() and rollback.
> >
> > Now, soc_pcm_open/close() are handling
> > 	1) snd_soc_dai_startup/shutdown()
> > 	2) snd_soc_link_startup/shutdown()
> > 	3) snd_soc_component_module_get/put()
> > 	4) snd_soc_component_open/close()
> > 	5) pm_runtime_put/get()
> >
> > Now, 1) to 5) are handled.
> > This patch adds new soc_pcm_clean() and call it from
> > soc_pcm_open() as rollback, and from soc_pcm_close() as
> > normal close handler.
> >
> > One note here is that it don't need to call snd_soc_runtime_deactivate()
> > when rollback case, because it will be called without
> > snd_soc_runtime_activate().
> > It also don't need to call snd_soc_dapm_stream_stop() when rollback cas=
e.
> >
> > Signed-off-by: Kuninori Morimoto <kuninori.morimoto.gx@renesas.com>
>=20
> This patch landed in linux next-20200929 as commit 140a4532cdb8 ("ASoC:=20
> soc-pcm: add soc_pcm_clean() and call it from soc_pcm_open/close()").=20
> Sadly it causes a regression in ALSA operation on my various test=20
> boards: Exynos4412 based Trats2, Exynos5410 based Odroid XU, Exynos5250=20
> Snow Chromebook and other. The first app, which tries to open ALSA=20
> device fails. Then, on the second try, it work.
>=20
> Here is a log from Odroid XU:
>=20
> [=A0=A0=A0 3.775032] max98090 1-0010: MAX98090 REVID=3D0x43
> [=A0=A0=A0 3.781958] max98090 1-0010: use default 2.8v micbias
> [=A0=A0=A0 3.812813] ALSA device list:
> [=A0=A0=A0 3.814448]=A0=A0 #0: Odroid-XU
>=20
> # speaker-test -l1
>=20
> speaker-test 1.1.3
>=20
> Playback device is default
> Stream parameters are 48000Hz, S16_LE, 1 channels
> Using 16 octaves of pink noise
> Playback open error: -22,Invalid argument
> # speaker-test -l1
>=20
> speaker-test 1.1.3
>=20
> Playback device is default
> Stream parameters are 48000Hz, S16_LE, 1 channels
> Using 16 octaves of pink noise
> Rate set to 48000Hz (requested 48000Hz)
> Buffer size range from 128 to 131072
> Period size range from 64 to 65536
> Using max buffer size 131072
> Periods =3D 4
> was set period_size =3D 32768
> was set buffer_size =3D 131072
>  =A00 - Front Left
> Time per period =3D 0.029512
> #
>=20
>  > ...
>=20
> Best regards
> --=20
> Marek Szyprowski, PhD
> Samsung R&D Institute Poland
>=20
