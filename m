Return-Path: <alsa-devel-bounces@alsa-project.org>
X-Original-To: lists+alsa-devel@lfdr.de
Delivered-To: lists+alsa-devel@lfdr.de
Received: from alsa0.perex.cz (alsa0.perex.cz [77.48.224.243])
	by mail.lfdr.de (Postfix) with ESMTPS id C162A10C412
	for <lists+alsa-devel@lfdr.de>; Thu, 28 Nov 2019 07:41:21 +0100 (CET)
Received: from alsa1.perex.cz (alsa1.perex.cz [207.180.221.201])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by alsa0.perex.cz (Postfix) with ESMTPS id 4826D1697;
	Thu, 28 Nov 2019 07:40:31 +0100 (CET)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa0.perex.cz 4826D1697
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=alsa-project.org;
	s=default; t=1574923281;
	bh=Heizq9K6CXNIPMzDCvkKRf+Ty8eWF1XzFWy9QQX8xUE=;
	h=Date:From:To:In-Reply-To:References:Cc:Subject:List-Id:
	 List-Unsubscribe:List-Archive:List-Post:List-Help:List-Subscribe:
	 From;
	b=fXOLpWU9ErgjQy9xdsaNX6GL4dZryLOdLolyCx3Tltak7iFJbyS6MwrJJHq/yTpS3
	 LmV/0kWx3Wkb2EgKfsWe6uZwGzczI1UAEsVDe+vdiqikXK3MI4NPB07B+FhvAZyhln
	 zTriHRE/zPWv36ViQZt9sm01B2z5s41sTCwmhloI=
Received: from alsa1.perex.cz (localhost.localdomain [127.0.0.1])
	by alsa1.perex.cz (Postfix) with ESMTP id B0085F80159;
	Thu, 28 Nov 2019 07:39:37 +0100 (CET)
X-Original-To: alsa-devel@alsa-project.org
Delivered-To: alsa-devel@alsa-project.org
Received: by alsa1.perex.cz (Postfix, from userid 50401)
 id 97392F80149; Thu, 28 Nov 2019 07:39:35 +0100 (CET)
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on alsa1.perex.cz
X-Spam-Level: 
X-Spam-Status: No, score=0.0 required=5.0 tests=SPF_HELO_NONE,SPF_PASS,
 URIBL_BLOCKED autolearn=disabled version=3.4.0
Received: from mx1.suse.de (mx2.suse.de [195.135.220.15])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by alsa1.perex.cz (Postfix) with ESMTPS id 9C15EF800CB
 for <alsa-devel@alsa-project.org>; Thu, 28 Nov 2019 07:39:32 +0100 (CET)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa1.perex.cz 9C15EF800CB
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id DF213B25C;
 Thu, 28 Nov 2019 06:39:30 +0000 (UTC)
Date: Thu, 28 Nov 2019 07:39:30 +0100
Message-ID: <s5hlfs0ld25.wl-tiwai@suse.de>
From: Takashi Iwai <tiwai@suse.de>
To: Curtis Malainey <cujomalainey@chromium.org>
In-Reply-To: <20191128011358.39234-1-cujomalainey@chromium.org>
References: <20191128011358.39234-1-cujomalainey@chromium.org>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI/1.14.6 (Maruoka)
 FLIM/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL/10.8 Emacs/25.3
 (x86_64-suse-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Cc: alsa-devel@alsa-project.org, Mark Brown <broonie@kernel.org>,
 Takashi Iwai <tiwai@suse.com>, Liam Girdwood <lgirdwood@gmail.com>
Subject: Re: [alsa-devel] [PATCH] ASoC: core: only flush inited work during
	free
X-BeenThere: alsa-devel@alsa-project.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: "Alsa-devel mailing list for ALSA developers -
 http://www.alsa-project.org" <alsa-devel.alsa-project.org>
List-Unsubscribe: <https://mailman.alsa-project.org/mailman/options/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=unsubscribe>
List-Archive: <http://mailman.alsa-project.org/pipermail/alsa-devel/>
List-Post: <mailto:alsa-devel@alsa-project.org>
List-Help: <mailto:alsa-devel-request@alsa-project.org?subject=help>
List-Subscribe: <https://mailman.alsa-project.org/mailman/listinfo/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=subscribe>
Content-Type: text/plain; charset="us-ascii"
Content-Transfer-Encoding: 7bit
Errors-To: alsa-devel-bounces@alsa-project.org
Sender: "Alsa-devel" <alsa-devel-bounces@alsa-project.org>

On Thu, 28 Nov 2019 02:13:58 +0100,
Curtis Malainey wrote:
> 
> There are many paths to soc_free_pcm_runtime which can both have and
> have not yet inited the workqueue yet. When we flush the queue when we
> have not yet inited the queue we cause warnings to be printed.
> 
> An example is soc_cleanup_card_resources which is called by
> snd_soc_bind_card which has multiple failure points before and after
> soc_link_init -> soc_new_pcm which is where the queue is inited.
> 
> Signed-off-by: Curtis Malainey <cujomalainey@chromium.org>

This patch itself isn't wrong, but there is a generic problem in the
current code in general.  Many fields in snd_soc_pcm_runtime object,
not only delayed_work, are initialized too late where
soc_free_pcm_runtime() may be called beforehand.  For example,
rtd->component_list is initialized after the error path of
rtd->codec_dais kmalloc, although soc_free_pcm_runtime() has a loop
over the link.

That said, at least the things like the linked list head and the work
struct must be initialized right after the allocation before any use
of the object.

For this delayed_work, the situation is a bit complex, though.
Usually the work is set up to point to a fixed function, but in the
case of ASoC, it seems serving for different purposes depending on the
component type.  I guess the cleaner way would be a redirect call
like:

static void rtd_delayed_work(struct work_struct *work)
{
	struct snd_soc_pcm_runtime *rtd =
		container_of(work, struct snd_soc_pcm_runtime, delayed_work.work);
	if (rtd->delayed_work_fn)
		rtd->delayed_work_fn(rtd);
}

static struct snd_soc_pcm_runtime *soc_new_pcm_runtime()
{
	....
	INIT_DELAYED_WORK(&rtd->delayed_work, rtd_delayed_work);
	....
}


thanks,

Takashi
_______________________________________________
Alsa-devel mailing list
Alsa-devel@alsa-project.org
https://mailman.alsa-project.org/mailman/listinfo/alsa-devel
