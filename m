Return-Path: <alsa-devel-bounces@alsa-project.org>
X-Original-To: lists+alsa-devel@lfdr.de
Delivered-To: lists+alsa-devel@lfdr.de
Received: from alsa0.perex.cz (alsa0.perex.cz [77.48.224.243])
	by mail.lfdr.de (Postfix) with ESMTPS id 246693431A7
	for <lists+alsa-devel@lfdr.de>; Sun, 21 Mar 2021 09:23:35 +0100 (CET)
Received: from alsa1.perex.cz (alsa1.perex.cz [207.180.221.201])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by alsa0.perex.cz (Postfix) with ESMTPS id B00E982A;
	Sun, 21 Mar 2021 09:22:44 +0100 (CET)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa0.perex.cz B00E982A
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=alsa-project.org;
	s=default; t=1616315014;
	bh=s72ByO2SMw8izCmk9F+GmXuHqjtftumBPqQNEwzTXE4=;
	h=Date:From:To:Subject:In-Reply-To:References:Cc:List-Id:
	 List-Unsubscribe:List-Archive:List-Post:List-Help:List-Subscribe:
	 From;
	b=oBgL2+CYFLgB+v63TAVZ9uiWHvc3Q6vSGYe95HCs4Jzldx1lGaRhKgbeMmC28+SXJ
	 PUDP5XHsEej1Uko9bT6qKtaELl7L7NQ2ntjkcv5YgAArFpyAQzCH7otFDPNzDnT4Ot
	 F9Ajh7AQKzyiwGaP3DwsdC4ZWbCMud6oZ7KzLPOA=
Received: from alsa1.perex.cz (localhost.localdomain [127.0.0.1])
	by alsa1.perex.cz (Postfix) with ESMTP id 17964F80155;
	Sun, 21 Mar 2021 09:22:11 +0100 (CET)
X-Original-To: alsa-devel@alsa-project.org
Delivered-To: alsa-devel@alsa-project.org
Received: by alsa1.perex.cz (Postfix, from userid 50401)
 id 93295F80254; Sun, 21 Mar 2021 09:22:08 +0100 (CET)
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on alsa1.perex.cz
X-Spam-Level: 
X-Spam-Status: No, score=0.0 required=5.0 tests=SPF_HELO_NONE,SPF_NONE
 autolearn=disabled version=3.4.0
Received: from mx2.suse.de (mx2.suse.de [195.135.220.15])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by alsa1.perex.cz (Postfix) with ESMTPS id 132F5F80155
 for <alsa-devel@alsa-project.org>; Sun, 21 Mar 2021 09:22:05 +0100 (CET)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa1.perex.cz 132F5F80155
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.221.27])
 by mx2.suse.de (Postfix) with ESMTP id 910C1AD38;
 Sun, 21 Mar 2021 08:22:00 +0000 (UTC)
Date: Sun, 21 Mar 2021 09:22:00 +0100
Message-ID: <s5hsg4oex1z.wl-tiwai@suse.de>
From: Takashi Iwai <tiwai@suse.de>
To: Geraldo <geraldogabriel@gmail.com>
Subject: Re: Pioneer DJ DDJ-SR2 sound degradation
In-Reply-To: <CAEsQvcsePyrd3Xs4hTUmkxzk84nodL40ytGgjM-66SOgv5ybjw@mail.gmail.com>
References: <CAEsQvctXrHLXK-oz6Zb38t1D28krqUCf73jMU-QJw=i66KZe8g@mail.gmail.com>
 <CAEsQvcsePyrd3Xs4hTUmkxzk84nodL40ytGgjM-66SOgv5ybjw@mail.gmail.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI/1.14.6 (Maruoka)
 FLIM/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL/10.8 Emacs/25.3
 (x86_64-suse-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit
Cc: alsa-devel@alsa-project.org
X-BeenThere: alsa-devel@alsa-project.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: "Alsa-devel mailing list for ALSA developers -
 http://www.alsa-project.org" <alsa-devel.alsa-project.org>
List-Unsubscribe: <https://mailman.alsa-project.org/mailman/options/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=unsubscribe>
List-Archive: <http://mailman.alsa-project.org/pipermail/alsa-devel/>
List-Post: <mailto:alsa-devel@alsa-project.org>
List-Help: <mailto:alsa-devel-request@alsa-project.org?subject=help>
List-Subscribe: <https://mailman.alsa-project.org/mailman/listinfo/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=subscribe>
Errors-To: alsa-devel-bounces@alsa-project.org
Sender: "Alsa-devel" <alsa-devel-bounces@alsa-project.org>

On Sun, 21 Mar 2021 05:31:11 +0100,
Geraldo wrote:
> 
> Until we manage to engage implicit feedback sync for Pioneer gear I'm
> afraid the clock will drift on DUPLEX mode.
> 
> I reread the Pioneer related source code and implicit feedback sync was
> disabled because it gave Incompatible EP Setup messages. I should know, I
> was a reporter on that regression.
> 
> Only those messages are fake. They arise because our ALSA code it's not
> honoring .ep_attr on quirks-table.h specifically in regards to
> USB_ENDPOINT_USAGE_IMPLICIT_FB.

That's right.  The parser reads from the original descriptor, not the
one from the quirk table.  That is, the implicit fb quirk has to be
declared explicitly in another quirk table.  And, the implicit fb is
skipped for those devices because they didn't work; see
sound/usb/implicit.c.

> In fact the new improved implicit feedback sync code inside pcm.c that sets
> sync upon probe is failing to set implicit_fb to 1. I commented the
> conditional for testing and I told endpoint_compatible to always return
> true.
> 
> VoilÃ , JACK started in duplex mode without nasty Incompatible EP Setup
> problems and supposedly with implicit feedback sync on. We are not setting
> bits 5..7 of bmAttributes, at least that's what I get from the missing
> Usage field in lsusb.
> 
> My JACK transport has been rolling for 17 minutes and if it goes for two
> complete hours without distortion passing-thru vinyl on Mixxxx I'll provide
> the list with a more elegant PATCH and not this gambiarra as we say on
> Brazil.
> 
> Hopefully their will be implicit feedback sync for Pioneer :-)

I know there are quite a few users with Pioneer devices around here,
so let's hope that they can test the implicit feedback things and find
the culprit of the buggy behavior.  Unfortunately it's quite hard to
debug such a thing remotely without the hardware from my side.


Takashi


> 
> 
> On Thu, Mar 18, 2021 at 7:41 PM Geraldo <geraldogabriel@gmail.com> wrote:
> >
> > Hi everyone,
> >
> > I'm running stable kernel 5.11.6 together with my Pioneer DJ DDJ-SR2 and
> JACK. Mixxx is running on top of JACK.
> >
> >
> > After I start JACK I have about 40 minutes of good sound quality from the
> inputs. After this period the sound will begin to degrade slowly until it
> is almost pure distortion.
> >
> > The issue is gone if I restart the JACK server, no need to reboot the
> hardware. The description I gave above sounds a lot like soundcard clock
> drift (which happens to those using more than one soundcard. You know)
> which motivates me to believe we missed a bug somewhere around the recent
> changes introduced in implicit feedback sync for Pioneer devices
> >
> > Dyndbg shows nothing useful I guess. No xruns reported.
> >
> > I've recorded a 1KHz tone and after 50+ minutes the sound degradation
> kicks in. Only problem is even after cutting and encoding to mp3 128kbps
> it's still a 10 megabytes file. I suppose I could post it to Soundcloud or
> Mixcloud if anyone is interested.
> >
> > Is anyone else experiencing these symptoms with Pioneer hardware? Note
> that the sound degradation kicks in after about an hour, more or less, and
> it's for the inputs only. Outputs continue to operate fine without the need
> to restart the JACK server every hour.
> >
> > Thanks everybody,
> > Geraldo
> 
