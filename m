Return-Path: <alsa-devel-bounces@alsa-project.org>
X-Original-To: lists+alsa-devel@lfdr.de
Delivered-To: lists+alsa-devel@lfdr.de
Received: from alsa0.perex.cz (alsa0.perex.cz [77.48.224.243])
	by mail.lfdr.de (Postfix) with ESMTPS id A19C55D3B8
	for <lists+alsa-devel@lfdr.de>; Tue,  2 Jul 2019 17:58:56 +0200 (CEST)
Received: from alsa1.perex.cz (alsa1.perex.cz [207.180.221.201])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by alsa0.perex.cz (Postfix) with ESMTPS id 3A2C116A8;
	Tue,  2 Jul 2019 17:58:06 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa0.perex.cz 3A2C116A8
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=alsa-project.org;
	s=default; t=1562083136;
	bh=xE5PB6aPoAPY+QSCvFMyUCSaqsV1nCNzP74cpfnN9Y4=;
	h=Date:From:To:In-Reply-To:References:Cc:Subject:List-Id:
	 List-Unsubscribe:List-Archive:List-Post:List-Help:List-Subscribe:
	 From;
	b=fAiAjOzjRLZYTlFYpxoFxtqtLROAXavLK01RJtkH0Y3Y5diKSqmUXT6axj/pwekyb
	 T6l7oA7DWvR8sdKgG8Dwp5uMvnYBM0SerlpBxF9MT1IxIvSpfqj62ga6Q3LmSO3LUa
	 2Jd6IbPBuQwpPe5mO+lmpDDjQo17p1fdIyHEEz8k=
Received: from alsa1.perex.cz (localhost.localdomain [127.0.0.1])
	by alsa1.perex.cz (Postfix) with ESMTP id 6EEC4F800D1;
	Tue,  2 Jul 2019 17:57:12 +0200 (CEST)
X-Original-To: alsa-devel@alsa-project.org
Delivered-To: alsa-devel@alsa-project.org
Received: by alsa1.perex.cz (Postfix, from userid 50401)
 id 1D77EF800C9; Tue,  2 Jul 2019 17:57:11 +0200 (CEST)
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on alsa1.perex.cz
X-Spam-Level: 
X-Spam-Status: No, score=0.0 required=5.0 tests=SPF_HELO_NONE,SPF_PASS,
 URIBL_BLOCKED autolearn=disabled version=3.4.0
Received: from mx1.suse.de (mx2.suse.de [195.135.220.15])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by alsa1.perex.cz (Postfix) with ESMTPS id 46FA2F800C1
 for <alsa-devel@alsa-project.org>; Tue,  2 Jul 2019 17:57:07 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa1.perex.cz 46FA2F800C1
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 0AE7FB169;
 Tue,  2 Jul 2019 15:57:07 +0000 (UTC)
Date: Tue, 02 Jul 2019 17:57:06 +0200
Message-ID: <s5ha7dw4egd.wl-tiwai@suse.de>
From: Takashi Iwai <tiwai@suse.de>
To: "Wasko, Michal" <michal.wasko@linux.intel.com>
In-Reply-To: <4181a467-5332-c256-5124-513a0343ec70@linux.intel.com>
References: <20190702004439.30131-1-nick83ola@gmail.com>
 <s5hlfxg4i4r.wl-tiwai@suse.de>
 <4181a467-5332-c256-5124-513a0343ec70@linux.intel.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI/1.14.6 (Maruoka)
 FLIM/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL/10.8 Emacs/25.3
 (x86_64-suse-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Cc: alsa-devel@alsa-project.org, info@jensverwiebe.de,
 Greg Kroah-Hartman <gregkh@linuxfoundation.org>, linux-kernel@vger.kernel.org,
 Richard Fontana <rfontana@redhat.com>, Jussi Laako <jussi@sonarnerd.net>,
 Nicola Lunghi <nick83ola@gmail.com>, Thomas Gleixner <tglx@linutronix.de>,
 Allison Randal <allison@lohutok.net>
Subject: Re: [alsa-devel] [PATCH] ALSA: usb-audio: fix Line6 Helix audio
	format rates
X-BeenThere: alsa-devel@alsa-project.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: "Alsa-devel mailing list for ALSA developers -
 http://www.alsa-project.org" <alsa-devel.alsa-project.org>
List-Unsubscribe: <https://mailman.alsa-project.org/mailman/options/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=unsubscribe>
List-Archive: <http://mailman.alsa-project.org/pipermail/alsa-devel/>
List-Post: <mailto:alsa-devel@alsa-project.org>
List-Help: <mailto:alsa-devel-request@alsa-project.org?subject=help>
List-Subscribe: <https://mailman.alsa-project.org/mailman/listinfo/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=subscribe>
Content-Type: text/plain; charset="us-ascii"
Content-Transfer-Encoding: 7bit
Errors-To: alsa-devel-bounces@alsa-project.org
Sender: "Alsa-devel" <alsa-devel-bounces@alsa-project.org>

On Tue, 02 Jul 2019 17:52:01 +0200,
Wasko, Michal wrote:
> 
> On 7/2/2019 4:37 PM, Takashi Iwai wrote:
> > On Tue, 02 Jul 2019 02:43:14 +0200,
> > Nicola Lunghi wrote:
> >> Line6 Helix and HX stomp don't support retrieving
> >> the number of clock sample rate.
> >>
> >> Add a quirk to return the default value of 48Khz.
> >>
> >> Signed-off-by: Nicola Lunghi <nick83ola@gmail.com>
> > It's not particularly good place to put a quirk, but there seems no
> > other better place, unfortunately.  Is this specific to certain unit
> > or all I/Os on the device suffer from this problem?
> >
> > In anyway, if the behavior is expected, we don't need to use
> > dev_warn() to annoy users unnecessarily.  Replace it with dev_info().
> >
> > Also, the code that creates a single 48k entry would be better to be
> > put into a function for readability.
> >
> > Could you resubmit with that change?
> >
> >
> > Thanks!
> >
> > Takashi
> 
> If the listed USB devices do not support sample rate format retrieval
> then maybe it would be a better idea to perform below check before
> sending message?

Yes, if we know that it always fails, we don't need to query.

> Have you also considered new function or macro that check device
> support? This would separate formatfunctionality code from routine
> that identifies applicable devices- in case if in future more devices
> will require quirk.

The split can be done later.  It's always hard to know what kind of
quirk would be needed in future.  If any more devices show the same
problem, we can reorganize the quirk in a saner way.


thanks,

Takashi

> 
> Michal W.
> 
> >> ---
> >>   sound/usb/format.c | 28 +++++++++++++++++++++++++---
> >>   1 file changed, 25 insertions(+), 3 deletions(-)
> >>
> >> diff --git a/sound/usb/format.c b/sound/usb/format.c
> >> index c02b51a82775..05442f6ada62 100644
> >> --- a/sound/usb/format.c
> >> +++ b/sound/usb/format.c
> >> @@ -313,10 +313,32 @@ static int parse_audio_format_rates_v2v3(struct snd_usb_audio *chip,
> >>   			      tmp, sizeof(tmp));
> >>     	if (ret < 0) {
> >> -		dev_err(&dev->dev,
> >> -			"%s(): unable to retrieve number of sample rates (clock %d)\n",
> >> +		switch (chip->usb_id) {
> >> +		/* LINE 6 HX pedals don't support getting the clock sample rate.
> >> +		 * Set the framerate to 48khz by default
> >> +		 */
> >> +		case USB_ID(0x0E41, 0x4244): /* HELIX */
> >> +		case USB_ID(0x0E41, 0x4246): /* HX STOMP */
> >> +			dev_warn(&dev->dev,
> >> +				"%s(): line6 helix: unable to retrieve number of sample rates. Set it to default value (clock %d).\n",
> >>   				__func__, clock);
> >> -		goto err;
> >> +			fp->nr_rates = 1;
> >> +			fp->rate_min = 48000;
> >> +			fp->rate_max = 48000;
> >> +			fp->rates = SNDRV_PCM_RATE_48000;
> >> +			fp->rate_table = kmalloc(sizeof(int), GFP_KERNEL);
> >> +			if (!fp->rate_table) {
> >> +				ret = -ENOMEM;
> >> +				goto err_free;
> >> +			}
> >> +			fp->rate_table[0] = 48000;
> >> +			return 0;
> >> +		default:
> >> +			dev_err(&dev->dev,
> >> +				"%s(): unable to retrieve number of sample rates (clock %d)\n",
> >> +					__func__, clock);
> >> +			goto err;
> >> +		}
> >>   	}
> >>     	nr_triplets = (tmp[1] << 8) | tmp[0];
> >> -- 
> >> 2.19.1
> >>
> >>
> > _______________________________________________
> > Alsa-devel mailing list
> > Alsa-devel@alsa-project.org
> > https://mailman.alsa-project.org/mailman/listinfo/alsa-devel
> >
> 
_______________________________________________
Alsa-devel mailing list
Alsa-devel@alsa-project.org
https://mailman.alsa-project.org/mailman/listinfo/alsa-devel
