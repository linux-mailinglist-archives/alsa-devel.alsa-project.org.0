Return-Path: <alsa-devel-bounces@alsa-project.org>
X-Original-To: lists+alsa-devel@lfdr.de
Delivered-To: lists+alsa-devel@lfdr.de
Received: from alsa0.perex.cz (alsa0.perex.cz [77.48.224.243])
	by mail.lfdr.de (Postfix) with ESMTPS id 804482E8349
	for <lists+alsa-devel@lfdr.de>; Fri,  1 Jan 2021 08:59:44 +0100 (CET)
Received: from alsa1.perex.cz (alsa1.perex.cz [207.180.221.201])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by alsa0.perex.cz (Postfix) with ESMTPS id 077F51738;
	Fri,  1 Jan 2021 08:58:49 +0100 (CET)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa0.perex.cz 077F51738
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=alsa-project.org;
	s=default; t=1609487979;
	bh=Fch/Nzfv62kEp23BAOEtJJmOfV8bZGPmh2hlHrp+b0U=;
	h=Date:From:To:Subject:In-Reply-To:References:Cc:List-Id:
	 List-Unsubscribe:List-Archive:List-Post:List-Help:List-Subscribe:
	 From;
	b=GeTGjSWYdBrCquWb1vaNMrkKjimO8aJ99oyV+jCKlBHZb/KhOU/ka+BkUtuNFlWEC
	 Oc2UGyZ2N0pXhv6bxvPNoXXX00oPciOdNemGRBtLqdh/JYSufizeX67Xr4+2FEzx1R
	 y74SzI+1q7AYXLJ+5SFBNRha7hsdQVIeCgFI6XsE=
Received: from alsa1.perex.cz (localhost.localdomain [127.0.0.1])
	by alsa1.perex.cz (Postfix) with ESMTP id 57198F8020B;
	Fri,  1 Jan 2021 08:58:05 +0100 (CET)
X-Original-To: alsa-devel@alsa-project.org
Delivered-To: alsa-devel@alsa-project.org
Received: by alsa1.perex.cz (Postfix, from userid 50401)
 id 80C7AF801F5; Fri,  1 Jan 2021 08:58:02 +0100 (CET)
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on alsa1.perex.cz
X-Spam-Level: 
X-Spam-Status: No, score=0.0 required=5.0 tests=SPF_HELO_NONE,SPF_NONE
 autolearn=disabled version=3.4.0
Received: from mx2.suse.de (mx2.suse.de [195.135.220.15])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by alsa1.perex.cz (Postfix) with ESMTPS id 34302F8015F
 for <alsa-devel@alsa-project.org>; Fri,  1 Jan 2021 08:57:56 +0100 (CET)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa1.perex.cz 34302F8015F
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.221.27])
 by mx2.suse.de (Postfix) with ESMTP id 8C6E2AD09;
 Fri,  1 Jan 2021 07:57:56 +0000 (UTC)
Date: Fri, 01 Jan 2021 08:57:56 +0100
Message-ID: <s5hczypay2j.wl-tiwai@suse.de>
From: Takashi Iwai <tiwai@suse.de>
To: "Jan Alexander Steffens (heftig)" <heftig@archlinux.org>
Subject: Re: [PATCH v2] ALSA: hda/hdmi: fix silent stream for first playback
 to DP
In-Reply-To: <f9e278f822e97c6698a04ab848beed279fb793dd.camel@archlinux.org>
References: <20201210174445.3134104-1-kai.vehmanen@linux.intel.com>
 <f9e278f822e97c6698a04ab848beed279fb793dd.camel@archlinux.org>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI/1.14.6 (Maruoka)
 FLIM/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL/10.8 Emacs/25.3
 (x86_64-suse-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit
Cc: Harsha Priya <harshapriya.n@intel.com>,
 Emmanuel Jillela <emmanuel.jillela@intel.com>, alsa-devel@alsa-project.org,
 Kai Vehmanen <kai.vehmanen@linux.intel.com>
X-BeenThere: alsa-devel@alsa-project.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: "Alsa-devel mailing list for ALSA developers -
 http://www.alsa-project.org" <alsa-devel.alsa-project.org>
List-Unsubscribe: <https://mailman.alsa-project.org/mailman/options/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=unsubscribe>
List-Archive: <http://mailman.alsa-project.org/pipermail/alsa-devel/>
List-Post: <mailto:alsa-devel@alsa-project.org>
List-Help: <mailto:alsa-devel-request@alsa-project.org?subject=help>
List-Subscribe: <https://mailman.alsa-project.org/mailman/listinfo/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=subscribe>
Errors-To: alsa-devel-bounces@alsa-project.org
Sender: "Alsa-devel" <alsa-devel-bounces@alsa-project.org>

On Fri, 01 Jan 2021 06:15:42 +0100,
Jan Alexander Steffens (heftig) wrote:
> 
> On Thu, 2020-12-10 at 19:44 +0200, Kai Vehmanen wrote:
> > +static void silent_stream_disable(struct hda_codec *codec,
> > +                                 struct hdmi_spec_per_pin *per_pin)
> > +{
> > +       struct hdmi_spec *spec = codec->spec;
> > +       struct hdmi_spec_per_cvt *per_cvt;
> > +       int cvt_idx;
> > +
> > +       mutex_lock(&per_pin->lock);
> > +       if (!per_pin->silent_stream)
> > +               goto unlock_out;
> > +
> > +       codec_dbg(codec, "HDMI: disable silent stream on pin-NID=0x%x
> > cvt-NID=0x%x\n",
> > +                 per_pin->pin_nid, per_pin->cvt_nid);
> > +
> > +       cvt_idx = cvt_nid_to_cvt_index(codec, per_pin->cvt_nid);
> > +       if (cvt_idx >= 0 && cvt_idx < spec->num_cvts) {
> > +               per_cvt = get_cvt(spec, cvt_idx);
> > +               per_cvt->assigned = 0;
> > +       }
> > +
> > +       per_pin->cvt_nid = 0;
> > +       per_pin->silent_stream = false;
> > +
> > + unlock_out:
> > +       mutex_unlock(&spec->pcm_lock);
> 
> Shouldn't this be `mutex_unlock(&per_pin->lock);`?

Oh yes, obviously.

> I'm experiencing deadlocks since 5.10.4, which backported this patch.

Could you check whether correcting the unlock fixes the problem?


thanks,

Takashi
