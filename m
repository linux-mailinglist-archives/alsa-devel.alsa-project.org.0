Return-Path: <alsa-devel-bounces@alsa-project.org>
X-Original-To: lists+alsa-devel@lfdr.de
Delivered-To: lists+alsa-devel@lfdr.de
Received: from alsa0.perex.cz (alsa0.perex.cz [77.48.224.243])
	by mail.lfdr.de (Postfix) with ESMTPS id A9F474350B8
	for <lists+alsa-devel@lfdr.de>; Wed, 20 Oct 2021 18:53:32 +0200 (CEST)
Received: from alsa1.perex.cz (alsa1.perex.cz [207.180.221.201])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by alsa0.perex.cz (Postfix) with ESMTPS id 2B9C516BA;
	Wed, 20 Oct 2021 18:52:42 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa0.perex.cz 2B9C516BA
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=alsa-project.org;
	s=default; t=1634748812;
	bh=vaPH4MVgmY8HxvguAmDDbnQYc1hvSIu2ofLem4erExc=;
	h=Date:From:To:Subject:In-Reply-To:References:Cc:List-Id:
	 List-Unsubscribe:List-Archive:List-Post:List-Help:List-Subscribe:
	 From;
	b=reCaamZ31l3VIUi25/qwTdaT8FA3HJlB+cMGgAQJDQF+KDlkTZgpAdYEPvA5aNjZ3
	 k2nkcc+jZWwgQlcFCPmhEqvVfFUIP3DMssiKnGU6MewLwnJrk3mzxfFVNh4kWmyYT6
	 +cxqH01XEdfkLiy+4MKLzu/s3+VepHKXo1LopoWk=
Received: from alsa1.perex.cz (localhost.localdomain [127.0.0.1])
	by alsa1.perex.cz (Postfix) with ESMTP id AA451F80229;
	Wed, 20 Oct 2021 18:52:36 +0200 (CEST)
X-Original-To: alsa-devel@alsa-project.org
Delivered-To: alsa-devel@alsa-project.org
Received: by alsa1.perex.cz (Postfix, from userid 50401)
 id 47E81F802E0; Wed, 20 Oct 2021 18:52:34 +0200 (CEST)
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on alsa1.perex.cz
X-Spam-Level: 
X-Spam-Status: No, score=-0.1 required=5.0 tests=DKIM_SIGNED,DKIM_VALID,
 DKIM_VALID_AU,SPF_HELO_NONE,SPF_NONE,URIBL_BLOCKED autolearn=disabled
 version=3.4.0
Received: from smtp-out1.suse.de (smtp-out1.suse.de [195.135.220.28])
 (using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
 (No client certificate requested)
 by alsa1.perex.cz (Postfix) with ESMTPS id AB308F80224
 for <alsa-devel@alsa-project.org>; Wed, 20 Oct 2021 18:52:27 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa1.perex.cz AB308F80224
Authentication-Results: alsa1.perex.cz;
 dkim=pass (1024-bit key) header.d=suse.de header.i=@suse.de
 header.b="OzTgPb+H"; 
 dkim=permerror (0-bit key) header.d=suse.de header.i=@suse.de
 header.b="TiVTIqst"
Received: from relay2.suse.de (relay2.suse.de [149.44.160.134])
 by smtp-out1.suse.de (Postfix) with ESMTP id E863821965;
 Wed, 20 Oct 2021 16:52:26 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=suse.de; s=susede2_rsa;
 t=1634748746; h=from:from:reply-to:date:date:message-id:message-id:to:to:cc:cc:
 mime-version:mime-version:content-type:content-type:
 in-reply-to:in-reply-to:references:references;
 bh=wrRshsfFMHPhi2yObW6vfz1kW3pBMoZozxib/dHQHUk=;
 b=OzTgPb+HuZwKBGHLKIg6wn+HIz+ilc5HAo5b90RWWUnoZynnEvmGpJiaIMjakx3ilzBcyL
 74FAvwVOC6F2Q83gTeXSe7hPMpPzWG6L8Qq10i2QpyfJZyO/0f7eVK1i9pEnxu8lIavSxh
 l1zItGeoypg09Ivm5kwL9DPCDr9cZZw=
DKIM-Signature: v=1; a=ed25519-sha256; c=relaxed/relaxed; d=suse.de;
 s=susede2_ed25519; t=1634748746;
 h=from:from:reply-to:date:date:message-id:message-id:to:to:cc:cc:
 mime-version:mime-version:content-type:content-type:
 in-reply-to:in-reply-to:references:references;
 bh=wrRshsfFMHPhi2yObW6vfz1kW3pBMoZozxib/dHQHUk=;
 b=TiVTIqstTIryN6goDGDSGJhMGVM1lMVdlGQOnTWBZtndl+YW5IeQ9t04k4V9nAopBtn7yi
 GTFAZlYvLdAApVCQ==
Received: from alsa1.suse.de (alsa1.suse.de [10.160.4.42])
 by relay2.suse.de (Postfix) with ESMTP id E1174A3B81;
 Wed, 20 Oct 2021 16:52:26 +0000 (UTC)
Date: Wed, 20 Oct 2021 18:52:26 +0200
Message-ID: <s5h5ytrzlit.wl-tiwai@suse.de>
From: Takashi Iwai <tiwai@suse.de>
To: sanekf@nxt.ru
Subject: Re: WC vs UC mappings in snd_dma_sg_alloc()
In-Reply-To: <493661634654791@mail.yandex.ru>
References: <493661634654791@mail.yandex.ru>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI/1.14.6 (Maruoka)
 FLIM/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL/10.8 Emacs/25.3
 (x86_64-suse-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Content-Type: text/plain; charset=US-ASCII
Cc: alsa-devel@alsa-project.org, Mark Brown <broonie@kernel.org>,
 Takashi Iwai <tiwai@suse.com>, linux-kernel@vger.kernel.org
X-BeenThere: alsa-devel@alsa-project.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: "Alsa-devel mailing list for ALSA developers -
 http://www.alsa-project.org" <alsa-devel.alsa-project.org>
List-Unsubscribe: <https://mailman.alsa-project.org/mailman/options/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=unsubscribe>
List-Archive: <http://mailman.alsa-project.org/pipermail/alsa-devel/>
List-Post: <mailto:alsa-devel@alsa-project.org>
List-Help: <mailto:alsa-devel-request@alsa-project.org?subject=help>
List-Subscribe: <https://mailman.alsa-project.org/mailman/listinfo/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=subscribe>
Errors-To: alsa-devel-bounces@alsa-project.org
Sender: "Alsa-devel" <alsa-devel-bounces@alsa-project.org>

On Tue, 19 Oct 2021 17:03:08 +0200,
sanekf@nxt.ru wrote:
> 
> Hi
> 
> I've stumbled across this code in sound/core/sgbuf.c:
> 
> 66 static void *snd_dma_sg_alloc(struct snd_dma_buffer *dmab, size_t size)
> 67 {
> < ... >
> 80 	if (dmab->dev.type == SNDRV_DMA_TYPE_DEV_WC_SG) {
> 81 		type = SNDRV_DMA_TYPE_DEV_WC;
> 82 #ifdef pgprot_noncached
> 83 		prot = pgprot_noncached(PAGE_KERNEL);
> 84 #endif
> 85 	}
> < ... >
> 131 	area = vmap(sgbuf->page_table, sgbuf->pages, VM_MAP, prot);
> 
> Does not this violate x86 rules about using the same memory mapping type for all mappings? It seems that the following patch should fix it (only compile tested - my x86 PCs are either without Linux or without sound, and probably in practice this might not trigger any problems since both WC and UC-minus are incoherent types):

Actually this has been already fixed in the latest code for 5.16
together with the rewriting of the SG buffer code.  There, sgbuf.c is
gone completely, and this inconsistency was resolved, too.


thanks,

Takashi

> 
> -----------------------------
> 
> ALSA: memalloc: duly use pgprot_writecombine() for WC mapping
> 
> x86 has strict rules about not having memory type aliasing (Documentation/x86/pat.rst). snd_dma_sg_alloc() violates them by mapping first as WC (with set_memory_wc()) and then as UC- (with pgprot_noncached() + vmap()). Switching to pgprot_writecombine() should fix this.
> 
> Signed-off-by: Aleksandr Fedorov <halcien@gmail.com>
> diff --git a/sound/core/sgbuf.c b/sound/core/sgbuf.c
> index 8352a5cdb19f..670b30c3b6e5 100644
> --- a/sound/core/sgbuf.c
> +++ b/sound/core/sgbuf.c
> @@ -79,9 +79,7 @@ static void *snd_dma_sg_alloc(struct snd_dma_buffer *dmab, size_t size)
>  		return NULL;
>  	if (dmab->dev.type == SNDRV_DMA_TYPE_DEV_WC_SG) {
>  		type = SNDRV_DMA_TYPE_DEV_WC;
> -#ifdef pgprot_noncached
> -		prot = pgprot_noncached(PAGE_KERNEL);
> -#endif
> +		prot = pgprot_writecombine(PAGE_KERNEL);
>  	}
>  	sgbuf->dev = dmab->dev.dev;
>  	pages = snd_sgbuf_aligned_pages(size);
> 
