Return-Path: <alsa-devel-bounces@alsa-project.org>
X-Original-To: lists+alsa-devel@lfdr.de
Delivered-To: lists+alsa-devel@lfdr.de
Received: from alsa0.perex.cz (alsa0.perex.cz [77.48.224.243])
	by mail.lfdr.de (Postfix) with ESMTPS id C2131347BB5
	for <lists+alsa-devel@lfdr.de>; Wed, 24 Mar 2021 16:08:32 +0100 (CET)
Received: from alsa1.perex.cz (alsa1.perex.cz [207.180.221.201])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by alsa0.perex.cz (Postfix) with ESMTPS id 5FB49165D;
	Wed, 24 Mar 2021 16:07:42 +0100 (CET)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa0.perex.cz 5FB49165D
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=alsa-project.org;
	s=default; t=1616598512;
	bh=2y0H8+WbPuWwSgk8jMWps3spXMdcPuTqQhnluEr49gU=;
	h=Date:From:To:Subject:In-Reply-To:References:Cc:List-Id:
	 List-Unsubscribe:List-Archive:List-Post:List-Help:List-Subscribe:
	 From;
	b=E9sYi+BxkrdKJi/ZBBlWbZJJ8BgE0/hE1/B99M7I1xyMqEw4o4TITpRjTK9X8fVVu
	 rLKo03hRNLx9ywTD1ne3tuhrAor0d1bWMDpxt6nGvNLmkT2qtD3lF6uObe+BMDy5uS
	 I+BjT1fjDikM20fxsAvzZINR5jRvDOoqGJpfadTE=
Received: from alsa1.perex.cz (localhost.localdomain [127.0.0.1])
	by alsa1.perex.cz (Postfix) with ESMTP id B94DBF801D5;
	Wed, 24 Mar 2021 16:07:06 +0100 (CET)
X-Original-To: alsa-devel@alsa-project.org
Delivered-To: alsa-devel@alsa-project.org
Received: by alsa1.perex.cz (Postfix, from userid 50401)
 id 18225F8016B; Wed, 24 Mar 2021 16:07:05 +0100 (CET)
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on alsa1.perex.cz
X-Spam-Level: *
X-Spam-Status: No, score=1.0 required=5.0 tests=PRX_BODY_30,SPF_HELO_NONE,
 SPF_NONE autolearn=disabled version=3.4.0
Received: from mx2.suse.de (mx2.suse.de [195.135.220.15])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by alsa1.perex.cz (Postfix) with ESMTPS id A5B09F80104
 for <alsa-devel@alsa-project.org>; Wed, 24 Mar 2021 16:06:53 +0100 (CET)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa1.perex.cz A5B09F80104
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.221.27])
 by mx2.suse.de (Postfix) with ESMTP id 727D0AD9F;
 Wed, 24 Mar 2021 15:06:48 +0000 (UTC)
Date: Wed, 24 Mar 2021 16:06:48 +0100
Message-ID: <s5heeg4oak7.wl-tiwai@suse.de>
From: Takashi Iwai <tiwai@suse.de>
To: Andrey Grodzovsky <andrey.grodzovsky@amd.com>
Subject: Re: Adding movable PCIe BARs support in snd_hda_intel
In-Reply-To: <d9bc41d7-bbad-24e3-6ad3-90e6dd8466c4@amd.com>
References: <e25017c6-e5e4-7a24-e793-14a2e70a434e@amd.com>
 <fe61113f-5b8e-53a0-23fc-65246eb08ac3@amd.com>
 <s5hwntyaylg.wl-tiwai@suse.de>
 <ca35a9c1-82d8-8be6-21e7-b5242a2d884c@amd.com>
 <s5him5hc443.wl-tiwai@suse.de>
 <30b36220-ff0f-d04c-1fca-349b3ff3a19b@amd.com>
 <s5h8s6dbyr1.wl-tiwai@suse.de>
 <9758cd4c-1246-a4ab-74eb-0e060248a00b@amd.com>
 <s5h35wlbwye.wl-tiwai@suse.de>
 <06b2dae2-a5ea-0cc8-891f-2aaff64ae260@amd.com>
 <s5hv99gan2r.wl-tiwai@suse.de>
 <d9bc41d7-bbad-24e3-6ad3-90e6dd8466c4@amd.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI/1.14.6 (Maruoka)
 FLIM/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL/10.8 Emacs/25.3
 (x86_64-suse-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Content-Type: text/plain; charset=US-ASCII
Cc: "Alexander.Deucher@amd.com" <Alexander.Deucher@amd.com>,
 alsa-devel@alsa-project.org,
 Sergei Miroshnichenko <s.miroshnichenko@yadro.com>,
 "Christian.Koenig@amd.com" <Christian.Koenig@amd.com>
X-BeenThere: alsa-devel@alsa-project.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: "Alsa-devel mailing list for ALSA developers -
 http://www.alsa-project.org" <alsa-devel.alsa-project.org>
List-Unsubscribe: <https://mailman.alsa-project.org/mailman/options/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=unsubscribe>
List-Archive: <http://mailman.alsa-project.org/pipermail/alsa-devel/>
List-Post: <mailto:alsa-devel@alsa-project.org>
List-Help: <mailto:alsa-devel-request@alsa-project.org?subject=help>
List-Subscribe: <https://mailman.alsa-project.org/mailman/listinfo/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=subscribe>
Errors-To: alsa-devel-bounces@alsa-project.org
Sender: "Alsa-devel" <alsa-devel-bounces@alsa-project.org>

On Wed, 24 Mar 2021 15:53:33 +0100,
Andrey Grodzovsky wrote:
> 
> Appreciate you investing the effort in helping on this.
> I will start to merge it now as it doesn't apply cleanly on my branch.
> 
> If I understand correctly your main HW access prevention mechanism during
> the PCI prepare-rescan period is by bailing out on IOCTLs with the check
> of power state == SNDRV_CTL_POWER_D0 or waiting when a user process closes
> it's device file descriptor in patches 2 and 5. For command submission
> prevention you use the freeze flag from patch 6.
> If I haven't missed anything I don't see how those all protect when
> new device is plugged while any of those operations are already in
> flight. What prevents concurrent HW access from an IOCTL already
> running
> and HW suspend and MMIO unampping in rescan_preapre which starts after
> IOCTL began ?

The call of snd_pcm_suspend_all() is the key.  That puts all PCM
streams in the stopped and suspended state.  And the codec devices as
well as the controller device will be put into the suspended state.
So, for the PCM side, this should be fine with it, I guess.

However, after sending the patches, I noticed that they won't suffice
for the pending control calls.  For the control get/put callbacks that
have been pending before setting the power_state=D3hot, they would
still kick off the runtime PM and bad things may happen.  Due to that,
the bus.frozen flag won't work reliably, I'm afraid.

So, in that part, we need the code to sync the execution of the
pending get/put calls in addition.  Maybe refcounting the control
ioctls that are involved with get/put calls
(SNDRV_CTL_IOCTL_ELEM_READ, _WRITE, maybe with _TLV_READ, too) and
wait for those ioctls finishing before actually starting the codec
suspend procedure.


Takashi
