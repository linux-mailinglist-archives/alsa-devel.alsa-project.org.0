Return-Path: <alsa-devel-bounces@alsa-project.org>
X-Original-To: lists+alsa-devel@lfdr.de
Delivered-To: lists+alsa-devel@lfdr.de
Received: from alsa0.perex.cz (alsa0.perex.cz [77.48.224.243])
	by mail.lfdr.de (Postfix) with ESMTPS id BF8F14A49BE
	for <lists+alsa-devel@lfdr.de>; Mon, 31 Jan 2022 15:58:21 +0100 (CET)
Received: from alsa1.perex.cz (alsa1.perex.cz [207.180.221.201])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by alsa0.perex.cz (Postfix) with ESMTPS id 3890F163E;
	Mon, 31 Jan 2022 15:57:31 +0100 (CET)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa0.perex.cz 3890F163E
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=alsa-project.org;
	s=default; t=1643641101;
	bh=Ay5Mz4UpyVWGep4iCGOhA6D5zPPQi9+Ekgx1QGom00o=;
	h=Date:From:To:Subject:In-Reply-To:References:Cc:List-Id:
	 List-Unsubscribe:List-Archive:List-Post:List-Help:List-Subscribe:
	 From;
	b=iH1pA1pAkB3F0j6IcEjDCkrBO4iatP4jKiB8XAhA06fjn3CGfDQfvo4newpqNv7BL
	 2Hegj48FyN+SukpEnbiZeqmv7BUaCRyl/R34E/IS47kRwx2tNGW/G3MjaFKpoXIDaf
	 +zl0GkEJd2rpcHSaH82Je5WJEddB9XK/XuN54P/w=
Received: from alsa1.perex.cz (localhost.localdomain [127.0.0.1])
	by alsa1.perex.cz (Postfix) with ESMTP id 8E075F80302;
	Mon, 31 Jan 2022 15:57:15 +0100 (CET)
X-Original-To: alsa-devel@alsa-project.org
Delivered-To: alsa-devel@alsa-project.org
Received: by alsa1.perex.cz (Postfix, from userid 50401)
 id 05FC2F8028B; Mon, 31 Jan 2022 15:57:14 +0100 (CET)
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on alsa1.perex.cz
X-Spam-Level: 
X-Spam-Status: No, score=0.9 required=5.0 tests=DKIM_SIGNED,DKIM_VALID,
 DKIM_VALID_AU,PRX_BODY_30,SPF_HELO_NONE,SPF_NONE autolearn=disabled
 version=3.4.0
Received: from smtp-out2.suse.de (smtp-out2.suse.de [195.135.220.29])
 (using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
 (No client certificate requested)
 by alsa1.perex.cz (Postfix) with ESMTPS id 08902F800CE
 for <alsa-devel@alsa-project.org>; Mon, 31 Jan 2022 15:57:05 +0100 (CET)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa1.perex.cz 08902F800CE
Authentication-Results: alsa1.perex.cz;
 dkim=pass (1024-bit key) header.d=suse.de header.i=@suse.de
 header.b="w3IaXZzw"; 
 dkim=permerror (0-bit key) header.d=suse.de header.i=@suse.de
 header.b="oRH6TwzD"
Received: from relay2.suse.de (relay2.suse.de [149.44.160.134])
 by smtp-out2.suse.de (Postfix) with ESMTP id 1C4D61F380;
 Mon, 31 Jan 2022 14:57:05 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=suse.de; s=susede2_rsa;
 t=1643641025; h=from:from:reply-to:date:date:message-id:message-id:to:to:cc:cc:
 mime-version:mime-version:content-type:content-type:
 in-reply-to:in-reply-to:references:references;
 bh=oGbrB4jkSsv8ztmFHI1kkrhQ9Pcbl+Xj8CjWST+LroU=;
 b=w3IaXZzw3qmQ6aAR88iBgj2WH4L/+KEMADWdgR3bpKxJYAFPRVM9yt9py1+D86rOu9yTwU
 HYpxsU06OMbC7SRvQBB362VTOIntkwKsXHHnkdVrbA8J1yjDj9mTcooW587Ampb8pyxW8g
 B+5wNNxtHEmGnwSzCoPDEoV8fWCuan8=
DKIM-Signature: v=1; a=ed25519-sha256; c=relaxed/relaxed; d=suse.de;
 s=susede2_ed25519; t=1643641025;
 h=from:from:reply-to:date:date:message-id:message-id:to:to:cc:cc:
 mime-version:mime-version:content-type:content-type:
 in-reply-to:in-reply-to:references:references;
 bh=oGbrB4jkSsv8ztmFHI1kkrhQ9Pcbl+Xj8CjWST+LroU=;
 b=oRH6TwzDWmKnwD2uRG2sWCAH1Pilwr+RYro8ldfbAmW0tgMV//zyxFISND88ptcTOlFQrq
 FQqs6UmPWeUVkGAQ==
Received: from alsa1.suse.de (alsa1.suse.de [10.160.4.42])
 by relay2.suse.de (Postfix) with ESMTP id CB527A3B8C;
 Mon, 31 Jan 2022 14:57:04 +0000 (UTC)
Date: Mon, 31 Jan 2022 15:57:04 +0100
Message-ID: <s5htudk9cn3.wl-tiwai@suse.de>
From: Takashi Iwai <tiwai@suse.de>
To: Alexander Sergeyev <sergeev917@gmail.com>
Subject: Re: [PATCH 1/4] ALSA: hda/realtek: fix mute/micmute LEDs for HP 855 G8
In-Reply-To: <20220130111020.44gzrm5ckrakjta2@localhost.localdomain>
References: <s5ha6fy46jt.wl-tiwai@suse.de>
 <20220114183720.n46wealclg6spxkp@localhost.localdomain>
 <s5hsftp3027.wl-tiwai@suse.de>
 <20220115152215.kprws5nja2i43qax@localhost.localdomain>
 <s5hilugw0l0.wl-tiwai@suse.de>
 <20220119093249.eaxem33bjqjxcher@localhost.localdomain>
 <20220122190522.ycaygrqcen7d3hj2@localhost.localdomain>
 <20220122205637.7gzurdu7xl4sthxw@localhost.localdomain>
 <s5ho83yldu3.wl-tiwai@suse.de>
 <20220129144704.xlmeylllvy3b3fum@localhost.localdomain>
 <20220130111020.44gzrm5ckrakjta2@localhost.localdomain>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI/1.14.6 (Maruoka)
 FLIM/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL/10.8 Emacs/25.3
 (x86_64-suse-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Content-Type: text/plain; charset=US-ASCII
Cc: "moderated list:SOUND" <alsa-devel@alsa-project.org>,
 Kailang Yang <kailang@realtek.com>, Jeremy Szu <jeremy.szu@canonical.com>,
 Huacai Chen <chenhuacai@kernel.org>, open list <linux-kernel@vger.kernel.org>,
 tiwai@suse.com, Hui Wang <hui.wang@canonical.com>,
 PeiSen Hou <pshou@realtek.com>, Jian-Hong Pan <jhp@endlessos.org>
X-BeenThere: alsa-devel@alsa-project.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: "Alsa-devel mailing list for ALSA developers -
 http://www.alsa-project.org" <alsa-devel.alsa-project.org>
List-Unsubscribe: <https://mailman.alsa-project.org/mailman/options/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=unsubscribe>
List-Archive: <http://mailman.alsa-project.org/pipermail/alsa-devel/>
List-Post: <mailto:alsa-devel@alsa-project.org>
List-Help: <mailto:alsa-devel-request@alsa-project.org?subject=help>
List-Subscribe: <https://mailman.alsa-project.org/mailman/listinfo/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=subscribe>
Errors-To: alsa-devel-bounces@alsa-project.org
Sender: "Alsa-devel" <alsa-devel-bounces@alsa-project.org>

On Sun, 30 Jan 2022 12:10:20 +0100,
Alexander Sergeyev wrote:
> 
> On Sat, Jan 29, 2022 at 05:47:07PM +0300, Alexander Sergeyev wrote:
> > But unbind-bind problems with IO_PAGE_FAULT and "out of range cmd" are not 
> > eliminated. IO_PAGE_FAULT are often logged without accompanying "out of range 
> > cmd". And after adding debugging printk() I haven't managed to trigger "out 
> > of range cmd" yet. But IO_PAGE_FAULT are more easily triggered.
> 
> IO_PAGE_FAULTs go away with CONFIG_IOMMU_DEFAULT_PASSTHROUGH enabled. As I 
> understand, this leads to reduced DMA device isolation which is generally not 
> desirable. I was initially thinking about races between some delayed code and 
> io-memory pages unmapping, but first IO_PAGE_FAULTs (running non-passthrough 
> iommu) happen during bind operations as well.

That's logical, as IOMMU is bypassed for DMA with that option.

I still don't get what really triggers it.  This won't happen when you
build modules and load/unload the driver instead of dynamic binding?

And the out-of-range access is puzzling, too.  I guess this comes from
the update of a COEF, i.e. it reads a strange value and tries to
update the value based on it.  The problem is that it's no -1 but some
random value.  This might be tied with the IOMMU error, and it might
reading unexpected address, which would be really bad.

In anyway, we need to track down exactly which access triggers those
errors...

> What is also interesting, unbind & bind consistently fails on 31th bind:
> 
> echo -n '0000:05:00.6' > /sys/bus/pci/drivers/snd_hda_intel/bind
> -bash: echo: write error: No such device
> 
> And does not recover from there until a reboot.

This is intended behavior.  The driver has a static device index that
is incremented at each probe, so that the driver may probe multiple
instances.  It'll be tricky to reset this for dynamic binding,
though.  This problem is not only for HD-audio but for most of other
drivers.  But I leave this as is for now, since the dynamic binding is
rarely used for PCI and other buses, so far.


Takashi
