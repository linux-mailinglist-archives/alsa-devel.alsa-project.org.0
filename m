Return-Path: <alsa-devel-bounces@alsa-project.org>
X-Original-To: lists+alsa-devel@lfdr.de
Delivered-To: lists+alsa-devel@lfdr.de
Received: from alsa0.perex.cz (alsa0.perex.cz [77.48.224.243])
	by mail.lfdr.de (Postfix) with ESMTPS id DF37ADCB3
	for <lists+alsa-devel@lfdr.de>; Mon, 29 Apr 2019 09:14:54 +0200 (CEST)
Received: from alsa1.perex.cz (alsa1.perex.cz [207.180.221.201])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by alsa0.perex.cz (Postfix) with ESMTPS id 6203F88A;
	Mon, 29 Apr 2019 09:14:04 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa0.perex.cz 6203F88A
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=alsa-project.org;
	s=default; t=1556522094;
	bh=RcKtVZw6/pjmT6TiWcTB3cz0DEmnImnHb6ulEU4DHn0=;
	h=Date:From:To:In-Reply-To:References:Cc:Subject:List-Id:
	 List-Unsubscribe:List-Archive:List-Post:List-Help:List-Subscribe:
	 From;
	b=tngk8Cku5F10gbcybV4ieXfj9Rtz9h/gpnhL+tvf5U9454vE8orNGmu1rPOe+O+u1
	 A4ch8tX1INrJFWP3jIEK1GPyZm7bCyDspuBJjbS/LiD/Txq1rsJdotXkU4XHoNhsdJ
	 Ii2QBbVn0bwaDW3+5DiI9iI6dbDeeaIWPe1JFcp8=
Received: from alsa1.perex.cz (localhost.localdomain [127.0.0.1])
	by alsa1.perex.cz (Postfix) with ESMTP id 0434FF89693;
	Mon, 29 Apr 2019 09:12:44 +0200 (CEST)
X-Original-To: alsa-devel@alsa-project.org
Delivered-To: alsa-devel@alsa-project.org
Received: by alsa1.perex.cz (Postfix, from userid 50401)
 id 1E1D8F896CB; Mon, 29 Apr 2019 09:12:41 +0200 (CEST)
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on alsa1.perex.cz
X-Spam-Level: 
X-Spam-Status: No, score=-0.0 required=5.0 tests=SPF_PASS autolearn=disabled
 version=3.4.0
Received: from mx1.suse.de (mx2.suse.de [195.135.220.15])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by alsa1.perex.cz (Postfix) with ESMTPS id A7F6EF89693
 for <alsa-devel@alsa-project.org>; Mon, 29 Apr 2019 09:12:37 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa1.perex.cz A7F6EF89693
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 31001AED5;
 Mon, 29 Apr 2019 07:12:37 +0000 (UTC)
Date: Mon, 29 Apr 2019 09:12:37 +0200
Message-ID: <s5hpnp5jndm.wl-tiwai@suse.de>
From: Takashi Iwai <tiwai@suse.de>
To: Bard liao <yung-chuan.liao@linux.intel.com>
In-Reply-To: <20190427205340.8830-2-yung-chuan.liao@linux.intel.com>
References: <20190427205340.8830-1-yung-chuan.liao@linux.intel.com>
 <20190427205340.8830-2-yung-chuan.liao@linux.intel.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI/1.14.6 (Maruoka)
 FLIM/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL/10.8 Emacs/25.3
 (x86_64-suse-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Cc: liam.r.girdwood@linux.intel.com, alsa-devel@alsa-project.org,
 broonie@kernel.org, pierre-louis.bossart@linux.intel.com, bard.liao@intel.com
Subject: Re: [alsa-devel] [PATCH 2/2] ASoC: hdac_hda: overwrite hdev type to
	HDA_DEV_ASOC
X-BeenThere: alsa-devel@alsa-project.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: "Alsa-devel mailing list for ALSA developers -
 http://www.alsa-project.org" <alsa-devel.alsa-project.org>
List-Unsubscribe: <https://mailman.alsa-project.org/mailman/options/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=unsubscribe>
List-Archive: <http://mailman.alsa-project.org/pipermail/alsa-devel/>
List-Post: <mailto:alsa-devel@alsa-project.org>
List-Help: <mailto:alsa-devel-request@alsa-project.org?subject=help>
List-Subscribe: <https://mailman.alsa-project.org/mailman/listinfo/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=subscribe>
Content-Type: text/plain; charset="us-ascii"
Content-Transfer-Encoding: 7bit
Errors-To: alsa-devel-bounces@alsa-project.org
Sender: "Alsa-devel" <alsa-devel-bounces@alsa-project.org>

On Sat, 27 Apr 2019 22:53:40 +0200,
Bard liao wrote:
> 
> In ASoC driver, snd_hdac_device_register() will be called by
> snd_hdac_ext_bus_device_init() and snd_hdac_device_unregister()
> will called by snd_hdac_ext_bus_device_remove(). However when
> ASoC codec driver call snd_hda_codec_device_new() to create a
> new hda codec, it will assign snd_hda_codec_dev_free() to the
> dev_free ops and snd_hda_codec_dev_free() will call
> snd_hdac_device_unregister(). As a result, snd_hdac_device_unregister()
> will be called twice in ASoC driver. To prevent it, we use hdev
> type to determine if the hda codec is registered by legacy HDA
> driver or ASoC driver and unregister device in  snd_hda_codec_dev_free()
> only if it is a legacy HDA device.
> This patch will overwrite the hdev type so that we can know it is
> a ASoC device.
> 
> Signed-off-by: Bard liao <yung-chuan.liao@linux.intel.com>

Applied, thanks.


Takashi


> ---
>  sound/soc/codecs/hdac_hda.c | 6 ++++++
>  1 file changed, 6 insertions(+)
> 
> diff --git a/sound/soc/codecs/hdac_hda.c b/sound/soc/codecs/hdac_hda.c
> index f889d94c8e3c..7d4940256914 100644
> --- a/sound/soc/codecs/hdac_hda.c
> +++ b/sound/soc/codecs/hdac_hda.c
> @@ -328,6 +328,12 @@ static int hdac_hda_codec_probe(struct snd_soc_component *component)
>  		dev_err(&hdev->dev, "failed to create hda codec %d\n", ret);
>  		goto error_no_pm;
>  	}
> +	/*
> +	 * Overwrite type to HDA_DEV_ASOC since it is a ASoC driver
> +	 * hda_codec.c will check this flag to determine if unregister
> +	 * device is needed.
> +	 */
> +	hdev->type = HDA_DEV_ASOC;
>  
>  	/*
>  	 * snd_hda_codec_device_new decrements the usage count so call get pm
> -- 
> 2.17.1
> 
_______________________________________________
Alsa-devel mailing list
Alsa-devel@alsa-project.org
https://mailman.alsa-project.org/mailman/listinfo/alsa-devel
