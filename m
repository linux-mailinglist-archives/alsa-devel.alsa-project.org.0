Return-Path: <alsa-devel-bounces@alsa-project.org>
X-Original-To: lists+alsa-devel@lfdr.de
Delivered-To: lists+alsa-devel@lfdr.de
Received: from alsa0.perex.cz (alsa0.perex.cz [77.48.224.243])
	by mail.lfdr.de (Postfix) with ESMTPS id A3E8A2E9A5
	for <lists+alsa-devel@lfdr.de>; Thu, 30 May 2019 02:14:06 +0200 (CEST)
Received: from alsa1.perex.cz (alsa1.perex.cz [207.180.221.201])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by alsa0.perex.cz (Postfix) with ESMTPS id 19A09950;
	Thu, 30 May 2019 02:13:16 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa0.perex.cz 19A09950
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=alsa-project.org;
	s=default; t=1559175246;
	bh=4+Ye2YrSh7DYtK8t9gPTbS/lc464n0oJmwE4nIVY/B0=;
	h=Date:From:To:In-Reply-To:References:Cc:Subject:List-Id:
	 List-Unsubscribe:List-Archive:List-Post:List-Help:List-Subscribe:
	 From;
	b=BCinCYc8/cw9qvrbx9HTL3B1A8nHHRhgrNSyLA4VfuBK86WmQvDvOhA1Ga0bQ/8jx
	 k4d8qFHvvn4s/W500juonO6ka/L2FtZJ3csWIAU+QYTANSGxpnzjR32U1Gpqrsecj7
	 HtPvt/TfN/AgelmVS27jcbmiF1Xlud6GY05+qzZs=
Received: from alsa1.perex.cz (localhost.localdomain [127.0.0.1])
	by alsa1.perex.cz (Postfix) with ESMTP id BC75AF8072E;
	Thu, 30 May 2019 02:12:21 +0200 (CEST)
X-Original-To: alsa-devel@alsa-project.org
Delivered-To: alsa-devel@alsa-project.org
Received: by alsa1.perex.cz (Postfix, from userid 50401)
 id 24B91F896E0; Thu, 30 May 2019 02:12:19 +0200 (CEST)
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on alsa1.perex.cz
X-Spam-Level: 
X-Spam-Status: No, score=0.0 required=5.0 tests=SPF_HELO_NONE,SPF_PASS
 autolearn=disabled version=3.4.0
Received: from relmlie5.idc.renesas.com (relmlor1.renesas.com
 [210.160.252.171])
 by alsa1.perex.cz (Postfix) with ESMTP id 7D98FF8065A
 for <alsa-devel@alsa-project.org>; Thu, 30 May 2019 02:12:13 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa1.perex.cz 7D98FF8065A
Date: 30 May 2019 09:12:10 +0900
X-IronPort-AV: E=Sophos;i="5.60,527,1549897200"; d="scan'208";a="17313706"
Received: from unknown (HELO relmlir5.idc.renesas.com) ([10.200.68.151])
 by relmlie5.idc.renesas.com with ESMTP; 30 May 2019 09:12:10 +0900
Received: from morimoto-PC.renesas.com (unknown [10.166.18.140])
 by relmlir5.idc.renesas.com (Postfix) with ESMTP id 755814008552;
 Thu, 30 May 2019 09:12:10 +0900 (JST)
Message-ID: <87zhn4g6g3.wl-kuninori.morimoto.gx@renesas.com>
From: Kuninori Morimoto <kuninori.morimoto.gx@renesas.com>
To: Charles Keepax <ckeepax@opensource.cirrus.com>
In-Reply-To: <20190529103439.GI28362@ediswmail.ad.cirrus.com>
References: <87woi9x4ho.wl-kuninori.morimoto.gx@renesas.com>
 <20190529103439.GI28362@ediswmail.ad.cirrus.com>
User-Agent: Wanderlust/2.15.9 Emacs/24.5 Mule/6.0
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Cc: Linux-ALSA <alsa-devel@alsa-project.org>
Subject: Re: [alsa-devel] Question about dapm setup
X-BeenThere: alsa-devel@alsa-project.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: "Alsa-devel mailing list for ALSA developers -
 http://www.alsa-project.org" <alsa-devel.alsa-project.org>
List-Unsubscribe: <https://mailman.alsa-project.org/mailman/options/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=unsubscribe>
List-Archive: <http://mailman.alsa-project.org/pipermail/alsa-devel/>
List-Post: <mailto:alsa-devel@alsa-project.org>
List-Help: <mailto:alsa-devel-request@alsa-project.org?subject=help>
List-Subscribe: <https://mailman.alsa-project.org/mailman/listinfo/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=subscribe>
Content-Type: text/plain; charset="us-ascii"
Content-Transfer-Encoding: 7bit
Errors-To: alsa-devel-bounces@alsa-project.org
Sender: "Alsa-devel" <alsa-devel-bounces@alsa-project.org>


Hi Charles

> > snd_soc_instantiate_card() setups dapm, but its timing seems
> > very randomly for me.
> > In my understanding, dapm setup timing is not so serious.
> > So, I think we can do it in one place,
> > but are there some reasons ?
> > For example, "xxxx should be called after yyyy"
> > 
> 
> There are certainly reasons for some of it, but might be easier
> to explain what you are thinking of moving, rather than trying to
> list all dependencies.
(snip)
> For example we need the calls to snd_soc_dapm_new_controls to
> be before these two so that the widgets exist for linking them.
(snip)
> This needs to be before the routes are added so that the routes
> can find their associated controls.
(snip)
> And the routes also obviously need to be after the widgets are
> added as well.
(snip)
> Hope that is roughly the sort of thing you were interested in.

Thanks !! Nice to know !!
It is very clear for dapm setup timing.

But, it was my fault, the question was not clear.
I wanted to know was that there are many non dapm functions
are called between dapm setup.
pseudo code is..

	static int snd_soc_instantiate_card(struct snd_soc_card *card)
	{
		...

=>		snd_soc_dapm_debugfs_init()
=>		snd_soc_dapm_new_controls(...)

		card->probe(..)
		soc_probe_link_components(...)
		soc_probe_aux_device(...)
		soc_bind_dai_link(...)
		soc_probe_link_dais

=>		snd_soc_dapm_link_dai_widgets()
=>		snd_soc_dapm_connect_dai_link_widgets()
=>		snd_soc_add_card_controls()
=>		snd_soc_dapm_add_routes()

		snprintf(...)
		card->late_probe()

=>		snd_soc_dapm_new_widgets()
	
		snd_card_register()

=>		dapm_mark_endpoints_dirty()
=>		snd_soc_dapm_sync()
		...
	}

It looks very random. So my original question was
can we do like this (with keeping dapm order)?

	static int snd_soc_instantiate_card(struct snd_soc_card *card)
	{

=>		snd_soc_dapm_debugfs_init()
=>		snd_soc_dapm_new_controls(...)
=>		snd_soc_dapm_link_dai_widgets()
=>		snd_soc_dapm_connect_dai_link_widgets()
=>		snd_soc_add_card_controls()
=>		snd_soc_dapm_add_routes()
=>		snd_soc_dapm_new_widgets()
=>		dapm_mark_endpoints_dirty()
=>		snd_soc_dapm_sync()

		card->probe(..)
		soc_probe_link_components(...)
		soc_probe_aux_device(...)
		soc_bind_dai_link(...)
		soc_probe_link_dais
		snprintf(...)
		card->late_probe()
		snd_card_register()

=>		/* or dapm setup here instead ? */
	}

For example, snd_soc_dapm_xxx() should be called before/after
card->probe() etc, etc...


Thank you for your help !!
Best regards
---
Kuninori Morimoto
_______________________________________________
Alsa-devel mailing list
Alsa-devel@alsa-project.org
https://mailman.alsa-project.org/mailman/listinfo/alsa-devel
