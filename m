Return-Path: <alsa-devel-bounces@alsa-project.org>
X-Original-To: lists+alsa-devel@lfdr.de
Delivered-To: lists+alsa-devel@lfdr.de
Received: from alsa0.perex.cz (alsa0.perex.cz [77.48.224.243])
	by mail.lfdr.de (Postfix) with ESMTPS id 3C4533F823D
	for <lists+alsa-devel@lfdr.de>; Thu, 26 Aug 2021 08:09:50 +0200 (CEST)
Received: from alsa1.perex.cz (alsa1.perex.cz [207.180.221.201])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by alsa0.perex.cz (Postfix) with ESMTPS id C8F47167D;
	Thu, 26 Aug 2021 08:08:59 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa0.perex.cz C8F47167D
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=alsa-project.org;
	s=default; t=1629958189;
	bh=EnkgpA4rp+5W4c9Ac4sdRC0Be1fVvF12IMKPLIB/Fb0=;
	h=Date:From:To:Subject:In-Reply-To:References:Cc:List-Id:
	 List-Unsubscribe:List-Archive:List-Post:List-Help:List-Subscribe:
	 From;
	b=kd88kqNvAK5lQMWVKcuB96OhDIQ+wj1KtB82080X1b1HwOGCmiykLnG4HCkN9SLK+
	 2sC80KVMh+0bqlIARX40KNZR1Hp3b1TXsDCdJdmq5VKber/TJp7P0mXcv/djhXj7+g
	 FnGNuJd/VoiJ/mgWkZTEIbPZrUpV+kCRSPq1xgkU=
Received: from alsa1.perex.cz (localhost.localdomain [127.0.0.1])
	by alsa1.perex.cz (Postfix) with ESMTP id 24045F801D5;
	Thu, 26 Aug 2021 08:08:32 +0200 (CEST)
X-Original-To: alsa-devel@alsa-project.org
Delivered-To: alsa-devel@alsa-project.org
Received: by alsa1.perex.cz (Postfix, from userid 50401)
 id 39130F80224; Thu, 26 Aug 2021 08:08:30 +0200 (CEST)
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on alsa1.perex.cz
X-Spam-Level: 
X-Spam-Status: No, score=-0.1 required=5.0 tests=DKIM_SIGNED,DKIM_VALID,
 DKIM_VALID_AU,SPF_HELO_NONE,SPF_NONE autolearn=disabled version=3.4.0
Received: from smtp-out2.suse.de (smtp-out2.suse.de [195.135.220.29])
 (using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
 (No client certificate requested)
 by alsa1.perex.cz (Postfix) with ESMTPS id C942AF800FD
 for <alsa-devel@alsa-project.org>; Thu, 26 Aug 2021 08:08:21 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa1.perex.cz C942AF800FD
Authentication-Results: alsa1.perex.cz;
 dkim=pass (1024-bit key) header.d=suse.de header.i=@suse.de
 header.b="YwCcb8w0"; 
 dkim=permerror (0-bit key) header.d=suse.de header.i=@suse.de
 header.b="G5hTYS9f"
Received: from relay2.suse.de (relay2.suse.de [149.44.160.134])
 by smtp-out2.suse.de (Postfix) with ESMTP id 4E74420167;
 Thu, 26 Aug 2021 06:08:21 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=suse.de; s=susede2_rsa;
 t=1629958101; h=from:from:reply-to:date:date:message-id:message-id:to:to:cc:cc:
 mime-version:mime-version:content-type:content-type:
 in-reply-to:in-reply-to:references:references;
 bh=CzEYt05rk/qVLIT59VeDbT371fqbaUY2F6MlkZ/3ANE=;
 b=YwCcb8w072xMQFoTqny5CzLk8Fo2BfnIw1YVasbDDWEGD0Ey6huRgKv+wLfvZyECV9tR84
 5CH4WF8WZ1dgvWA6eIWOn9ez3vR0MwoeP8KP3375PCI1Nq001lw7XIwxiK5YvELZlAem2U
 xKkiCfVVeyxeHiDjtsgYphxLn4Qbyo4=
DKIM-Signature: v=1; a=ed25519-sha256; c=relaxed/relaxed; d=suse.de;
 s=susede2_ed25519; t=1629958101;
 h=from:from:reply-to:date:date:message-id:message-id:to:to:cc:cc:
 mime-version:mime-version:content-type:content-type:
 in-reply-to:in-reply-to:references:references;
 bh=CzEYt05rk/qVLIT59VeDbT371fqbaUY2F6MlkZ/3ANE=;
 b=G5hTYS9fLSDyViPxRX162OVuOFCsOFRzia/+mvejuK0aF1VFw23VAMRiVtEhwMk3SCzR1c
 6S/qFjUFFUWBT/CA==
Received: from alsa1.suse.de (alsa1.suse.de [10.160.4.42])
 by relay2.suse.de (Postfix) with ESMTP id 36457A3B8B;
 Thu, 26 Aug 2021 06:08:21 +0000 (UTC)
Date: Thu, 26 Aug 2021 08:08:21 +0200
Message-ID: <s5hbl5kybze.wl-tiwai@suse.de>
From: Takashi Iwai <tiwai@suse.de>
To: Jens Axboe <axboe@kernel.dk>
Subject: Re: azx_get_pos_skl() induced system slowness
In-Reply-To: <e82c04e5-45c7-cb88-a130-33c2043d3f4a@kernel.dk>
References: <402d5952-3bf6-5c0d-5276-8367bfe1542a@kernel.dk>
 <s5h7dga1267.wl-tiwai@suse.de>
 <e82c04e5-45c7-cb88-a130-33c2043d3f4a@kernel.dk>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI/1.14.6 (Maruoka)
 FLIM/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL/10.8 Emacs/25.3
 (x86_64-suse-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Content-Type: text/plain; charset=US-ASCII
Cc: alsa-devel@alsa-project.org, tiwai@suse.com, kai.vehmanen@linux.intel.com
X-BeenThere: alsa-devel@alsa-project.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: "Alsa-devel mailing list for ALSA developers -
 http://www.alsa-project.org" <alsa-devel.alsa-project.org>
List-Unsubscribe: <https://mailman.alsa-project.org/mailman/options/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=unsubscribe>
List-Archive: <http://mailman.alsa-project.org/pipermail/alsa-devel/>
List-Post: <mailto:alsa-devel@alsa-project.org>
List-Help: <mailto:alsa-devel-request@alsa-project.org?subject=help>
List-Subscribe: <https://mailman.alsa-project.org/mailman/listinfo/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=subscribe>
Errors-To: alsa-devel-bounces@alsa-project.org
Sender: "Alsa-devel" <alsa-devel-bounces@alsa-project.org>

On Wed, 25 Aug 2021 14:33:30 +0200,
Jens Axboe wrote:
> 
> On 8/25/21 12:14 AM, Takashi Iwai wrote:
> > On Tue, 24 Aug 2021 19:38:08 +0200,
> > Jens Axboe wrote:
> >>
> >> Hi,
> >>
> >> Got a new notebook recently, it's a Lenovo X1 Carbon 9th gen. Sound
> >> works fine, but sometimes I get really stuttering playback from nestopia
> >> and I finally decided to look into it. When this happens,
> >> azx_get_pos_skl() is seemingly called a lot, at least it uses a ton of
> >> CPU cycles. This comes and goes, sometimes 1 minute in between,
> >> sometimes 2, and sometimes 30 seconds.
> >>
> >> If I comment out the udelay() in that function it does seems to be
> >> noticeably better, though it's not a complete fix. I guess it just
> >> reduces the pain of calling it so many times?
> >>
> >> This is running 5.14-rc7, but it's not a recent regression.
> >>
> >> Any clues as to what this might be?
> > 
> > Are you using PulseAudio?  Or pipewire?  The former might cause lots
> > of position update calls when the device doesn't give back the stable
> > (or consistent) position report.
> 
> I'm using the default (mint) which is pulseaudio. But after reading your
> reply, I switched to pipewire - hopefully that'll work better!
> 
> > The code there was borrowed from the ASoC Intel Skylake driver
> > (sound/soc/intel/skylake/skl-pcm.c), and the same is also carried to
> > the recent ASoC SOF HDA driver, too.
> > As far as I understand from the comment, the udelay() itself could be
> > reduced only for the case right after the interrupt wakeup.  That is,
> > a hackish patch like below might help.
> > 
> > But, as far as I see with PulseAudio, it still results in a lot of
> > register read -- so PA seems repeatedly reading the position.
> > 
> > A better result (only from the CPU usage POV) could be gained on my
> > machine by just switching to another position inquiry; namely, pass
> > position_fix=1 option to snd-hda-intel module.  But I checked this
> > only for a short period, so am not sure about the long run.
> 
> Let me know if you want to test the patch or using that option, for now
> I just went with pipewire and will see if that works any better.

Well, I'm interested in whether pipewire really works better in this
regard, so please let me know your experience with PW, too ;)

I'm going to check this issue on my machine, and will ask you if any
test patch is ready.


thanks,

Takashi
