Return-Path: <alsa-devel-bounces@alsa-project.org>
X-Original-To: lists+alsa-devel@lfdr.de
Delivered-To: lists+alsa-devel@lfdr.de
Received: from alsa0.perex.cz (alsa0.perex.cz [77.48.224.243])
	by mail.lfdr.de (Postfix) with ESMTPS id 5596D24A5F
	for <lists+alsa-devel@lfdr.de>; Tue, 21 May 2019 10:29:31 +0200 (CEST)
Received: from alsa1.perex.cz (alsa1.perex.cz [207.180.221.201])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by alsa0.perex.cz (Postfix) with ESMTPS id CBD0F166B;
	Tue, 21 May 2019 10:28:40 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa0.perex.cz CBD0F166B
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=alsa-project.org;
	s=default; t=1558427370;
	bh=+N4QmieGbBRr3UIpl0RI+8snm9ahR+3c9N/c9iOYPIE=;
	h=Date:From:To:In-Reply-To:References:Cc:Subject:List-Id:
	 List-Unsubscribe:List-Archive:List-Post:List-Help:List-Subscribe:
	 From;
	b=b5G8CPABwBS6isNcJXr1IyX/NFcaWTntw/wnVQ96weJTtf51B27wjTP2W7OUZNUTQ
	 F/s9mgljgB7veFOcc9Z6vFRp3PLsX3P4olngtX0b2rc9LZNQAe3aH9je7dEoDEThe+
	 1fuh1R2e0+TdAzShgc4zx8JP895R4vLsWbeHr9h4=
Received: from alsa1.perex.cz (localhost.localdomain [127.0.0.1])
	by alsa1.perex.cz (Postfix) with ESMTP id 464ACF8079B;
	Tue, 21 May 2019 10:27:46 +0200 (CEST)
X-Original-To: alsa-devel@alsa-project.org
Delivered-To: alsa-devel@alsa-project.org
Received: by alsa1.perex.cz (Postfix, from userid 50401)
 id B641FF89674; Tue, 21 May 2019 10:27:43 +0200 (CEST)
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on alsa1.perex.cz
X-Spam-Level: *
X-Spam-Status: No, score=1.0 required=5.0 tests=PRX_BODYSUB_14, SPF_HELO_NONE, 
 SPF_PASS,URIBL_BLOCKED autolearn=disabled version=3.4.0
Received: from mx1.suse.de (mx2.suse.de [195.135.220.15])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by alsa1.perex.cz (Postfix) with ESMTPS id C85DEF8079B
 for <alsa-devel@alsa-project.org>; Tue, 21 May 2019 10:27:40 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa1.perex.cz C85DEF8079B
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id A9590AF48;
 Tue, 21 May 2019 08:27:39 +0000 (UTC)
Date: Tue, 21 May 2019 10:27:39 +0200
Message-ID: <s5hv9y45i10.wl-tiwai@suse.de>
From: Takashi Iwai <tiwai@suse.de>
To: "Miartus, Adam (Arion Recruitment; ADITG/ESM)" <amiartus@de.adit-jv.com>
In-Reply-To: <B174E9FCEE9A8C46B11E4DF2E329936277F1EC@HI2EXCH01.adit-jv.com>
References: <1558370831-15960-1-git-send-email-adam.miartus@gmail.com>
 <B174E9FCEE9A8C46B11E4DF2E329936277F1EC@HI2EXCH01.adit-jv.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI/1.14.6 (Maruoka)
 FLIM/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL/10.8 Emacs/25.3
 (x86_64-suse-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Cc: "alsa-devel@alsa-project.org" <alsa-devel@alsa-project.org>
Subject: Re: [alsa-devel] [ALSA patch] FW: [PATCH - alsa-lib 1/4] pcm_file:
	add support for infile reading in non interleaved mode
X-BeenThere: alsa-devel@alsa-project.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: "Alsa-devel mailing list for ALSA developers -
 http://www.alsa-project.org" <alsa-devel.alsa-project.org>
List-Unsubscribe: <https://mailman.alsa-project.org/mailman/options/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=unsubscribe>
List-Archive: <http://mailman.alsa-project.org/pipermail/alsa-devel/>
List-Post: <mailto:alsa-devel@alsa-project.org>
List-Help: <mailto:alsa-devel-request@alsa-project.org?subject=help>
List-Subscribe: <https://mailman.alsa-project.org/mailman/listinfo/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=subscribe>
Content-Type: text/plain; charset="us-ascii"
Content-Transfer-Encoding: 7bit
Errors-To: alsa-devel-bounces@alsa-project.org
Sender: "Alsa-devel" <alsa-devel-bounces@alsa-project.org>

On Mon, 20 May 2019 18:49:34 +0200,
Miartus, Adam (Arion Recruitment; ADITG/ESM) wrote:
> 
> From: Adam Miartus <amiartus@de.adit-jv.com>
> 
> add helper function to copy input file data to buffer mapped by areas, in case of an error, do not fill the areas, allowing device read buffer to be provided to api caller
> 
> previously unused rbuf variable is reused for this purpose
> 
> Signed-off-by: Adam Miartus <amiartus@de.adit-jv.com>
> Reviewed-by: Timo Wischer <twischer@de.adit-jv.com>
> 
> diff --git a/src/pcm/pcm_file.c b/src/pcm/pcm_file.c index 3a19cef..7998b64 100644
> --- a/src/pcm/pcm_file.c
> +++ b/src/pcm/pcm_file.c
> @@ -77,6 +77,7 @@ typedef struct {
>  	snd_pcm_uframes_t appl_ptr;
>  	snd_pcm_uframes_t file_ptr_bytes;
>  	snd_pcm_uframes_t wbuf_size;
> +	snd_pcm_uframes_t rbuf_size;
>  	size_t wbuf_size_bytes;
>  	size_t wbuf_used_bytes;
>  	char *wbuf;
> @@ -266,6 +267,37 @@ static int snd_pcm_file_open_output_file(snd_pcm_file_t *file)
>  	return 0;
>  }
>  
> +/* fill areas with data from input file, return bytes red */ static int 
> +snd_pcm_file_areas_read_infile(snd_pcm_t *pcm, const snd_pcm_channel_area_t *areas,
> +	snd_pcm_uframes_t offset, snd_pcm_uframes_t frames) {

Please follow the standard coding style.

> +	snd_pcm_file_t *file = pcm->private_data;
> +	snd_pcm_channel_area_t areas_if[pcm->channels];
> +	ssize_t bytes;
> +
> +	if (file->ifd < 0)
> +		return -EBADF;
> +
> +	if (file->rbuf == NULL)
> +		return -ENOMEM;
> +
> +	if (file->rbuf_size < frames) {
> +		SYSERR("requested more frames than pcm buffer");
> +		return -ENOMEM;
> +	}
> +
> +	bytes = read(file->ifd, file->rbuf, snd_pcm_frames_to_bytes(pcm, frames));
> +	if (bytes < 0) {
> +		SYSERR("read from file failed, error: %d", bytes);
> +		return bytes;
> +	}
> +
> +	snd_pcm_areas_from_buf(pcm, areas_if, file->rbuf);
> +	snd_pcm_areas_copy(areas, offset, areas_if, 0, pcm->channels, 
> +snd_pcm_bytes_to_frames(pcm, bytes), pcm->format);

Wrong indentation.


thanks,

Takashi
_______________________________________________
Alsa-devel mailing list
Alsa-devel@alsa-project.org
https://mailman.alsa-project.org/mailman/listinfo/alsa-devel
