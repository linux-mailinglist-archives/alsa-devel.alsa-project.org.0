Return-Path: <alsa-devel-bounces@alsa-project.org>
X-Original-To: lists+alsa-devel@lfdr.de
Delivered-To: lists+alsa-devel@lfdr.de
Received: from alsa0.perex.cz (alsa0.perex.cz [77.48.224.243])
	by mail.lfdr.de (Postfix) with ESMTPS id 4862C633765
	for <lists+alsa-devel@lfdr.de>; Tue, 22 Nov 2022 09:47:25 +0100 (CET)
Received: from alsa1.perex.cz (alsa1.perex.cz [207.180.221.201])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by alsa0.perex.cz (Postfix) with ESMTPS id D00471F0;
	Tue, 22 Nov 2022 09:46:34 +0100 (CET)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa0.perex.cz D00471F0
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=alsa-project.org;
	s=default; t=1669106844;
	bh=4m5iGelGiyO17ITA9wzWjgZpqArhb3vr2tARRLjkmKw=;
	h=Date:From:To:Subject:In-Reply-To:References:Cc:List-Id:
	 List-Unsubscribe:List-Archive:List-Post:List-Help:List-Subscribe:
	 From;
	b=QZqQl0ebijcpYAuL+oOiPDMo9INeYVmFm74nyJ5rOt0phJORoeAqnaTEqq8NBMFSB
	 z62dhLl3Fc9Sdf5ii0KyN+ouU9P0qrERAglorbecjzr5k1DxaPlwObz6nmMDj0Izkr
	 0cPj5t3Ll4i1nC8MWo5F+JUg54weiQGliwVtLvkc=
Received: from alsa1.perex.cz (localhost.localdomain [127.0.0.1])
	by alsa1.perex.cz (Postfix) with ESMTP id 633ACF80310;
	Tue, 22 Nov 2022 09:46:29 +0100 (CET)
X-Original-To: alsa-devel@alsa-project.org
Delivered-To: alsa-devel@alsa-project.org
Received: by alsa1.perex.cz (Postfix, from userid 50401)
 id 06A3DF80272; Tue, 22 Nov 2022 09:46:28 +0100 (CET)
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on alsa1.perex.cz
X-Spam-Level: 
X-Spam-Status: No, score=0.9 required=5.0 tests=DKIM_SIGNED,DKIM_VALID,
 DKIM_VALID_AU,PRX_BODY_26,SPF_HELO_NONE,SPF_NONE,T_SCC_BODY_TEXT_LINE,
 URIBL_BLOCKED autolearn=disabled version=3.4.0
Received: from smtp-out2.suse.de (smtp-out2.suse.de [195.135.220.29])
 (using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
 (No client certificate requested)
 by alsa1.perex.cz (Postfix) with ESMTPS id BA3FFF80115
 for <alsa-devel@alsa-project.org>; Tue, 22 Nov 2022 09:46:21 +0100 (CET)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa1.perex.cz BA3FFF80115
Authentication-Results: alsa1.perex.cz;
 dkim=pass (1024-bit key) header.d=suse.de header.i=@suse.de
 header.b="XeVfiBP9"; 
 dkim=permerror (0-bit key) header.d=suse.de header.i=@suse.de
 header.b="hB/jCjDJ"
Received: from imap2.suse-dmz.suse.de (imap2.suse-dmz.suse.de [192.168.254.74])
 (using TLSv1.3 with cipher TLS_AES_256_GCM_SHA384 (256/256 bits)
 key-exchange X25519 server-signature ECDSA (P-521) server-digest SHA512)
 (No client certificate requested)
 by smtp-out2.suse.de (Postfix) with ESMTPS id BF2331F86C;
 Tue, 22 Nov 2022 08:46:20 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=suse.de; s=susede2_rsa;
 t=1669106780; h=from:from:reply-to:date:date:message-id:message-id:to:to:cc:cc:
 mime-version:mime-version:content-type:content-type:
 in-reply-to:in-reply-to:references:references;
 bh=dXel8N1xdWLbkJWBa3cPHmwpPDZdmAoVd+uJGgsXh4A=;
 b=XeVfiBP9oK2YcOJON2fbP20TLQCkdS1CpOlcmLSDbN+w8OK3PvZSauF9KZTVYqxemH2xI+
 n/Tl0WUAN1Sq1ifXz6rQjj2uWlhEEjiJo2H9v+QnEfUVafoV5EgosHU5GbC1LeJPjSyfEX
 aOomPsUzHypUqpuj0hpb2ucRAdFXF6k=
DKIM-Signature: v=1; a=ed25519-sha256; c=relaxed/relaxed; d=suse.de;
 s=susede2_ed25519; t=1669106780;
 h=from:from:reply-to:date:date:message-id:message-id:to:to:cc:cc:
 mime-version:mime-version:content-type:content-type:
 in-reply-to:in-reply-to:references:references;
 bh=dXel8N1xdWLbkJWBa3cPHmwpPDZdmAoVd+uJGgsXh4A=;
 b=hB/jCjDJEXLoJ1JadX6vM2lN/Kb+ltO0/n2a70XTNU1meIXRXp/n/LU7X6S5jAdebFtwUp
 IXr9wLlR/JN7yODw==
Received: from imap2.suse-dmz.suse.de (imap2.suse-dmz.suse.de [192.168.254.74])
 (using TLSv1.3 with cipher TLS_AES_256_GCM_SHA384 (256/256 bits)
 key-exchange X25519 server-signature ECDSA (P-521) server-digest SHA512)
 (No client certificate requested)
 by imap2.suse-dmz.suse.de (Postfix) with ESMTPS id 9929113B01;
 Tue, 22 Nov 2022 08:46:20 +0000 (UTC)
Received: from dovecot-director2.suse.de ([192.168.254.65])
 by imap2.suse-dmz.suse.de with ESMTPSA id iefMJFyMfGNHJAAAMHmgww
 (envelope-from <tiwai@suse.de>); Tue, 22 Nov 2022 08:46:20 +0000
Date: Tue, 22 Nov 2022 09:46:20 +0100
Message-ID: <87tu2rv0kj.wl-tiwai@suse.de>
From: Takashi Iwai <tiwai@suse.de>
To: Michael Wu <michael@allwinnertech.com>
Subject: Re: [PATCH] ALSA: usb-audio: fix urb timeout with URB_ISO_ASAP flag
In-Reply-To: <20221122082040.48591-1-michael@allwinnertech.com>
References: <20221122082040.48591-1-michael@allwinnertech.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) Emacs/27.2 Mule/6.0
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
Cc: alsa-devel@alsa-project.org, wanjiabing@vivo.com, aichao@kylinos.cn,
 ubizjak@gmail.com, tiwai@suse.com, linux-kernel@vger.kernel.org
X-BeenThere: alsa-devel@alsa-project.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: "Alsa-devel mailing list for ALSA developers -
 http://www.alsa-project.org" <alsa-devel.alsa-project.org>
List-Unsubscribe: <https://mailman.alsa-project.org/mailman/options/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=unsubscribe>
List-Archive: <http://mailman.alsa-project.org/pipermail/alsa-devel/>
List-Post: <mailto:alsa-devel@alsa-project.org>
List-Help: <mailto:alsa-devel-request@alsa-project.org?subject=help>
List-Subscribe: <https://mailman.alsa-project.org/mailman/listinfo/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=subscribe>
Errors-To: alsa-devel-bounces@alsa-project.org
Sender: "Alsa-devel" <alsa-devel-bounces@alsa-project.org>

On Tue, 22 Nov 2022 09:20:40 +0100,
Michael Wu wrote:
> 
> When the loglevel is greater than 4, with a long messages printed on the
> console while playing or recording audios, the usb controller may become
> abnormal.
> `usb 1-2: timeout: still 1 active urbs on EP #1`
> 
> Fix it by configuring the transfer_flags URB_ISO_ASAP flag.
> 
> Signed-off-by: Michael Wu <michael@allwinnertech.com>

Hrm, that's somewhat backward action to the change we've done years
ago, commit c75c5ab575af7db707689cdbb5a5c458e9a034bb:

    ALSA: USB: adjust for changed 3.8 USB API
    
    The recent changes in the USB API ("implement new semantics for
    URB_ISO_ASAP") made the former meaning of the URB_ISO_ASAP flag the
    default, and changed this flag to mean that URBs can be delayed.
    This is not the behaviour wanted by any of the audio drivers because
    it leads to discontinuous playback with very small period sizes.
    Therefore, our URBs need to be submitted without this flag.

I rather suspect that your problem is in the USB controller side.


thanks,

Takashi

> ---
>  sound/usb/endpoint.c | 4 ++--
>  1 file changed, 2 insertions(+), 2 deletions(-)
> 
> diff --git a/sound/usb/endpoint.c b/sound/usb/endpoint.c
> index 310cd6fb0038..df9a91c2fc7d 100644
> --- a/sound/usb/endpoint.c
> +++ b/sound/usb/endpoint.c
> @@ -1245,7 +1245,7 @@ static int data_ep_set_params(struct snd_usb_endpoint *ep)
>  		if (!u->urb->transfer_buffer)
>  			goto out_of_memory;
>  		u->urb->pipe = ep->pipe;
> -		u->urb->transfer_flags = URB_NO_TRANSFER_DMA_MAP;
> +		u->urb->transfer_flags = URB_ISO_ASAP | URB_NO_TRANSFER_DMA_MAP;
>  		u->urb->interval = 1 << ep->datainterval;
>  		u->urb->context = u;
>  		u->urb->complete = snd_complete_urb;
> @@ -1288,7 +1288,7 @@ static int sync_ep_set_params(struct snd_usb_endpoint *ep)
>  		u->urb->transfer_dma = ep->sync_dma + i * 4;
>  		u->urb->transfer_buffer_length = 4;
>  		u->urb->pipe = ep->pipe;
> -		u->urb->transfer_flags = URB_NO_TRANSFER_DMA_MAP;
> +		u->urb->transfer_flags = URB_ISO_ASAP | URB_NO_TRANSFER_DMA_MAP;
>  		u->urb->number_of_packets = 1;
>  		u->urb->interval = 1 << ep->syncinterval;
>  		u->urb->context = u;
> -- 
> 2.29.0
> 
