Return-Path: <alsa-devel-bounces@alsa-project.org>
X-Original-To: lists+alsa-devel@lfdr.de
Delivered-To: lists+alsa-devel@lfdr.de
Received: from alsa0.perex.cz (alsa0.perex.cz [77.48.224.243])
	by mail.lfdr.de (Postfix) with ESMTPS id B972BE590A
	for <lists+alsa-devel@lfdr.de>; Sat, 26 Oct 2019 09:39:18 +0200 (CEST)
Received: from alsa1.perex.cz (alsa1.perex.cz [207.180.221.201])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by alsa0.perex.cz (Postfix) with ESMTPS id 1050C1913;
	Sat, 26 Oct 2019 09:38:28 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa0.perex.cz 1050C1913
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=alsa-project.org;
	s=default; t=1572075558;
	bh=ohibN1H42o2Lh568NE8+e8rl7L/bA8oO45yvI7fYRy0=;
	h=Date:From:To:In-Reply-To:References:Cc:Subject:List-Id:
	 List-Unsubscribe:List-Archive:List-Post:List-Help:List-Subscribe:
	 From;
	b=ZMaCLQn9bfo2ioucHiXEiw1XEhCTt5PvRuXbYl/klZjGvSO94JOnjSo6TQwqXsWxd
	 zMLx/+mUVMtM48YLJx1Zq4C0haFgnQkgbnGCtJh/9bDYqJQ0LDqY+p1HmRVPdbrdrs
	 qW5fF1ucc/Mp88kSRf5siHUleNI2WKc5dUU6RSZQ=
Received: from alsa1.perex.cz (localhost.localdomain [127.0.0.1])
	by alsa1.perex.cz (Postfix) with ESMTP id 4AB48F80377;
	Sat, 26 Oct 2019 09:37:33 +0200 (CEST)
X-Original-To: alsa-devel@alsa-project.org
Delivered-To: alsa-devel@alsa-project.org
Received: by alsa1.perex.cz (Postfix, from userid 50401)
 id 464A6F8036B; Sat, 26 Oct 2019 09:37:31 +0200 (CEST)
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on alsa1.perex.cz
X-Spam-Level: 
X-Spam-Status: No, score=0.0 required=5.0 tests=SPF_HELO_NONE,SPF_PASS
 autolearn=disabled version=3.4.0
Received: from mx1.suse.de (mx2.suse.de [195.135.220.15])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by alsa1.perex.cz (Postfix) with ESMTPS id 9BA00F800BF
 for <alsa-devel@alsa-project.org>; Sat, 26 Oct 2019 09:37:28 +0200 (CEST)
DKIM-Filter: OpenDKIM Filter v2.11.0 alsa1.perex.cz 9BA00F800BF
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 95144ABCE;
 Sat, 26 Oct 2019 07:37:27 +0000 (UTC)
Date: Sat, 26 Oct 2019 09:37:27 +0200
Message-ID: <s5h7e4sneiw.wl-tiwai@suse.de>
From: Takashi Iwai <tiwai@suse.de>
To: Jaroslav Kysela <perex@perex.cz>
In-Reply-To: <ed87baf1-1f2e-22d6-2bd7-267b209310d4@perex.cz>
References: <20191025123038.19728-1-perex@perex.cz>
 <s5hk18tuhio.wl-tiwai@suse.de>
 <bce57a56-99d0-62d7-1d53-099a75349341@perex.cz>
 <s5h36fgvs0m.wl-tiwai@suse.de>
 <9403a6a7-9b7e-c2a4-5acf-50d6cbaea7c7@perex.cz>
 <s5hwocsucfp.wl-tiwai@suse.de>
 <83e4dc16-07e7-aafb-db43-01a89e31270b@perex.cz>
 <s5heez0oleh.wl-tiwai@suse.de>
 <12c5e861-dd78-99cc-b16f-5ddc2ad0e33b@perex.cz>
 <alpine.DEB.2.21.1910252050230.16459@zeliteleevi>
 <ed87baf1-1f2e-22d6-2bd7-267b209310d4@perex.cz>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI/1.14.6 (Maruoka)
 FLIM/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL/10.8 Emacs/25.3
 (x86_64-suse-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Cc: ALSA development <alsa-devel@alsa-project.org>,
 Mark Brown <broonie@kernel.org>,
 Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>,
 Kai Vehmanen <kai.vehmanen@linux.intel.com>
Subject: Re: [alsa-devel] [PATCH] ASoC: change 'HDMI/DP, pcm=' to 'HDMI/DP,
	pcm=' Jack control names
X-BeenThere: alsa-devel@alsa-project.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: "Alsa-devel mailing list for ALSA developers -
 http://www.alsa-project.org" <alsa-devel.alsa-project.org>
List-Unsubscribe: <https://mailman.alsa-project.org/mailman/options/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=unsubscribe>
List-Archive: <http://mailman.alsa-project.org/pipermail/alsa-devel/>
List-Post: <mailto:alsa-devel@alsa-project.org>
List-Help: <mailto:alsa-devel-request@alsa-project.org?subject=help>
List-Subscribe: <https://mailman.alsa-project.org/mailman/listinfo/alsa-devel>, 
 <mailto:alsa-devel-request@alsa-project.org?subject=subscribe>
Content-Type: text/plain; charset="us-ascii"
Content-Transfer-Encoding: 7bit
Errors-To: alsa-devel-bounces@alsa-project.org
Sender: "Alsa-devel" <alsa-devel-bounces@alsa-project.org>

On Fri, 25 Oct 2019 23:03:26 +0200,
Jaroslav Kysela wrote:
> 
> Dne 25. 10. 19 v 20:02 Kai Vehmanen napsal(a):
> > Hi Jaroslav and all,
> >
> > On Fri, 25 Oct 2019, Jaroslav Kysela wrote:
> >
> >> the single user. Another problem is that we are not able to review all those
> >> mistakes at the merge time. It is not a complain but a true fact.
> >
> > but the strings are in kernel patches, so even if all UCM files don't
> > go through the list, we can always review when the strings are added
> > in kernel, right?
> 
> My point is that we already did this incomplete review (the wrong
> strings are in the current kernel). We cannot prevent to avoid those
> code merges, we are just human. I just don't think that the driver /
> control names should be part of the don't-break-the-userspace policy.

It's a similar situation like the long-time discussion of tracing:
when the kernel broke latencytop by changing the tracing format, we
had to revert it in the end although the tracing format itself isn't
strictly a "standard kernel ABI".  The consensus is: if upgrading the
kernel breaks anything *significant*, it's a regression and no-go.
It's not about whether it's a part of ABI or not.

In our particular case, the strings you wanted to fix are the ones
that are actually hard-coded by the UCM profiles that are known to be
really used on major systems.  That's the only reason of NAK.  If it
were for some other minor kcontrol elements, it would have been OK.

Kai's work to integrate SOF to the legacy HDMI driver would be also OK
because it provides the compatibility mode.  That is, we have some
excuse that it's not us but users (distros) who actually breaks by
choosing the kernel configuration explicitly (and even there can be a
workaround with a module option).

Or, in general, if a fix is mandatory due to any critical problem
(leading to a system crash or such) and there is no other way, we'll
have to adapt it.  But our case is, again, not that category.  It was
merely a cleanup work.

> >> I would be really curious what will happen when we change those strings ;-)
> >
> > I can share some experiences that happen on Linux distros with Pulseaudio:
> >
> > - if mixer control name is changed/missing that us used in
> >    a UCM enable sequence, the enable sequence will fail and PA will
> >    not choose that device
> > 	-> e.g. when wrong HDMI control names are in the UCM file, HDMI
> > 	output stops working
> > - if mixer control for a Jack is changed, PA will not listen
> >    for ALSA kctl events
> > 	-> HDMI connection is silently missed and HDMI is not listed
> > 	as a possible output
> >
> > .. i.e. in both cases HDMI is essentially broken if you update to
> > a kernel that updates the strings but don't update user-space in sync.
> 
> Yes, it's true. But usually, users do only upgrade. If we resolve the
> UCM configs before the kernel change, the impact is just very low.

Well, we can't define users' behavior at all.  Upgrading only the
kernel while keeping the old user-space is a very common practice on
openSUSE Leap systems, for example.  (Or imagine centos user who wants
to try a newer kernel.)

> > I wonder if one option would be to expose "legacy string" aliases,
> > allowing to make changes but keep existing user-space happy. With my HDMI
> > codec change, the controls are simply different, so this was not an
> > option and I had to opt for keeping the whole driver around.
> 
> It seems that we may need to add conditions to the UCM syntax. There
> are several ways to do it. For your specific purpose it may look like
> "if the control exist, use this config" or so.
> 
> Another approach might be to add something to the decision code which
> top UCM config file should be loaded. Actually, we rely on the card
> name / long_name only. It seems that the probe might be extended here.

Yes, currently a UCM profile is very hard-coded, hence it's quite
tightly coupled with the kernel driver implementation details.  It
makes the UCM parser code implementation easier, while it induces this
kind of incompatibility if we want to change something in the kernel
side...

Another (rather tangential) improvement would be to introduce some
validator in the kernel or in the UCM side to check whether the given
string names are OK or not.  A generic kcontrol element validator
might be worth not only for UCM but in general, because lots of ASoC
drivers tend to use any funky string names, and currently we accept
them without strict checks.


thanks,

Takashi
_______________________________________________
Alsa-devel mailing list
Alsa-devel@alsa-project.org
https://mailman.alsa-project.org/mailman/listinfo/alsa-devel
